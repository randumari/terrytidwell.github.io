<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/buzz/1.1.10/buzz.min.js" type="text/javascript"></script>
</head>
<body style="background-color: white; position: absolute; top: 50%; left: 50%; transform: translateX(-50%) translateY(-50%);">
<canvas oncontextmenu="return false;" id="canvas" width="800" height="600"></canvas>
<script>
    //##########################################################################
    // The game

    var g_canvas;
    var g_ctx;
    var g_current_screen;
    var g_level;
    var g_level_cap;

    var PHI = 1.61803398875;
    var INVERSE_PHI = 0.61803398875;

    var MOVE_COLOR = "red";
    var MOVEABLE_COLOR = "black";
    var STATIC_COLOR = "lightgrey";

    //--------------------------------------------------------------------------
    // interface, for reference, not enforced
    // The name is funny because Screen is already declared
    // and this is just for reference anyway
    const Screen_ = {
        init: function (layout) {},
        reset: function () {},
        handleMouseDown: function (event) {},
        handleMouseUp: function (event) {},
        handleKeyDown: function (event) {},
        handleKeyUp: function (event) {},
        handleTimeStep: function () {},
        paint: function () {}
    };

    //--------------------------------------------------------------------------
    const Util = {

        //----------------------------------------------------------------------
        forEach: function (obj, fn)
        {
            var key;
            for (key in obj)
            {
                if (obj.hasOwnProperty(key))
                {
                    fn(obj[key]);
                }
            }
        },

        //----------------------------------------------------------------------
        randomItem: function (arr)
        {
            return arr[Math.floor(Math.random() * arr.length)];
        },

        //----------------------------------------------------------------------
        shuffle: function (arr)
        {
            var current_index = arr.length, temp, random_index;
            while (0 != current_index)
            {
                // Pick a remaining element.
                random_index = Math.floor(Math.random() * current_index);
                current_index -= 1;

                // And swap it with the current element.
                temp = arr[current_index];
                arr[current_index] = arr[random_index];
                arr[random_index] = temp;
            }
            return arr;
        },

        //----------------------------------------------------------------------
        loadImage: function (url, resource_tracker)
        {
            var image = new Image();
            resource_tracker.add();
            image.onload = function (event) {
                resource_tracker.onload(event);
            };
            image.src = url;
            return image;
        },

        //----------------------------------------------------------------------
        loadAudio: function (url, resource_tracker)
        {
            var audio = new buzz.sound(
              url, {
              //formats: [ "wav" ],
              preload: true,
              autoplay: false,
              loop: false
            });
            resource_tracker.add();
            audio.bindOnce("canplay", function (event) {
                resource_tracker.onload(event)
            });
            return audio;
        }
    };

    var Grid = function()
    {
      this.visible = false;
      this.size = 35;
      this.inner_size = Math.round(6 * this.size/7);
      this.offset = Math.round((this.size - this.inner_size) / 2);
      this.squares = [];
      this.font_width = null;
      this.font_height = null;
      this.font_center_x = null;
      this.font_center_y = null;

      this.checkPulse = function()
      {
        return true;
      }

      this.handleMouseDown = function(event)
      {
        if (this.font_width &&
          this.font_height &&
          this.font_center_x &&
          this.font_center_y)
        {
          if(event.offsetX > this.font_center_x - this.font_width / 2 &&
            event.offsetX < this.font_center_x + this.font_width / 2 &&
            event.offsetY > this.font_center_y - this.font_height / 2 &&
            event.offsetY < this.font_center_y + this.font_height / 2)
          {
            this.visible = !this.visible;
            return true;
          }
        }
        return false;
      };

      this.paint = function(ctx)
      {
        ctx.fillStyle = MOVEABLE_COLOR;
        ctx.textBaseline="middle";
        ctx.textAlign="center";
        this.font_height = Math.round(INVERSE_PHI * (this.size - 5));
        ctx.font = this.font_height + "px Verdana";
        var text = "GRID: " + (this.visible ? "ON" : "OFF");
        this.font_width = ctx.measureText(text).width;
        this.font_center_x = Math.round(g_canvas.width / 2);
        this.font_center_y = g_canvas.height - this.size * 2;
        ctx.fillText(text, this.font_center_x, this.font_center_y)

        if (!this.visible)
        {
          return;
        }
        for(var i = this.squares.length - 1; i>=0; i--)
        {
          ctx.fillStyle = STATIC_COLOR;
          ctx.fillRect(this.squares[i][0] * this.size + this.offset,
          this.squares[i][1] * this.size + this.offset, this.size - 5, this.size - 5);

        }
      };
    }

    var LetterBoxCollection = function()
    {
      this.letterBoxList = [];
      this.alive = true;
      this.color = MOVEABLE_COLOR;

      this.handleTimeStep = function()
      {
      };

      this.checkPulse = function()
      {
        return this.alive;
      }

      this.handleMouseDown = function(event)
      {
        for(var i = this.letterBoxList.length - 1; i>=0; i--)
        {
          if(this.letterBoxList[i].handleMouseDown(event))
          {
            return true;
          }
        }
        return false;
      };

      this.paint = function(ctx)
      {
        for(var i = this.letterBoxList.length - 1; i>=0; i--)
        {
          this.letterBoxList[i].color = this.color
          this.letterBoxList[i].paint(ctx);
        }
      };

      this.transpose = function(deltaX, deltaY)
      {
        for(var i = this.letterBoxList.length - 1; i>=0; i--)
        {
          this.letterBoxList[i].transpose(deltaX, deltaY);
        }
      }

      this.snap = function(size)
      {
        for(var i = this.letterBoxList.length - 1; i>=0; i--)
        {
          this.letterBoxList[i].x = size * Math.round((this.letterBoxList[i].x)/size);
          this.letterBoxList[i].y = size * Math.round((this.letterBoxList[i].y)/size);
        }
      }
    }

    var LetterBox = function(x,y,size,letter)
    {
      this.x = x;
      this.y = y;
      this.size = size;
      this.inner_size = Math.round(6 * this.size/7);
      this.offset = Math.round((this.size - this.inner_size) / 2);
      this.letter = letter;
      this.color = MOVEABLE_COLOR; //overwritten by LetterBoxCollection
      this.alive = true;

      this.handleTimeStep = function()
      {
      };

      this.checkPulse = function()
      {
        return this.alive;
      }

      this.handleMouseDown = function(event)
      {
        //alert("this.x = " + this.x + ", this.size = " + this.size + ", event.offsetX = " + event.offsetX);
        var hit = this.x + this.size >= event.offsetX &&
          event.offsetX >= this.x &&
          this.y + this.size >= event.offsetY &&
          event.offsetY >= this.y;
        return hit;
      };

      this.paint = function(ctx)
      {
        ctx.strokeStyle = this.color;
        ctx.fillStyle = this.color;
        ctx.lineJoin ="round";
        ctx.lineWidth = Math.round(this.size / (10*PHI));
        ctx.strokeRect(this.x + this.offset, this.y + this.offset, this.inner_size, this.inner_size);
        ctx.textBaseline="middle";
        ctx.textAlign="center";
        ctx.font = Math.round(INVERSE_PHI * this.inner_size) + "px Verdana";
        ctx.fillText(this.letter,Math.round(this.x+this.size/2),Math.round(this.y+this.size/2));
      };

      this.transpose = function(deltaX, deltaY)
      {
        this.x += Math.round(deltaX);
        this.y += Math.round(deltaY);
      }
    };

    var Timer = function(timer, callback, parameter)
    {
      this.current_time = timer;
      this.callback = callback;
      this.parameter = parameter;
      this.handleTimeStep = function()
      {
        this.current_time--;
        if(this.current_time <= 0)
        {
          callback(this.parameter);
        }

      };
      this.checkPulse = function(){
            return this.current_time > 0;
      };
    }

    //##########################################################################
    var GameScreen = {

        init: function () {
          this.reset();
        },

        makePiece: function (letters, x = 0, y = 0) {
          var letter_box_collection = new LetterBoxCollection();
          var defaultX = 0;
          var defaultY = 0;
          if ( x === 0 && y === 0)
          {
            defaultX = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
            defaultY = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
          }
          for (var i = 0; i < letters.length; i++)
          {
            for (var j = 0; j < letters[i].length; j++)
            {
              if (letters[i].charAt(j) !== " " && letters[i].charAt(j) !== ".")
              {
                letter_box_collection.letterBoxList.push(
                  new LetterBox(defaultX + 35 * (j + x),defaultY + 35 * (i + y), 35, letters[i].charAt(j)));
              }
            }
          }
          letter_box_collection.snap(35);
          this.paint_list.push(letter_box_collection);
          this.draggable_list.push(letter_box_collection);
        },

        makeGrid: function (lines, offsetX, offsetY) {
          var grid = new Grid();
          for (var i = 0; i < lines.length; i++)
          {
            for (var j = 0; j < lines[i].length; j++)
            {
              if (lines[i].charAt(j) !== " " && lines[i].charAt(j) !== ".")
              {
                grid.squares.push([j + offsetX, i + offsetY]);
              }
            }
          }
          this.paint_list.push(grid);
          this.clickable_list.push(grid);
        },

        populateLevel: function (stage) {

          g_level_cap = 11;

          switch (stage) {
            case 0:
              this.makePiece(["DO"], 17, 14);
              this.makePiece(["G","O"], 20, 4);
              this.makePiece(["O ","SH","E "], 19, 7);
              this.makePiece(["EEP","Y  "], 18, 2);
              this.makePiece(["I ","GO"], 7, 13);
              this.makePiece(["AT","T "], 5, 2);
              this.makePiece(["C"], 4, 12);
              this.makePiece(["T ","U ","RO","K "], 2, 2);
              this.makePiece([" R","OS"," E"], 19, 11);
              this.makePiece([" K ","TER"," N "], 7, 3);
              this.makePiece(["H","O"],2, 13);
              this.makePiece(["DU"], 4, 14);
              this.makePiece(["CK","H "], 2, 10);
              this.makePiece(["I ","CO"], 2, 7);
              this.makePiece(["W"], 17, 12);

              this.makeGrid(
              [
              "       OOOO ",
              "         O  ",
              "       O O  ",
              "    O  O OOO",
              "OOO O  O O  ",
              "  O OOOOOOO ",
              "  O O  O O  ",
              "  OOOOO     ",
              "  O O O O   ",
              "      OOOO  ",
              "        O   "
              ], 6, 3);

              this.name = "THE FARM";

              break;
            case 1:
              this.makePiece(["BE"], 2, 12);
              this.makePiece(["AT","R "], 2, 2);
              this.makePiece([" I","RA"], 17, 5);
              this.makePiece(["  V","OPE"], 2, 9);
              this.makePiece(["NO"], 2, 7);
              this.makePiece(["CO"], 16, 2);
              this.makePiece([" R"," S","TE"], 19, 7);
              this.makePiece([" T","RE"," N"], 19, 2);
              this.makePiece(["  O","HAR"], 18, 13);
              this.makePiece(["M","E"], 5, 2);
              this.makePiece(["T","E"], 5, 5);
              this.makePiece(["RD"], 19, 11);
              this.makePiece(["IC"], 2, 5);
              this.makePiece(["M  ","P  ","ONY"], 14, 2);
              this.makePiece(["  L","CHO"], 3, 13);
              this.makePiece([" D ","LYR"], 7, 12);

              this.makeGrid(
              [
              "   OOOO     ",
              "     O      ",
              "   O O      ",
              " OOOOO      ",
              "   O   O O  ",
              "   OOOOO O  ",
              "OOOO   O O  ",
              "       O O  ",
              "     OOOOOOO",
              "        O   ",
              "        O   ",
              "      OOOOO ",
              "        O   ",
              "       OOOOO"
              ], 6, 3);

              this.name = "MUSIC";
              break;
            case 2:
              this.makePiece(["H","A"], 20, 9);
              this.makePiece(["R  ","PET"], 2, 7);
              this.makePiece([" T","TR"," O"], 19, 5);
              this.makePiece(["UM"], 2, 2);
              this.makePiece(["M  ","BAG"], 2, 4);
              this.makePiece([" V","PI"," O"], 5, 2);
              this.makePiece(["PE"], 9, 7);
              this.makePiece(["L ","I ","NO"], 2, 12);
              this.makePiece(["PIA"], 14, 14);
              this.makePiece(["NJO","  N"], 18, 2);
              this.makePiece(["BA"], 2, 10);
              this.makePiece(["ELE"], 8, 3);
              this.makePiece(["UL"], 8, 5);
              this.makePiece(["G ","UK","I "], 6, 6);
              this.makePiece([" T"," A","DR"], 19, 12);
              this.makePiece(["UMS"], 8, 13);

              this.makeGrid(
              [
              "          O   ",
              "          O   ",
              "       O  O   ",
              "      OOOOOOO ",
              "       O      ",
              "       O   O  ",
              "       OOOOOOO",
              "   OOOOO   O  ",
              " O     O   O  ",
              " OOOOOOO   O  ",
              " O      OOOOO ",
              " O            ",
              " O            ",
              "OOOOO         "
              ], 5, 2);

              this.name = "INSTRUMENTS";
              break;
            case 3:
              this.makePiece(["P","E"], 5, 2);
              this.makePiece(["A ","CH","H "], 19, 7);
              this.makePiece(["ER"," I"], 19, 2);
              this.makePiece(["AP","P "], 16, 2);
              this.makePiece(["  P","PLE"], 2, 5);
              this.makePiece(["A","R"], 8, 13);
              this.makePiece(["RY"], 19, 5);
              this.makePiece(["C ","OR","T "], 6, 9);
              this.makePiece(["AN"," A"], 5, 13);
              this.makePiece(["GE"], 16, 5);
              this.makePiece(["B","A"], 20, 11);
              this.makePiece(["GR"], 16, 9);
              this.makePiece(["GO"], 16, 7);
              this.makePiece(["N ","AP"], 2, 13);
              this.makePiece(["MAN","E  "], 2, 8);
              this.makePiece(["MON"], 2, 11);
              this.makePiece(["LE","O ","N "], 2, 2);


              this.makeGrid(
              [
              "O      O     ",
              "O  OOOOO     ",
              "O  O   O     ",
              "OOOOOO O     ",
              "O  O  O      ",
              "   O  O      ",
              "   OOOOOO    ",
              "   O  O      ",
              "      O OOOOO",
              "    OOOOO    ",
              "        OOOOO",
              "        O    ",
              "        O    "
              ], 6, 3);
              this.name = "THE GOOD KIND OF SALAD";
              break;
            case 4:
              this.makePiece(["PU","I "], 17, 2);
              this.makePiece(["N","K"], 2, 4);
              this.makePiece(["B ","RP","O "], 2, 10);
              this.makePiece(["W","N"], 20, 9);
              this.makePiece(["Y ","E ","LE"], 18, 11);
              this.makePiece(["L ","OR","W "], 17, 5);
              this.makePiece([" E"," E","AN"], 19, 2);
              this.makePiece(["G","R"], 5, 2);
              this.makePiece([" I"," T","GE"], 4, 11);
              this.makePiece(["W","H"], 20, 6);
              this.makePiece([" R","LA"," Y"], 7, 11);
              this.makePiece(["CK"], 2, 2);
              this.makePiece(["B","L"], 16, 12);
              this.makePiece([" U","RE"], 2, 7);
              this.makePiece(["D"], 18, 9);

              this.makeGrid(
              [
              "    O  O O ",
              "  O O  O O ",
              "OOOOOO O O ",
              "O O O  O O ",
              "O O OOOOOO ",
              "O O O   O  ",
              "      OOOOO",
              "      O O  ",
              "      O    ",
              "     OOO   "
              ], 6, 3);
              this.name = "COLORS";
              break;
            case 5:
              this.makePiece(["..W","FRA"], 4, 14);
              this.makePiece(["BON",".N."], 1, 7);
              this.makePiece(["T","S"], 18, 2);
              this.makePiece(["NKE","..R"], 1, 2);
              this.makePiece([".P.","JEK",".R."], 19, 11);
              this.makePiece(["OC",".T"], 20, 2);
              this.makePiece(["P.","ES","P."], 1, 13);
              this.makePiece(["L","E"], 21, 5);
              this.makePiece(["TOP"], 3, 12);
              this.makePiece(["NST"], 1, 5);
              this.makePiece([".H","MO"], 16, 14);
              this.makePiece(["YLL"], 1, 10);
              this.makePiece(["W"], 5, 5);
              this.makePiece(["RE"], 20, 15);
              this.makePiece(["H","O"], 21, 8);
              this.makePiece(["US","S."], 18, 5);
              this.makePiece(["EIN",".N."], 5, 2);
              this.makePiece(["D","I"], 16, 2);
              this.makePiece(["AU","N.","A."], 18, 8);

              this.makeGrid(
              [
              ".....O...O..",
              ".....O...O..",
              "....OOOOOOO.",
              "..O..O...O..",
              "OOOOOOOOOOOO",
              "..O..O....O.",
              "..O.O..O..O.",
              ".OOOOO.O..O.",
              "..O.O.OOOOOO",
              "....O.....O.",
              "...OOOOOO.O.",
              "....O......."
              ], 5, 3);
              this.name = "DOCTORS";
              break;
            case 6:
              this.makePiece(["TA"], 14, 6);
              this.makePiece(["UM",".A"], 1, 9);
              this.makePiece(["PE"], 11, 3);
              this.makePiece(["AZU"], 12, 13);
              this.makePiece(["FU"], 4, 13);
              this.makePiece(["UPE","V.."], 19, 10);
              this.makePiece([".R.","BER"], 19, 7);
              this.makePiece(["RIW",".V."], 1, 6);
              this.makePiece(["O.","CH","H."], 1, 12);
              this.makePiece(["O.","RE","Y."], 5, 2);
              this.makePiece(["SIA"], 1, 4);
              this.makePiece(["CER",".B."], 16, 2);
              this.makePiece([".O","IN",".Y"], 20, 2);
              this.makePiece(["KLE"], 1, 2);
              this.makePiece(["UL"], 14, 4);
              this.makePiece([".M.","EAN"], 17, 13);
              this.makePiece(["G","E","N"], 21, 12);
              this.makePiece(["T","A"], 18, 5);

              this.makeGrid(
              [
              "....O.........",
              "..OOOOOOO.....",
              "....O.........",
              "....O.........",
              ".OOOOO......O.",
              "..O...OOOOOOOO",
              "OOOOO..O....O.",
              "..O....O....O.",
              ".OOOOOOOOOO.O.",
              "....O..O....O.",
              "....O.......O.",
              ".OOOOO........",
              "....O........."
              ], 4, 3);
              this.name = "COLORS: THE REVENGE"
              break;
            case 7:
              this.makePiece(["P","O","P"], 2, 7);
              this.makePiece(["S.","I.","CH"], 2, 11);
              this.makePiece(["L","E"], 4, 9);
              this.makePiece(["G","E"], 9, 3);
              this.makePiece(["L","A"], 8, 6);
              this.makePiece(["T.","OC"], 13, 8);
              this.makePiece(["ST",".R",".U"], 3, 5);
              this.makePiece(["OLA",".E."], 5, 13);
              this.makePiece(["F","F"], 16, 8);
              this.makePiece([".M",".O","RU"], 15, 13);
              this.makePiece(["LOL"], 2, 15);
              this.makePiece(["S.","SO","E."], 6, 2);
              this.makePiece(["TE"], 7, 11);
              this.makePiece([".K.","DEL"], 19, 14);
              this.makePiece(["CAN","A.."], 17, 4);
              this.makePiece(["RB",".R",".O"], 20, 10);
              this.makePiece(["LIP",".E."], 2, 2);
              this.makePiece(["W","N"], 13, 3);
              this.makePiece(["ET"], 9, 13);
              this.makePiece(["DY"], 20, 2);
              this.makePiece(["C.","O.","OP"], 19, 6);
              this.makePiece(["K","I","E"], 21, 4);

              this.makeGrid(
              [
              ".........OOOOO",
              ".......O.O....",
              ".......O.O....",
              "O.O.OOOOOOO...",
              "O.O..O.O......",
              "O.O..O.OOOOOO.",
              "O.O..O.O..O...",
              "O.O..O....O...",
              "OOOOOOOOO.O.O.",
              "O....O....O.O.",
              "O.....OOOOOOOO",
              "..........O.O.",
              "............O.",
              "............O."
              ], 5, 2);
              this.name = "SWEET TOOTH"
              break;
            case 8:
              this.makePiece(["ZO"], 5, 14);
              this.makePiece(["VAM","..Y"], 15, 3);
              this.makePiece(["WE"], 3, 2);
              this.makePiece(["MB","U.","M."], 18, 7);
              this.makePiece([".D","RE"], 5, 3);
              this.makePiece(["PI"], 9, 13);
              this.makePiece(["GH"], 19, 4);
              this.makePiece(["V.","IE","L."], 1, 3);
              this.makePiece(["WO"], 19, 2);
              this.makePiece(["RE"], 1, 11);
              this.makePiece(["OST",".K."], 1, 13);
              this.makePiece([".T","GO",".N"], 19, 10);
              this.makePiece(["E.","LF","E."], 1, 7);
              this.makePiece(["BL"], 3, 6);
              this.makePiece(["W.","IN","T."], 17, 12);
              this.makePiece(["C","H"], 15, 5);

              this.makeGrid(
              [
              "....OOOOO...",
              ".......O....",
              "....O..O....",
              ".OOOOOOOO...",
              "....O..O....",
              "OOOOOO.O..O.",
              "..O.O.OOOOOO",
              "..O....O..O.",
              "OOOOOOO...O.",
              "..O.......O."
              ], 5, 3);
              this.name = "MONSTER MASH"
              break;
            case 9:
              this.makePiece([".O.","PAN"], 3, 14);
              this.makePiece([".E","WA",".L"], 20, 6);
              this.makePiece(["T.","MI"], 1, 9);
              this.makePiece(["OME"], 1, 12);
              this.makePiece(["FF"], 5, 3);
              this.makePiece(["CAK"], 16, 6);
              this.makePiece(["LK"], 7, 11);
              this.makePiece(["LES",".G."], 16, 8);
              this.makePiece([".C","LE",".R"], 7, 13);
              this.makePiece(["GRI","S.."], 1, 2);
              this.makePiece(["ES","A.","L."], 1, 5);
              this.makePiece(["TS"], 3, 8);
              this.makePiece([".T.","YOG"], 19, 14);
              this.makePiece(["A.","S.","TS"], 16, 13);
              this.makePiece([".H","BA",".S"], 20, 10);
              this.makePiece(["URT",".O."], 17, 2);
              this.makePiece(["H","B"], 1, 14);
              this.makePiece(["W","N","S"], 21, 2);
              this.makePiece(["CON"], 16, 11);

              this.makeGrid(
              [
              "......O........",
              "..OOOOOOO..O...",
              ".O....O...OOOOO",
              "OOOOOOOO...O...",
              ".O....O....O...",
              ".OOOO.O.O..O...",
              ".O.....OOOOOO..",
              "OOOOOOO.O..O...",
              ".O...O..O..O...",
              ".....OOOOO.O...",
              ".....O.....O..."
              ], 4, 3);
              this.name = "PART OF A COMPLETE BREAKFAST"
              break;
            case 10:
              this.makePiece(["..C","HER"], 1, 4);
              this.makePiece([".A",".N","PE"], 20, 2);
              this.makePiece(["..F","SPA"], 19, 14);
              this.makePiece(["DO",".N"], 17, 6);
              this.makePiece(["ON"], 9, 12);
              this.makePiece(["NG"], 18, 13);
              this.makePiece(["L","C"], 14, 12);
              this.makePiece(["RR"], 1, 7);
              this.makePiece(["VE"], 20, 6);
              this.makePiece([".F",".L","CA"], 17, 2);
              this.makePiece([".M.","UIN"], 15, 14);
              this.makePiece(["N.","G.","OW"], 1, 13);
              this.makePiece(["RDI"], 4, 15);
              this.makePiece([".R.","PIG"], 19, 8);
              this.makePiece(["O.","ST","T."], 1, 9);
              this.makePiece(["C","H"], 17, 9);
              this.makePiece([".P.","NAL"], 3, 11);
              this.makePiece(["R","R"], 4, 8);
              this.makePiece(["ORK","T.."], 1, 2);
              this.makePiece(["EON"], 19, 11);

              this.makeGrid(
              [
              "..O...O.......",
              "OOOOO.O....O..",
              "..O..OOOOOOOO.",
              "..O...O....O..",
              ".OOOOOOO.O.O..",
              "......O..OOOOO",
              "...O..O..O.O..",
              ".OOOOOOO.O....",
              "...O....OOOOOO",
              "...O.....O....",
              "..OOOO...O....",
              "...O.........."
              ], 4, 3);
              this.name = "CROSS BIRD PUZZLE"
              break;
            default:
              this.name = "INVALID PUZZLE";
              break;
          }
        },
        
        checkAdjancent: function(tileSet1, tileSet2)
        {
          for(var j = 0; j < tileSet1.letterBoxList.length; j++)
          {
            for(var k = 0; k < tileSet2.letterBoxList.length; k++)
            {
              if (Math.abs(tileSet1.letterBoxList[j].x - tileSet2.letterBoxList[k].x) + 
                Math.abs(tileSet1.letterBoxList[j].y - tileSet2.letterBoxList[k].y) === 35)
              {
                return true;
              }
            }
          }
          return false;
        },
        
        findAdjacentTileSets: function(draggable_list_item_index)
        {
          var adjacencySet = Array(this.draggable_list.length).fill(false);
          adjacencySet[draggable_list_item_index] = true;
          var returnSet = [];
          var unexpanded = [ this.draggable_list[draggable_list_item_index] ];
          while(unexpanded.length > 0)
          {
            var tileSet = unexpanded.pop();
            returnSet.push(tileSet);
            for(var i = this.draggable_list.length - 1; i>=0; i--)
            {
              if (!adjacencySet[i])
              {
                if (this.checkAdjancent(tileSet,this.draggable_list[i]))
                {
                  adjacencySet[i] = true;
                  unexpanded.push(this.draggable_list[i]);
                }
              }
            }
          }
          return returnSet;
        },

        reset: function () {
          this.paint_list = [];
          this.timestep_list = [];
          this.draggable_list = [];
          this.clickable_list = [];
          this.dragged_item_collection = null;
          this.mouse_pos = [null, null];
          this.name = "";
          this.backTextSize = null;
          this.forwardTextSize = null;
          this.textHeight = null;

          this.populateLevel(g_level);

          /*
          for (var i = 0; i < g_canvas.width; i += 35)
          {
            var box = new LetterBox(i, 0, 35, "0123456789".charAt((i / 35) % 10));
            box.color = STATIC_COLOR;
            this.paint_list.push(box);
          }
          for (var i = 35; i < g_canvas.height; i += 35)
          {
            var box = new LetterBox(0, i, 35, "0123456789".charAt((i / 35) % 10));
            box.color = STATIC_COLOR;
            this.paint_list.push(box);
          }
          //*/
        },
        handleMouseDown: function (event) {
          for(var i = this.draggable_list.length - 1; i>=0; i--)
          {
            if(!this.draggable_list[i].checkPulse())
            {
              this.draggable_list.splice(i,1);
            }
            else
            {
              if(this.draggable_list[i].handleMouseDown(event))
              {
                if(event.button == 0)
                {
                  this.draggable_list[i].color = MOVE_COLOR;
                  this.dragged_item_collection = [ this.draggable_list[i] ];
                }
                else if(event.button == 2)
                {
                  this.draggable_list[i].color = MOVE_COLOR;
                  this.dragged_item_collection = this.findAdjacentTileSets(i);
                }
                return true;
              }
            }
          }
          for(var i = this.clickable_list.length - 1; i>=0; i--)
          {
            if(!this.clickable_list[i].checkPulse())
            {
              this.clickable_list.splice(i,1);
            }
            else
            {
              if(this.clickable_list[i].handleMouseDown(event))
              {
                return true;
              }
            }
          }

          if (this.backTextSize &&
            this.forwardTextSize &&
            this.textHeight)
          {
            if(event.offsetY > g_canvas.height - this.textHeight)
            {
              if(event.offsetX < this.backTextSize)
              {
                if(g_level === 0)
                {
                  g_level = g_level_cap;
                }
                g_level--;
                this.reset();
                return true;
              }
              if(event.offsetX > g_canvas.width - this.forwardTextSize)
              {
                g_level++;
                g_level %= g_level_cap;
                this.reset();
                return true;
              }
            }
          }
          return false;
        },
        handleMouseMove: function (event) {
          var rect = canvas.getBoundingClientRect();
          var old_x = this.mouse_pos[0];
          var old_y = this.mouse_pos[1];
          var i = 0;
          this.mouse_pos[0] = event.clientX - rect.left;
          this.mouse_pos[1] = event.clientY - rect.top;
          if (this.dragged_item_collection)
          {
            for(i = 0; i < this.dragged_item_collection.length; i++)
            {
              this.dragged_item_collection[i].transpose(this.mouse_pos[0] - old_x, this.mouse_pos[1] - old_y);
            }
          }
        },
        handleMouseUp: function (event) {
          if (this.dragged_item_collection)
          {
            for(i = 0; i < this.dragged_item_collection.length; i++)
            {
              this.dragged_item_collection[i].color = MOVEABLE_COLOR;
              this.dragged_item_collection[i].snap(35);
            }
          }
          this.dragged_item_collection = null;
        },
        handleKeyDown: function (event) {
        },
        handleKeyUp: function (event) {
        },
        handleTimeStep: function () {
          for(var i = this.timestep_list.length - 1; i>=0; i--)
          {
            if(!this.timestep_list[i].checkPulse())
            {
              this.timestep_list.splice(i,1);
            }
            else
            {
              this.timestep_list[i].handleTimeStep();
            }
          }
        },
        paint: function () {
          g_ctx.setTransform(1, 0, 0, 1, 0, 0);

          g_ctx.fillStyle = "#f0f0f0";
          g_ctx.fillRect(
              0, 0,
              g_canvas.width,
              g_canvas.height);
          g_ctx.fillStyle = "black";
          g_ctx.textBaseline="middle";
          g_ctx.textAlign="center";
          this.textHeight = Math.round(INVERSE_PHI * 30);
          g_ctx.font = this.textHeight + "px Verdana";
          g_ctx.fillText(this.name,Math.round(g_canvas.width/2),Math.round(70));
          g_ctx.textBaseline = "bottom";
          g_ctx.textAlign = "left"
          this.backTextSize = g_ctx.measureText("<<").width;
          g_ctx.fillText("<<", 0, g_canvas.height);
          g_ctx.textAlign = "right";
          this.forwardTextSize = g_ctx.measureText(">>").width;
          g_ctx.fillText(">>", g_canvas.width, g_canvas.height);

          for (var i = this.paint_list.length - 1; i>=0; i--)
          {
            if(!this.paint_list[i].checkPulse())
            {
              this.paint_list.splice(i,1);
            }
            else
            {
              this.paint_list[i].paint(g_ctx);
            }
          }
        },
    };

    //##########################################################################

    //--------------------------------------------------------------------------
    var ResourceTracker = {
        m_added: 1, // I track myself loading
        m_loaded: 0,
        m_layout: null,

        //----------------------------------------------------------------------
        // from Screen
        init: function ()
        {
            this.onload(null); //and here I'm loaded
        },

        //----------------------------------------------------------------------
        // from Screen
        reset: function ()
        {},

        //----------------------------------------------------------------------
        // from Screen
        handleMouseDown: function ()
        {},

        //----------------------------------------------------------------------
        // from Screen
        handleMouseUp: function ()
        {},

        //----------------------------------------------------------------------
        // from Screen
        handleKeyDown: function ()
        {},

        //----------------------------------------------------------------------
        // from Screen
        handleKeyUp: function (event)
        {},

        //----------------------------------------------------------------------
        // from Screen
        handleTimeStep: function ()
        {
          if (this.m_loaded == this.m_added)
          {
            this.onAllLoaded();
          }
        },

        //----------------------------------------------------------------------
        // from Screen
        paint: function ()
        {
            g_ctx.setTransform(1, 0, 0, 1, 0, 0);

            // paint the background
            g_ctx.fillStyle = "rgb(0, 0, 0)";
            g_ctx.fillRect(
                0, 0,
                g_canvas.width,
                g_canvas.height);

            g_ctx.font="Bold 80px Arial";
            g_ctx.fillStyle = "rgb(128, 128, 128)";
            g_ctx.textAlign = "center";
            g_ctx.textBaseline = "middle";
            g_ctx.fillText(
                Math.floor(100 * this.m_loaded / this.m_added) + "%",
                g_canvas.width / 2,
                g_canvas.height / 2
            );
        },


        //----------------------------------------------------------------------
        add: function ()
        {
            ++this.m_added;
        },

        //----------------------------------------------------------------------
        // from Image.onload
        onload: function (event)
        {
            ++this.m_loaded;
            if (this.m_loaded == this.m_added)
            {
                this.onAllLoaded();
            }
        },

        //----------------------------------------------------------------------
        onAllLoaded: function ()
        {
            switchToScreen(GameScreen);
        }
    };

    //--------------------------------------------------------------------------
    var AudioComponents = {
    };

    //--------------------------------------------------------------------------
    var GraphicComponents = {
    };

    //##########################################################################
    // game engine

    //--------------------------------------------------------------------------
    function init()
    {
        //Canvas stuff
        g_canvas = document.getElementById("canvas");
        //g_canvas.style.cursor = 'none';
        g_ctx = g_canvas.getContext("2d");
        g_ctx.textAlign="start";
        g_ctx.textBaseline="middle";
        g_level = 0;
        g_level_cap = 1;

        g_canvas.addEventListener("mousedown", function (event) {
            g_current_screen.handleMouseDown(event);
        }, false);

        g_canvas.addEventListener("mouseup", function (event) {
            g_current_screen.handleMouseUp(event);
        }, false);

        g_canvas.addEventListener("mouseleave", function (event) {
            g_current_screen.handleMouseUp(event);
        }, false);

        g_canvas.addEventListener("mouseout", function (event) {
            g_current_screen.handleMouseUp(event);
        }, false);

        g_canvas.addEventListener("mousemove", function (event) {
            g_current_screen.handleMouseMove(event);
        }, false);

        document.addEventListener("keydown", function (event) {
            g_current_screen.handleKeyDown(event);
        }, false);

        document.addEventListener("keyup", function (event) {
            g_current_screen.handleKeyUp(event);
        }, false);

        // can't do this until you've set up canvas_width and canvas_height
        //ResourceTracker init must be called after all requests to
        //loadImage/loadAudio
        ResourceTracker.init();
        GameScreen.init();

        switchToScreen(ResourceTracker);

        // start processing events
        setTimeout(eventLoop, 40);
    }

    //--------------------------------------------------------------------------
    function switchToScreen(screen)
    {
        screen.reset();
        g_current_screen = screen;
    }

    //--------------------------------------------------------------------------
    function eventLoop()
    {
        var start_time = Date.now();

        g_current_screen.handleTimeStep();
        g_current_screen.paint(g_ctx);

        var end_time = Date.now();
        var comp_time = end_time - start_time;
        if (comp_time > 40 || comp_time < 0) {
            setTimeout(eventLoop, 0);
        }
        else
        {
            setTimeout(eventLoop, 40 - comp_time);
        }
    }

    // launch the game once the document is fully loaded
    window.addEventListener("load", init);

</script>
</body>
</html>

