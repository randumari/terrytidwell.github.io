<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/buzz/1.1.10/buzz.min.js" type="text/javascript"></script>
</head>
<body style="background-color: white; position: absolute; top: 50%; left: 50%; transform: translateX(-50%) translateY(-50%);">
<canvas id="canvas" width="800" height="600"></canvas>
<script>
    //##########################################################################
    // The game

    var g_canvas;
    var g_ctx;
    var g_current_screen;
    var g_level;
    var g_level_cap;
    
    var PHI = 1.61803398875;
    var INVERSE_PHI = 0.61803398875;
    
    var MOVE_COLOR = "red";
    var MOVEABLE_COLOR = "black";
    var STATIC_COLOR = "lightgrey";

    //--------------------------------------------------------------------------
    // interface, for reference, not enforced
    // The name is funny because Screen is already declared
    // and this is just for reference anyway
    const Screen_ = {
        init: function (layout) {},
        reset: function () {},
        handleMouseDown: function (event) {},
        handleMouseUp: function (event) {},
        handleKeyDown: function (event) {},
        handleKeyUp: function (event) {},
        handleTimeStep: function () {},
        paint: function () {}
    };

    //--------------------------------------------------------------------------
    const Util = {

        //----------------------------------------------------------------------
        forEach: function (obj, fn)
        {
            var key;
            for (key in obj)
            {
                if (obj.hasOwnProperty(key))
                {
                    fn(obj[key]);
                }
            }
        },

        //----------------------------------------------------------------------
        randomItem: function (arr)
        {
            return arr[Math.floor(Math.random() * arr.length)];
        },

        //----------------------------------------------------------------------
        shuffle: function (arr)
        {
            var current_index = arr.length, temp, random_index;
            while (0 != current_index)
            {
                // Pick a remaining element.
                random_index = Math.floor(Math.random() * current_index);
                current_index -= 1;

                // And swap it with the current element.
                temp = arr[current_index];
                arr[current_index] = arr[random_index];
                arr[random_index] = temp;
            }
            return arr;
        },
        
        //----------------------------------------------------------------------
        loadImage: function (url, resource_tracker)
        {
            var image = new Image();
            resource_tracker.add();
            image.onload = function (event) {
                resource_tracker.onload(event);
            };
            image.src = url;
            return image;
        },

        //----------------------------------------------------------------------
        loadAudio: function (url, resource_tracker)
        {
            var audio = new buzz.sound(
              url, {
              //formats: [ "wav" ],
              preload: true,
              autoplay: false,
              loop: false
            });
            resource_tracker.add();
            audio.bindOnce("canplay", function (event) {
                resource_tracker.onload(event)
            });
            return audio;
        }
    };
    
    var Grid = function()
    {
      this.visible = false;
      this.size = 35;
      this.squares = [];
      this.font_width = null;
      this.font_height = null;
      this.font_center_x = null;
      this.font_center_y = null;
    
      this.checkPulse = function()
      {
        return true;
      }
      
      this.handleMouseDown = function(event)
      {
        if (this.font_width &&
          this.font_height &&
          this.font_center_x &&
          this.font_center_y)
        {
          if(event.offsetX > this.font_center_x - this.font_width / 2 &&
            event.offsetX < this.font_center_x + this.font_width / 2 &&
            event.offsetY > this.font_center_y - this.font_height / 2 &&
            event.offsetY < this.font_center_y + this.font_height / 2)
          {
            this.visible = !this.visible;
            return true;
          }
        }
        return false;
      };
      
      this.paint = function(ctx)
      {
        ctx.fillStyle = MOVEABLE_COLOR;
        ctx.textBaseline="middle";
        ctx.textAlign="center";
        this.font_height = Math.round(INVERSE_PHI * (this.size - 5));
        ctx.font = this.font_height + "px Verdana";
        var text = "GRID: " + (this.visible ? "ON" : "OFF");
        this.font_width = ctx.measureText(text).width;
        this.font_center_x = Math.round(g_canvas.width / 2);
        this.font_center_y = g_canvas.height - this.size * 2;
        ctx.fillText(text, this.font_center_x, this.font_center_y)

        if (!this.visible)
        {
          return;
        }
        for(var i = this.squares.length - 1; i>=0; i--)
        {
          ctx.fillStyle = STATIC_COLOR;
          ctx.fillRect(this.squares[i][0] * this.size, this.squares[i][1] * this.size, this.size - 5, this.size - 5);
          
        }
      };
    }
    
    var LetterBoxCollection = function()
    {
      this.letterBoxList = [];
      this.alive = true;
      this.color = MOVEABLE_COLOR;
      
      this.handleTimeStep = function()
      {
      };
      
      this.checkPulse = function()
      {
        return this.alive;
      }
      
      this.handleMouseDown = function(event)
      {
        for(var i = this.letterBoxList.length - 1; i>=0; i--)
        {
          if(this.letterBoxList[i].handleMouseDown(event))
          {
            this.color = MOVE_COLOR
            return true;
          }
        }
        return false;
      };
      
      this.paint = function(ctx)
      {
        for(var i = this.letterBoxList.length - 1; i>=0; i--)
        {
          this.letterBoxList[i].color = this.color
          this.letterBoxList[i].paint(ctx);
        }
      };
      
      this.transpose = function(deltaX, deltaY)
      {
        for(var i = this.letterBoxList.length - 1; i>=0; i--)
        {
          this.letterBoxList[i].transpose(deltaX, deltaY);
        }
      }
      
      this.snap = function(size)
      {
        for(var i = this.letterBoxList.length - 1; i>=0; i--)
        {
          this.letterBoxList[i].x = size * Math.round((this.letterBoxList[i].x)/size);
          this.letterBoxList[i].y = size * Math.round((this.letterBoxList[i].y)/size);
        }
      }
    }
    
    var LetterBox = function(x,y,size,letter)
    {
      this.x = x;
      this.y = y;
      this.size = size;
      this.letter = letter;
      this.color = MOVEABLE_COLOR; //overwritten by LetterBoxCollection
      this.alive = true;
      
      this.handleTimeStep = function()
      {
      };
      
      this.checkPulse = function()
      {
        return this.alive;
      }
      
      this.handleMouseDown = function(event)
      {
        //alert("this.x = " + this.x + ", this.size = " + this.size + ", event.offsetX = " + event.offsetX);
        var hit = this.x + this.size > event.offsetX && 
          event.offsetX > this.x &&
          this.y + this.size > event.offsetY && 
          event.offsetY > this.y;
        return hit;
      };
      
      this.paint = function(ctx)
      {
        ctx.strokeStyle = this.color;
        ctx.fillStyle = this.color;
        ctx.lineJoin ="round";
        ctx.lineWidth = Math.round(this.size / (10*PHI));
        ctx.strokeRect(this.x, this.y, this.size, this.size);
        ctx.textBaseline="middle";
        ctx.textAlign="center";
        ctx.font = Math.round(INVERSE_PHI * this.size) + "px Verdana";
        ctx.fillText(this.letter,Math.round(this.x+this.size/2),Math.round(this.y+this.size/2));
      };
      
      this.transpose = function(deltaX, deltaY)
      {
        this.x += Math.round(deltaX);
        this.y += Math.round(deltaY);
      }
    };
    
    var Timer = function(timer, callback, parameter)
    {
      this.current_time = timer;
      this.callback = callback;
      this.parameter = parameter;
      this.handleTimeStep = function()
      {
        this.current_time--;
        if(this.current_time <= 0)
        {
          callback(this.parameter);
        }
        
      };
      this.checkPulse = function(){
            return this.current_time > 0;
      };
    }
    
    //##########################################################################
    var GameScreen = {
        
        init: function () {
          this.reset();
        },

        populateLevel: function (stage) {

          g_level_cap = 2;

          var letter_box_collection = new LetterBoxCollection();
          var x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
          var y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;

          switch (stage) {
            case 0:
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "D"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y, 30, "O"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);
              
              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "G"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y + 35, 30, "O"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);
              
              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "O"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y + 35, 30, "S"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y + 70, 30, "E"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y + 35, 30, "H"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);
              
              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "E"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y + 35, 30, "Y"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y, 30, "E"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 70, y, 30, "P"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);
              
              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "I"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y + 35, 30, "G"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y + 35, 30, "O"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);
              
              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "A"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y + 35, 30, "T"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y, 30, "T"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);
              
              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "C"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);
              
              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "T"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y + 35, 30, "U"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y + 70, 30, "R"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y + 105, 30, "K"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y + 70, 30, "O"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);
              
              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "O"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y, 30, "S"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y - 35, 30, "R"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y + 35, 30, "E"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);
              
              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "E"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y + 35, 30, "N"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y - 35, 30, "K"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y, 30, "R"));
              letter_box_collection.letterBoxList.push(new LetterBox(x - 35, y, 30, "T"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);
              
              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "H"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y + 35, 30, "O"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);
              
              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "D"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y, 30, "U"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);
              
              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "C"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y + 35, 30, "H"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y, 30, "K"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);
              
              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "I"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y + 35, 30, "C"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y + 35, 30, "O"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);
              
              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "W"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);
              
              var grid = new Grid();
              grid.squares.push([13,3]);
              grid.squares.push([14,3]);
              grid.squares.push([15,3]);
              grid.squares.push([16,3]);
              grid.squares.push([15,4]);
              grid.squares.push([15,5]);
              grid.squares.push([15,6]);
              grid.squares.push([16,6]);
              grid.squares.push([17,6]);
              grid.squares.push([15,7]);
              grid.squares.push([10,8]);
              grid.squares.push([11,8]);
              grid.squares.push([12,8]);
              grid.squares.push([13,8]);
              grid.squares.push([14,8]);
              grid.squares.push([15,8]);
              grid.squares.push([16,8]);
              grid.squares.push([15,9]);
              grid.squares.push([13,5]);
              grid.squares.push([13,6]);
              grid.squares.push([13,7]);
              grid.squares.push([13,9]);
              grid.squares.push([10,6]);
              grid.squares.push([10,7]);
              grid.squares.push([10,9]);
              grid.squares.push([10,10]);
              grid.squares.push([10,11]);
              grid.squares.push([8,10]);
              grid.squares.push([9,10]);
              grid.squares.push([11,10]);
              grid.squares.push([12,10]);
              grid.squares.push([12,11]);
              grid.squares.push([12,12]);
              grid.squares.push([13,12]);
              grid.squares.push([14,11]);
              grid.squares.push([14,12]);
              grid.squares.push([14,13]);
              grid.squares.push([15,12]);
              grid.squares.push([6,7]);
              grid.squares.push([7,7]);
              grid.squares.push([8,7]);
              grid.squares.push([8,8]);
              grid.squares.push([8,9]);
              grid.squares.push([8,11]);
              
              this.paint_list.push(grid);
              this.clickable_list.push(grid);

              this.name = "THE FARM";

              break;
            case 1:

              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "B"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y, 30, "E"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);

              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "A"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y, 30, "T"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y + 35, 30, "R"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);

              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "I"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y + 35, 30, "A"));
              letter_box_collection.letterBoxList.push(new LetterBox(x - 35, y + 35, 30, "R"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);

              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y - 35, 30, "V"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y, 30, "E"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "P"));
              letter_box_collection.letterBoxList.push(new LetterBox(x - 35, y, 30, "O"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);

              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "N"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y, 30, "O"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);

              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "C"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y, 30, "O"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);

              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "S"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y - 35, 30, "R"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y + 35, 30, "E"));
              letter_box_collection.letterBoxList.push(new LetterBox(x - 35, y + 35, 30, "T"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);

              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "E"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y - 35, 30, "T"));
              letter_box_collection.letterBoxList.push(new LetterBox(x - 35, y, 30, "R"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y + 35, 30, "N"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);

              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "A"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y, 30, "R"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y  - 35, 30, "O"));
              letter_box_collection.letterBoxList.push(new LetterBox(x - 35, y, 30, "H"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);

              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "M"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y + 35, 30, "E"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);
              
              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "T"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y + 35, 30, "E"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);                            
              
              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "R"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y, 30, "D"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);              
              
              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "I"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y, 30, "C"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);              

              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "O"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y - 35, 30, "P"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y - 70, 30, "M"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y, 30, "N"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 70, y, 30, "Y"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);

              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "H"));
              letter_box_collection.letterBoxList.push(new LetterBox(x - 35, y, 30, "C"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y, 30, "O"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y - 35, 30, "L"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);

              letter_box_collection = new LetterBoxCollection();
              x = Math.round(Math.random()*(g_canvas.width - 140)) + 70;
              y = Math.round(Math.random()*(g_canvas.height - 140)) + 70;
              letter_box_collection.letterBoxList.push(new LetterBox(x, y, 30, "Y"));
              letter_box_collection.letterBoxList.push(new LetterBox(x - 35, y, 30, "L"));
              letter_box_collection.letterBoxList.push(new LetterBox(x + 35, y, 30, "R"));
              letter_box_collection.letterBoxList.push(new LetterBox(x, y - 35, 30, "D"));
              letter_box_collection.snap(35);
              this.paint_list.push(letter_box_collection);
              this.draggable_list.push(letter_box_collection);

              var grid = new Grid();
              grid.squares.push([9,3]);
              grid.squares.push([10,3]);
              grid.squares.push([11,3]);
              grid.squares.push([12,3]);
              grid.squares.push([11,4]);
              grid.squares.push([11,5]);
              grid.squares.push([11,6]);
              grid.squares.push([10,6]);
              grid.squares.push([9,6]);
              grid.squares.push([8,6]);
              grid.squares.push([7,6]);
              grid.squares.push([9,5]);
              grid.squares.push([9,7]);
              grid.squares.push([9,8]);
              grid.squares.push([9,9]);
              grid.squares.push([8,9]);
              grid.squares.push([7,9]);
              grid.squares.push([6,9]);

              grid.squares.push([10,8]);
              grid.squares.push([11,8]);
              grid.squares.push([12,8]);
              grid.squares.push([13,8]);
              grid.squares.push([13,7]);
              grid.squares.push([13,9]);
              grid.squares.push([13,10]);
              grid.squares.push([13,11]);
              grid.squares.push([15,7]);
              grid.squares.push([15,8]);
              grid.squares.push([15,9]);
              grid.squares.push([15,10]);
              grid.squares.push([15,11]);
              grid.squares.push([11,11]);
              grid.squares.push([12,11]);
              grid.squares.push([14,11]);
              grid.squares.push([16,11]);
              grid.squares.push([17,11]);
              grid.squares.push([14,12]);
              grid.squares.push([14,13]);
              grid.squares.push([14,14]);
              grid.squares.push([12,14]);
              grid.squares.push([13,14]);
              grid.squares.push([15,14]);
              grid.squares.push([16,14]);
              grid.squares.push([14,15]);
              grid.squares.push([14,16]);
              grid.squares.push([13,16]);
              grid.squares.push([15,16]);
              grid.squares.push([16,16]);
              grid.squares.push([17,16]);

              this.paint_list.push(grid);
              this.clickable_list.push(grid);

              this.name = "MUSIC";
              break;
            default:
              break;
          }
        },

        reset: function () {
          this.paint_list = [];
          this.timestep_list = [];
          this.draggable_list = [];
          this.clickable_list = [];
          this.dragged_item = null;
          this.mouse_pos = [null, null];
          this.name = "";
          this.backTextSize = null;
          this.forwardTextSize = null;
          this.textHeight = null;

          this.populateLevel(g_level);
          
          //this.current_target = new MysteryBox(g_canvas.width - 60, g_canvas.height - 60, 50, Util.randomItem(this.color_list));
          //this.current_target.revealed = true;
          //this.paint_list.push(this.current_target);
        },
        handleMouseDown: function (event) {
          for(var i = this.draggable_list.length - 1; i>=0; i--)
          {
            if(!this.draggable_list[i].checkPulse())
            {
              this.draggable_list.splice(i,1);
            }
            else
            {
              if(this.draggable_list[i].handleMouseDown(event))
              {
                this.dragged_item = this.draggable_list[i];
                return true;
              }
            }
          }
          for(var i = this.clickable_list.length - 1; i>=0; i--)
          {
            if(!this.clickable_list[i].checkPulse())
            {
              this.clickable_list.splice(i,1);
            }
            else
            {
              if(this.clickable_list[i].handleMouseDown(event))
              {
                return true;
              }
            }
          }
          
          if (this.backTextSize &&
            this.forwardTextSize &&
            this.textHeight)
          {
            if(event.offsetY > g_canvas.height - this.textHeight)
            {
              if(event.offsetX < this.backTextSize)
              {
                if(g_level === 0)
                {
                  g_level = g_level_cap;
                }
                g_level--;
                this.reset();
                return true;
              }
              if(event.offsetX > g_canvas.width - this.forwardTextSize)
              {
                g_level++;
                g_level %= g_level_cap;
                this.reset();
                return true;
              }
            }
          }
          return false;
        },
        handleMouseMove: function (event) {
          var rect = canvas.getBoundingClientRect();
          var old_x = this.mouse_pos[0];
          var old_y = this.mouse_pos[1];
          this.mouse_pos[0] = event.clientX - rect.left;
          this.mouse_pos[1] = event.clientY - rect.top;
          if (this.dragged_item)
          {
            this.dragged_item.transpose(this.mouse_pos[0] - old_x, this.mouse_pos[1] - old_y);
          }
        },
        handleMouseUp: function (event) {
          if (this.dragged_item)
          {
            this.dragged_item.color = MOVEABLE_COLOR;
            this.dragged_item.snap(35);
          }
          this.dragged_item = null;
        },
        handleKeyDown: function (event) {
        },
        handleKeyUp: function (event) {
        },
        handleTimeStep: function () {
          for(var i = this.timestep_list.length - 1; i>=0; i--)
          {
            if(!this.timestep_list[i].checkPulse())
            {
              this.timestep_list.splice(i,1);
            }
            else
            {
              this.timestep_list[i].handleTimeStep();
            }
          }
        },
        paint: function () {
          g_ctx.setTransform(1, 0, 0, 1, 0, 0);
          
          g_ctx.fillStyle = "#f0f0f0";
          g_ctx.fillRect(
              0, 0,
              g_canvas.width,
              g_canvas.height);
          g_ctx.fillStyle = "black";
          g_ctx.textBaseline="middle";
          g_ctx.textAlign="center";
          this.textHeight = Math.round(INVERSE_PHI * 30);
          g_ctx.font = this.textHeight + "px Verdana";
          g_ctx.fillText(this.name,Math.round(g_canvas.width/2),Math.round(70));
          g_ctx.textBaseline = "bottom";
          g_ctx.textAlign = "left"
          this.backTextSize = g_ctx.measureText("<<").width;
          g_ctx.fillText("<<", 0, g_canvas.height);
          g_ctx.textAlign = "right";
          this.forwardTextSize = g_ctx.measureText(">>").width;
          g_ctx.fillText(">>", g_canvas.width, g_canvas.height);

          for(var i = this.paint_list.length - 1; i>=0; i--)
          {
            if(!this.paint_list[i].checkPulse())
            {
              this.paint_list.splice(i,1);
            }
            else
            {
              this.paint_list[i].paint(g_ctx);
            }
          }
        },
    };
    
    //##########################################################################
    
    //--------------------------------------------------------------------------
    var ResourceTracker = {
        m_added: 1, // I track myself loading
        m_loaded: 0,
        m_layout: null,

        //----------------------------------------------------------------------
        // from Screen
        init: function ()
        {
            this.onload(null); //and here I'm loaded
        },

        //----------------------------------------------------------------------
        // from Screen
        reset: function ()
        {},

        //----------------------------------------------------------------------
        // from Screen
        handleMouseDown: function ()
        {},
        
        //----------------------------------------------------------------------
        // from Screen
        handleMouseUp: function ()
        {},

        //----------------------------------------------------------------------
        // from Screen
        handleKeyDown: function ()
        {},
        
        //----------------------------------------------------------------------
        // from Screen
        handleKeyUp: function (event)
        {},

        //----------------------------------------------------------------------
        // from Screen
        handleTimeStep: function ()
        {
          if (this.m_loaded == this.m_added)
          {
            this.onAllLoaded();
          }
        },

        //----------------------------------------------------------------------
        // from Screen
        paint: function ()
        {
            g_ctx.setTransform(1, 0, 0, 1, 0, 0);

            // paint the background
            g_ctx.fillStyle = "rgb(0, 0, 0)";
            g_ctx.fillRect(
                0, 0,
                g_canvas.width,
                g_canvas.height);

            g_ctx.font="Bold 80px Arial";
            g_ctx.fillStyle = "rgb(128, 128, 128)";
            g_ctx.textAlign = "center";
            g_ctx.textBaseline = "middle";
            g_ctx.fillText(
                Math.floor(100 * this.m_loaded / this.m_added) + "%",
                g_canvas.width / 2,
                g_canvas.height / 2
            );
        },


        //----------------------------------------------------------------------
        add: function ()
        {
            ++this.m_added;
        },

        //----------------------------------------------------------------------
        // from Image.onload
        onload: function (event)
        {
            ++this.m_loaded;
            if (this.m_loaded == this.m_added)
            {
                this.onAllLoaded();
            }
        },

        //----------------------------------------------------------------------
        onAllLoaded: function ()
        {
            switchToScreen(GameScreen);
        }
    };

    //--------------------------------------------------------------------------
    var AudioComponents = {
    };
    
    //--------------------------------------------------------------------------
    var GraphicComponents = {
    };

    //##########################################################################
    // game engine
    
    //--------------------------------------------------------------------------
    function init()
    {
        //Canvas stuff
        g_canvas = document.getElementById("canvas");
        //g_canvas.style.cursor = 'none';
        g_ctx = g_canvas.getContext("2d");
        g_ctx.textAlign="start";
        g_ctx.textBaseline="middle";
        g_level = 0;
        g_level_cap = 1;

        g_canvas.addEventListener("mousedown", function (event) {
            g_current_screen.handleMouseDown(event);
        }, false);
        
        g_canvas.addEventListener("mouseup", function (event) {
            g_current_screen.handleMouseUp(event);
        }, false);

        g_canvas.addEventListener("mouseleave", function (event) {
            g_current_screen.handleMouseUp(event);
        }, false);

        g_canvas.addEventListener("mouseout", function (event) {
            g_current_screen.handleMouseUp(event);
        }, false);
        
        g_canvas.addEventListener("mousemove", function (event) {
            g_current_screen.handleMouseMove(event);
        }, false);

        document.addEventListener("keydown", function (event) {
            g_current_screen.handleKeyDown(event);
        }, false);
        
        document.addEventListener("keyup", function (event) {
            g_current_screen.handleKeyUp(event);
        }, false);

        // can't do this until you've set up canvas_width and canvas_height
        //ResourceTracker init must be called after all requests to 
        //loadImage/loadAudio
        ResourceTracker.init();
        GameScreen.init();

        switchToScreen(ResourceTracker);

        // start processing events
        setTimeout(eventLoop, 40);
    }

    //--------------------------------------------------------------------------
    function switchToScreen(screen)
    {
        screen.reset();
        g_current_screen = screen;
    }

    //--------------------------------------------------------------------------
    function eventLoop()
    {
        var start_time = Date.now();

        g_current_screen.handleTimeStep();
        g_current_screen.paint(g_ctx);

        var end_time = Date.now();
        var comp_time = end_time - start_time;
        if (comp_time > 40 || comp_time < 0) {
            setTimeout(eventLoop, 0);
        }
        else
        {
            setTimeout(eventLoop, 40 - comp_time);
        }
    }

    // launch the game once the document is fully loaded
    window.addEventListener("load", init);

</script>
</body>
</html>

