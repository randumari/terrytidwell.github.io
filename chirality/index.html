<!DOCTYPE html>
<html>
<head>
    <title>Chirality</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>
<body bgcolor="#000000">
<canvas style = 'position: absolute; left: 0px; top: 0px;' id="canvas" width="1024" height="800"></canvas>
<script src="https://cdnjs.cloudflare.com/ajax/libs/buzz/1.1.10/buzz.min.js" type="text/javascript"></script>
<script src="../gameEngine/engine.js" type="text/javascript"></script>
<script src="entities.js" type="text/javascript"></script>
    
<script>
//##########################################################################
// The game
//

var g_font = "Lucida Console";
var g_aspect_ratio = 4/3;
var PHI = 1.61803398875;
var INVERSE_PHI = 0.61803398875;

//--------------------------------------------------------------------------
const Util = {

    //----------------------------------------------------------------------
    forEach: function (obj, fn)
    {
        var key;
        for (key in obj)
        {
            if (obj.hasOwnProperty(key))
            {
                fn(obj[key]);
            }
        }
    },

    //----------------------------------------------------------------------
    randomItem: function (arr)
    {
        return arr[Math.floor(Math.random() * arr.length)];
    },

    //----------------------------------------------------------------------
    shuffle: function (arr)
    {
        var current_index = arr.length, temp, random_index;
        while (0 != current_index)
        {
            // Pick a remaining element.
            random_index = Math.floor(Math.random() * current_index);
            current_index -= 1;

            // And swap it with the current element.
            temp = arr[current_index];
            arr[current_index] = arr[random_index];
            arr[random_index] = temp;
        }
        return arr;
    }
};

//##########################################################################

const Logo = {
  init: function (jut)
  {
    this.jut = jut;
  },
  
  reset: function ()
  {
    this.loadTimer = 0;
    this.textTimerLimit = 40;
    this.textTimer = 0;
    this.textFadeInTimerLimit = 100;
    this.textFadeInTimer = 0;
    this.cursorTimer = 0;
    this.scanline=0;
    this.polarity = 1;
    this.bounce=30;
  },
  
  handleTimeStep: function ()
  {
    if (this.loadTimer < 99)
    {
      this.loadTimer+=1;
    }
    else
    {
      this.polarity = -10;
      this.textFadeInTimer += this.polarity
    }

    if (this.textTimer < this.textTimerLimit)
    {
      this.textTimer++;
    }
    
    
    if (this.textFadeInTimer < this.textFadeInTimerLimit)
    {
      this.textFadeInTimer += this.polarity;
      if (this.textFadeInTimer <= 0)
      {
        this.jut.switchToScreen(Intro);
      }
    }

    this.scanline+=5;
    this.cursorTimer++;
    if (this.bounce > 0)
    {
      this.bounce-=3;
    }
    else
    {
      if (Math.random() < .01 || this.polarity < 0)
      {
        this.bounce = 30;
      }
    }
  },
  
  paint: function (canvas, ctx)
  {
   //this.otherScreen.paint();
    ctx.setTransform(1, 0, 0, 1, 0, 0);

    // paint the background
    ctx.fillStyle = "rgba(0,0,0)";
    ctx.fillRect(
      0, 0,
      canvas.width,
      canvas.height);

    var text_size = Math.round(canvas.height / 6);
    var game_over = "VelociGames";
    var jitter = Math.random() * text_size / 30 - text_size / 60;
    var text = game_over.substring(0, Math.round(this.textTimer / this.textTimerLimit * game_over.length));
      
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.shadowOffsetX = canvas.width;
    ctx.shadowOffsetY = 0;
    
    ctx.shadowColor = "rgba(0,128,0," + (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";

    ctx.font = text_size * 2 + "px " + g_font;
    ctx.shadowBlur = Math.round(text_size / 4);
    
    var load_text = "" + Math.round(this.loadTimer) + "%"
    if (Math.random() < .01)
    {
      ctx.shadowColor = "rgba(0,64,0," + (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
    }
    ctx.fillText(load_text, -canvas.width + canvas.width / 2 + jitter, canvas.height / 2);
    
    ctx.font = text_size + "px " + g_font;
    ctx.textAlign = "left";
    var textWidth = ctx.measureText(text + "_").width;
    if (Math.floor(this.cursorTimer / 10) % 2)
    {
      text += "_"
    }
    else
    {
      text += " ";
    }
    var textPosition = Math.round(canvas.width / 2 - textWidth / 2);
    
    ctx.shadowColor = "rgba(0,192,0," + (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
    ctx.shadowBlur = Math.round(text_size * 2 / 3);
    ctx.fillText(text, -canvas.width + textPosition + jitter, canvas.height / 2);
    ctx.shadowBlur = Math.round(text_size / 3);
    ctx.fillText(text, -canvas.width + textPosition + jitter, canvas.height / 2);
    //ctx.shadowColor = "rgba(0,255,0," + (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
    ctx.shadowBlur = 1;
    //ctx.fillStyle = "rgba(0,0,0," + .75 * (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
    ctx.fillText(text, -canvas.width + textPosition, canvas.height / 2);
    //ctx.fillText(text, canvas.width / 2, canvas.height / 2);
    ctx.lineWidth = Math.max(1, Math.round(canvas.height/400));
    ctx.strokeStyle = "rgba(0,0,0," + .25 * (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
    if(this.scanline > canvas.height * 3 / 4)
    {
      this.scanline=canvas.height/4;
    }
    ctx.putImageData(ctx.getImageData(0,Math.round(this.scanline), canvas.width, ctx.lineWidth*2), -3, Math.round(this.scanline));
    if (this.bounce > 0)
    {
    var current_bounce = Math.random()*this.bounce - this.bounce/2;
    for(var y = 0; y < canvas.width; y+=ctx.lineWidth*2)
    {
      current_bounce += Math.random()*this.bounce - this.bounce/2;
      ctx.putImageData(ctx.getImageData(0,y, canvas.width, ctx.lineWidth*2), current_bounce, y);
    }
    }
    
    for(var y = 0; y < canvas.height; y+=2*ctx.lineWidth)
    {
      ctx.beginPath();
      ctx.moveTo(0,y);
      ctx.lineTo(canvas.width,y);
      ctx.stroke();
    }
    
    /*
    for(var x = 0; x < canvas.width; x+=2*ctx.lineWidth)
    {
      ctx.beginPath();
      ctx.moveTo(x,0);
      ctx.lineTo(x,canvas.height);
      ctx.stroke();
    }
    // */
  }
};

//------------------------------------------------------------------------
var Intro = {
  init: function (jut)
  {
    this.jut = jut;
  },
  reset: function ()
  {
    this.cursorTimer = 0;
    this.script = [];
    this.visible = [""];
    this.type_time = 0;
    this.gamestate = 
    {
      gameEntities : []
    };
    this.game_events = [];
    var intro_screen = this;
    this.game_events.push(createTimer(40, function() {
      intro_screen.addLineToScript("rift activity detected");
    }));
    this.game_events.push(createConditionalEvent(function () { return intro_screen.script.length === 0; }, 
      function () {}));
    this.game_events.push(createTimer(80, function () { intro_screen.clearVisible(); }));
    this.game_events.push(createTimer(40, function () { intro_screen.addLineToScript("starting primary systems"); }));
    this.game_events.push(createTimer(40, function () { 
      intro_screen.visible.push("");
      intro_screen.visible.push("");
      intro_screen.addLineToScript("power generators online"); }));
    this.game_events.push(createConditionalEvent(function () { return intro_screen.script.length === 0; },
      function () { 
      intro_screen.visible.push("");
      intro_screen.addLineToScript("cognitive engine online"); }));  
    this.game_events.push(createConditionalEvent(function () { return intro_screen.script.length === 0; },
      function () { 
      intro_screen.visible.push("");
      intro_screen.addLineToScript("system interface online"); }));
      this.game_events.push(createConditionalEvent(function () { return intro_screen.script.length === 0; },
      function () { 
      intro_screen.visible.push("");
      intro_screen.addLineToScript("enviromental monitoring online"); }));
        this.game_events.push(createConditionalEvent(function () { return intro_screen.script.length === 0; },
      function () { 
      intro_screen.visible.push("");
      intro_screen.addLineToScript("speech recoginition interface online"); }));
    this.game_events.push(createTimer(80, function () { 
      var mainContainer = createContainer(1/150, 1/150, g_aspect_ratio - 2/150, 1 - 2/150)
      intro_screen.gamestate.gameEntities.push(mainContainer);
      intro_screen.gamestate.bottom_panel = createPanel(0, 2/3, 1, 1/3, mainContainer);
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.bottom_panel);
      intro_screen.gamestate.degauss.bounce = 1;
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "incoming message...", "")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
    }));
    this.game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
      intro_screen.clearVisible();
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "Unknown Sender", "I'm ... stepping through the ... now... Preparing for ...")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
    }));
    this.game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
      intro_screen.addLineToScript("rift breach imminent");
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "Unknown Sender", "... about ... to cross ... barrier ...")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
    }));
    this.game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {}));
    this.game_events.push(createTimer(25, function () {
      intro_screen.clearVisible();
    }));
    this.game_events.push(createTimer(25, function () {
      intro_screen.addLineToScript("rift breached");
    }));
    this.game_events.push(createTimerLoop(15, function () {
      intro_screen.gamestate.degauss.bounce = 10;
    }));
    this.game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "Unknown Sender", "I'm through! This is Alice, I'm trying to uplink to you now.")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
    }));
    this.game_events.push(createTimer(50, function () {
      intro_screen.clearVisible();
      intro_screen.addLineToScript("remote uplink detected");
    }));
    this.game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "Alice", "I'm connected! Computer are you there?")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
    }));
    
    //GAME TIME!
    this.game_events.push(createTimer(50, function () {
      intro_screen.jut.switchToScreen(GameScreen);
    }));
    
    
    this.gamestate.gameEntities.push(this.game_events[0]);
    this.gamestate.degauss = createDeGauss();
    this.gamestate.gameEntities.push(this.gamestate.degauss);
    this.gamestate.gameEntities.push(createLcdLines());
    this.gamestate.gameEntities.push(createScanLine());
  },
  clearVisible : function()
  {
    this.visible = [""];
  },
  addLineToScript : function(string)
  {
    for(var i = 0; i < string.length; i++)
    {
      this.script.push(string.charAt(i));
    }
  },
  handleTimeStep: function ()
  {
    this.cursorTimer++;
    
    if(this.game_events.length !== 0 && !this.game_events[0].active())
    {
      this.game_events.shift();
      if(this.game_events.length !== 0)
      {
        this.gamestate.gameEntities.push(this.game_events[0]);
      }
    }
    
    if(this.script.length !== 0)
    {
      if (this.type_time > 0)
      {
        this.type_time--;
      }
      
      if (this.type_time === 0)
      {
        this.type_time = 1;
        this.visible[this.visible.length - 1] += this.script.shift();
      }
    }
    
    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if(this.gamestate.gameEntities[i].handleTimeStep)
      {
        this.gamestate.gameEntities[i].handleTimeStep(this.gamestate);
      }
    }
    
    for (var i = this.gamestate.gameEntities.length - 1; i >= 0; i--)
    {
      if(this.gamestate.gameEntities[i].active)
      {
        if(!this.gamestate.gameEntities[i].active())
        {
          this.gamestate.gameEntities.splice(i,1);
        }
      }
    }
  },
  paint: function (canvas, ctx)
  {
    ctx.setTransform(1, 0, 0, 1, 0, 0);
   
    // paint the background
    ctx.fillStyle = "rgb(0, 0, 0)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.textAlign = "left";
    ctx.textBaseline = "middle";
    ctx.shadowOffsetX = canvas.width;
    ctx.shadowOffsetY = 0;
    ctx.shadowColor = "rgb(0,128,0)";
    
    var text_size = Math.round(canvas.height / 30);
    ctx.font = text_size + "px " + g_font;
    var indent = Math.round(canvas.height / 30 * 1.5);
    for(var i = 0; i < this.visible.length; i++)
    {
      var line_level = Math.round(canvas.height / 30 * (i + 1.5))
      var text = this.visible[i];
      if (Math.floor(this.cursorTimer / 10) % 2 && i === this.visible.length - 1)
      {
        text += "_";
      }
      ctx.shadowBlur = Math.round(text_size * 2 / 3);
      ctx.fillText(text, -canvas.width + indent, line_level);
      ctx.shadowBlur = Math.round(text_size / 3);
      ctx.fillText(text, -canvas.width + indent, line_level);
      //ctx.shadowColor = "rgba(0,255,0," + (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
      ctx.shadowBlur = 1;
      //ctx.fillStyle = "rgba(0,0,0," + .75 * (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
      ctx.fillText(text, -canvas.width + indent, line_level);
    }
    
    this.gamestate.gameEntities.sort(function(a,b){
      var a_lvl = 0;
      var b_lvl = 0;
      if(a.paintLevel)
      {
        a_lvl = a.paintLevel();
      }
      if(b.paintLevel)
      {
        b_lvl = b.paintLevel();
      }
      return a_lvl - b_lvl;
    });
    
    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if (this.gamestate.gameEntities[i].paint)
      {
        this.gamestate.gameEntities[i].paint(this.gamestate,this.layout,canvas,ctx);
      }
    }
  }
};

//------------------------------------------------------------------------
var DemoScreen = {
  //----------------------------------------------------------------------
  init: function (jut)
  {
    this.jut = jut;
  },

  //----------------------------------------------------------------------
  // from Screen
  reset: function ()
  {
    //stores information about graphical layout
    this.layout = null;
    this.mouse_click_event = false;
    this.mouse_click_x = 0;
    this.mouse_click_y = 0;
    this.mouse_x = 0;
    this.mouse_y = 0;
    this.player_x = 0;
    this.player_y = 0;
    
    this.gamestate =
    {
      jut : this.jut,
      gameEntities: [],
      menu_handler: {},
    };
    var titleContainer = createContainer(0, 1/4, g_aspect_ratio, 1/4)
    //this.gamestate.gameEntities.push(createPanel(0,0,1,1,titleContainer));
    this.gamestate.gameEntities.push(titleContainer);
    var text = createText("chirality", titleContainer.width/2, titleContainer.height/2, 1/4, titleContainer, "center");
    this.gamestate.gameEntities.push(text);
    var menuContainer = createContainer(1/4 * g_aspect_ratio, 1/2, 1/2 * g_aspect_ratio, 2/8);
    var demoContainer = createContainer(3/4 * g_aspect_ratio, 15/16, 1/4 * g_aspect_ratio, 1/16);
    this.gamestate.gameEntities.push(createText("demo v0.0", demoContainer.width, demoContainer.height/2, demoContainer.height, demoContainer, "right"));
    var demoContainer2 = createContainer(0, 15/16, 1/4 * g_aspect_ratio, 1/16);
    this.gamestate.gameEntities.push(createText("VelociGames", 0, demoContainer2.height/2, demoContainer2.height, demoContainer2, "left"));

    this.gamestate.gameEntities.push(menuContainer);
    this.gamestate.gameEntities.push(createScanLine());
    this.gamestate.gameEntities.push(createDeGauss());
    this.gamestate.gameEntities.push(createLcdLines());
    var buttons = 2;
    var divisions = 2 * buttons + buttons + 1;
    var border = menuContainer.height / divisions;
    var button_height = border * 2;
    var map_item = createMenuItems("Introduction", menuContainer, 0, menuContainer.width,
      border, button_height)
    this.gamestate.gameEntities.push(map_item);
    var scan_item = createMenuItems("Game Screen", menuContainer, 0, menuContainer.width,
      button_height + 2*border, button_height);
    this.gamestate.gameEntities.push(scan_item);
    var jut = this.jut;
    this.gamestate.menu_handler["Introduction"] = function() {
      jut.switchToScreen(Logo);
    }
    this.gamestate.menu_handler["Game Screen"] = function() {
      jut.switchToScreen(GameScreen);
    }
  },

  handleMouseDown: function(event)
  {
    this.mouse_click_event = true;
    this.mouse_click_x = event.offsetX / event.currentTarget.height;
    this.mouse_click_y = event.offsetY / event.currentTarget.height;
    //event.currentTarget.width;
  },
  
  handleMouseMove: function(event)
  {
    this.mouse_x = event.offsetX / event.currentTarget.height;
    this.mouse_y = event.offsetY / event.currentTarget.height;
  },
  
  //----------------------------------------------------------------------
  // from Screen
  handleTimeStep: function ()
  {

    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if(this.gamestate.gameEntities[i].handleMouseMove)
      {
        this.gamestate.gameEntities[i].handleMouseMove(this.mouse_x, this.mouse_y);
      }
    }
    
    if (this.mouse_click_event)
    {
      this.mouse_click_event = false;
      for (var i = 0; i < this.gamestate.gameEntities.length; i++)
      {
        if(this.gamestate.gameEntities[i].handleMouseDown)
        {
          this.gamestate.gameEntities[i].handleMouseDown(this.mouse_click_x, this.mouse_click_y);
        }
      }
    }
  
    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if(this.gamestate.gameEntities[i].handleTimeStep)
      {
        this.gamestate.gameEntities[i].handleTimeStep(this.gamestate);
      }
    }
    
    for (var i = this.gamestate.gameEntities.length - 1; i >= 0; i--)
    {
      if(this.gamestate.gameEntities[i].active)
      {
        if(!this.gamestate.gameEntities[i].active())
        {
          this.gamestate.gameEntities.splice(i,1);
        }
      }
    }
  },
  
  //----------------------------------------------------------------------
  // from Screen
  paint: function (canvas, ctx)
  {
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    
    // paint the background
    ctx.fillStyle = "rgb(0, 0, 0)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    this.gamestate.gameEntities.sort(function(a,b){
      var a_lvl = 0;
      var b_lvl = 0;
      if(a.paintLevel)
      {
        a_lvl = a.paintLevel();
      }
      if(b.paintLevel)
      {
        b_lvl = b.paintLevel();
      }
      return a_lvl - b_lvl;
    });
    
    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if (this.gamestate.gameEntities[i].paint)
      {
        this.gamestate.gameEntities[i].paint(this.gamestate,this.layout,canvas,ctx);
      }
    }
  }
};

//------------------------------------------------------------------------
var GameScreen = {
  //----------------------------------------------------------------------
  init: function (jut)
  {
    this.jut = jut;
  },

  //----------------------------------------------------------------------
  // from Screen
  reset: function ()
  {
    //stores information about graphical layout
    this.layout = null;
    this.mouse_click_event = false;
    this.mouse_click_x = 0;
    this.mouse_click_y = 0;
    this.mouse_x = 0;
    this.mouse_y = 0;
    this.player_x = 0;
    this.player_y = 0;
    
    this.gamestate =
    {
      jut : this.jut,
      gameEntities: [],
      player: null,
      player_marker : null,
      player_radar : null,
      menu_handler: {},
      current_message: {cancel: function() {}, active: function () { return false; }},
      bottom_panel : null,
      map : [],
      radar : [],
      monsters : []
    };
    var gamestate = this.gamestate;
    
    var mainContainer = createContainer(1/150, 1/150, g_aspect_ratio - 2/150, 1 - 2/150)
    this.gamestate.gameEntities.push(mainContainer);
    var left_panel = createPanel(0, 0, 1/4, 2/3, mainContainer);
    this.gamestate.gameEntities.push(left_panel);
    var map_panel = createPanel(1/4, 0, 3/4, 2/3, mainContainer);
    map_panel.visible = true;
    this.gamestate.gameEntities.push(map_panel);
    var scan_panel = createPanel(1/4, 0, 3/4, 2/3, mainContainer);
    scan_panel.visible = false;
    this.gamestate.gameEntities.push(scan_panel);
    var hud_panel = createPanel(1/4, 0, 3/4, 2/3, mainContainer);
    hud_panel.visible = false;

    
    var bottom_panel = createPanel(0, 2/3, 1, 1/3, mainContainer);
    
    this.gamestate.bottom_panel = bottom_panel;
    this.gamestate.gameEntities.push(bottom_panel);
    
    createMap(this.gamestate, map_panel, scan_panel);
    this.gamestate.gameEntities.push(hud_panel);
    
    var hud_holder = createHudHolder(hud_panel);
    var mapSquare = this.gamestate.map[2][1];
    var unit = mapSquare.width / 5;
    var icon = createText("!", mapSquare.x + 4*unit, mapSquare.y + unit, unit*2, map_panel, "center");
    this.gamestate.gameEntities.push(icon);
    hud_holder.huds.push(createRepairHud(2,1,hud_panel,icon));
    mapSquare = this.gamestate.map[3][2];
    unit = mapSquare.width / 5;
    icon = createText("!", mapSquare.x + 4*unit, mapSquare.y + unit, unit*2, map_panel, "center");
    this.gamestate.gameEntities.push(icon);
    hud_holder.huds.push(createRepairHud(3,2,hud_panel,icon));
    mapSquare = this.gamestate.map[1][2];
    unit = mapSquare.width / 5;
    icon = createText("!", mapSquare.x + 4*unit, mapSquare.y + unit, unit*2, map_panel, "center");
    this.gamestate.gameEntities.push(icon);
    hud_holder.huds.push(createRepairHud(1,2,hud_panel,icon));
    this.gamestate.gameEntities.push(hud_holder);


    this.gamestate.gameEntities.push(createScanLine());
    this.gamestate.gameEntities.push(createDeGauss());
    this.gamestate.gameEntities.push(createLcdLines());
    var buttons = 6;
    var divisions = 2 * buttons + buttons + 1;
    var border = left_panel.height / divisions;
    var button_height = border * 2;
    
    var panels = [];
    panels.push(map_panel, scan_panel, hud_panel);
    var menu_items = [];
    
    var map_item = createMenuItems("Map", left_panel, border, left_panel.width - 2 * border,
      border, button_height)
    map_item.selected = true;
    this.gamestate.gameEntities.push(map_item);
    menu_items.push(map_item);
    
    var scan_item = createMenuItems("Scan", left_panel, border, left_panel.width - 2 * border,
      button_height + 2*border, button_height);
    this.gamestate.gameEntities.push(scan_item);
    menu_items.push(scan_item);
    
    var hud_item = createMenuItems("Hud", left_panel, border, left_panel.width - 2 * border,
      2*button_height + 3*border, button_height);
    this.gamestate.gameEntities.push(hud_item);
    menu_items.push(hud_item);
    this.gamestate.menu_handler["Map"] = function() {
      for (menu_item in menu_items)
      {
        menu_items[menu_item].selected = false;
      }
      for (panel in panels)
      {
        panels[panel].visible = false;
      }
      map_item.selected = true;
      map_panel.visible = true;
    }
    this.gamestate.menu_handler["Scan"] = function() {
      for (menu_item in menu_items)
      {
        menu_items[menu_item].selected = false;
      }
      for (panel in panels)
      {
        panels[panel].visible = false;
      }
      scan_item.selected = true;
      scan_panel.visible = true;
    }
    this.gamestate.menu_handler["Hud"] = function() {
      for (menu_item in menu_items)
      {
        menu_items[menu_item].selected = false;
      }
      for (panel in panels)
      {
        panels[panel].visible = false;
      }
      hud_item.selected = true;
      hud_panel.visible = true;
    }
    this.gamestate.gameEntities.push(createTimer(1, function() {
      gamestate.player.suggestDialogue(gamestate, "Alice", "I've marked the broken generators on the map. We need to fix them before you run out of power.");
    }));
  },

  handleMouseDown: function(event)
  {
    this.mouse_click_event = true;
    this.mouse_click_x = event.offsetX / event.currentTarget.height;
    this.mouse_click_y = event.offsetY / event.currentTarget.height;
    //event.currentTarget.width;
  },
  
  handleMouseMove: function(event)
  {
    this.mouse_x = event.offsetX / event.currentTarget.height;
    this.mouse_y = event.offsetY / event.currentTarget.height;
  },
  
  //----------------------------------------------------------------------
  // from Screen
  handleTimeStep: function ()
  {

    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if(this.gamestate.gameEntities[i].handleMouseMove)
      {
        this.gamestate.gameEntities[i].handleMouseMove(this.mouse_x, this.mouse_y);
      }
    }
    
    if (this.mouse_click_event)
    {
      this.mouse_click_event = false;
      for (var i = 0; i < this.gamestate.gameEntities.length; i++)
      {
        if(this.gamestate.gameEntities[i].handleMouseDown)
        {
          this.gamestate.gameEntities[i].handleMouseDown(this.mouse_click_x, this.mouse_click_y);
        }
      }
    }
  
    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if(this.gamestate.gameEntities[i].handleTimeStep)
      {
        this.gamestate.gameEntities[i].handleTimeStep(this.gamestate);
      }
    }
    
    for (var i = this.gamestate.gameEntities.length - 1; i >= 0; i--)
    {
      if(this.gamestate.gameEntities[i].active)
      {
        if(!this.gamestate.gameEntities[i].active())
        {
          this.gamestate.gameEntities.splice(i,1);
        }
      }
    }
  },
  
  //----------------------------------------------------------------------
  // from Screen
  paint: function (canvas, ctx)
  {
    ctx.setTransform(1, 0, 0, 1, 0, 0);
   
    // paint the background
    ctx.fillStyle = "rgb(0, 0, 0)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    this.gamestate.gameEntities.sort(function(a,b){
      var a_lvl = 0;
      var b_lvl = 0;
      if(a.paintLevel)
      {
        a_lvl = a.paintLevel();
      }
      if(b.paintLevel)
      {
        b_lvl = b.paintLevel();
      }
      return a_lvl - b_lvl;
    });
    
    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if (this.gamestate.gameEntities[i].paint)
      {
        this.gamestate.gameEntities[i].paint(this.gamestate,this.layout,canvas,ctx);
      }
    }
  }
};


var GlobalResources =
{
  audio_components : {},
  graphic_components : {}
};

var init = function()
{
  var jut = createJutGameEngine(document.getElementById("canvas"));
  
  /*
  GlobalResources.audio_components.m_bg = jut.loadAudio("Assets/Sound/CrunkKnight.mp3");
  GlobalResources.audio_components.m_move = jut.loadAudio("Assets/Sound/Bounce-SoundBible.com-12678623.mp3");
  GlobalResources.graphic_components.m_pieces = jut.loadImage("Assets/Graphics/Chess_pieces.png");
  GlobalResources.graphic_components.m_gold = jut.loadImage("Assets/Graphics/coin_gold.png");
  GlobalResources.graphic_components.key = jut.loadImage("Assets/Graphics/key2.png");
  GlobalResources.graphic_components.lock = jut.loadImage("Assets/Graphics/locked.png");
  */
  
  jut.setMaintainAspectRatioMode(g_aspect_ratio);
  jut.addTitleScreen(DemoScreen);
  GameScreen.init(jut);
  Intro.init(jut);
  Logo.init(jut);
  DemoScreen.init(jut);
  jut.init();
  
}

// launch the game once the document is fully loaded
window.addEventListener("load", init);

</script>
</body>
</html>

