<!DOCTYPE html>
<html>
<head>
    <title>Chirality</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>
<body bgcolor="#000000">
<canvas style = 'position: absolute; left: 0px; top: 0px;' id="canvas" width="1024" height="800"></canvas>
<script src="https://cdnjs.cloudflare.com/ajax/libs/buzz/1.1.10/buzz.min.js" type="text/javascript"></script>
<script src="../gameEngine/engine.js" type="text/javascript"></script>
<script src="entities.js" type="text/javascript"></script>
    
<script>
//##########################################################################
// The game
//

var g_font = "Lucida Console";
var g_aspect_ratio = 4/3;
var PHI = 1.61803398875;
var INVERSE_PHI = 0.61803398875;

//--------------------------------------------------------------------------
const Util = {

    //----------------------------------------------------------------------
    forEach: function (obj, fn)
    {
        var key;
        for (key in obj)
        {
            if (obj.hasOwnProperty(key))
            {
                fn(obj[key]);
            }
        }
    },

    //----------------------------------------------------------------------
    randomItem: function (arr)
    {
        return arr[Math.floor(Math.random() * arr.length)];
    },

    //----------------------------------------------------------------------
    shuffle: function (arr)
    {
        var current_index = arr.length, temp, random_index;
        while (0 != current_index)
        {
            // Pick a remaining element.
            random_index = Math.floor(Math.random() * current_index);
            current_index -= 1;

            // And swap it with the current element.
            temp = arr[current_index];
            arr[current_index] = arr[random_index];
            arr[random_index] = temp;
        }
        return arr;
    }
};

//##########################################################################

const Logo = {
  init: function (jut)
  {
    this.jut = jut;
  },
  
  reset: function ()
  {
    this.loadTimer = 0;
    this.textTimerLimit = 40;
    this.textTimer = 0;
    this.textFadeInTimerLimit = 100;
    this.textFadeInTimer = 0;
    this.cursorTimer = 0;
    this.scanline=0;
    this.polarity = 1;
    this.bounce=30;
  },
  
  handleTimeStep: function ()
  {
    if (this.loadTimer < 99)
    {
      this.loadTimer+=1;
    }
    else
    {
      this.polarity = -10;
      this.textFadeInTimer += this.polarity
    }

    if (this.textTimer < this.textTimerLimit)
    {
      this.textTimer++;
    }
    
    
    if (this.textFadeInTimer < this.textFadeInTimerLimit)
    {
      this.textFadeInTimer += this.polarity;
      if (this.textFadeInTimer <= 0)
      {
        this.jut.switchToScreen(Intro);
      }
    }

    this.scanline+=5;
    this.cursorTimer++;
    if (this.bounce > 0)
    {
      this.bounce-=3;
    }
    else
    {
      if (Math.random() < .01 || this.polarity < 0)
      {
        this.bounce = 30;
      }
    }
  },
  
  paint: function (canvas, ctx)
  {
   //this.otherScreen.paint();
    ctx.setTransform(1, 0, 0, 1, 0, 0);

    // paint the background
    ctx.fillStyle = "rgba(0,0,0)";
    ctx.fillRect(
      0, 0,
      canvas.width,
      canvas.height);

    var text_size = Math.round(canvas.height / 6);
    var game_over = "VelociGames";
    var jitter = Math.random() * text_size / 30 - text_size / 60;
    var text = game_over.substring(0, Math.round(this.textTimer / this.textTimerLimit * game_over.length));
      
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.shadowOffsetX = canvas.width;
    ctx.shadowOffsetY = 0;
    
    ctx.shadowColor = "rgba(0,128,0," + (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";

    ctx.font = text_size * 2 + "px " + g_font;
    ctx.shadowBlur = Math.round(text_size / 4);
    
    var load_text = "" + Math.round(this.loadTimer) + "%"
    if (Math.random() < .01)
    {
      ctx.shadowColor = "rgba(0,64,0," + (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
    }
    ctx.fillText(load_text, -canvas.width + canvas.width / 2 + jitter, canvas.height / 2);
    
    ctx.font = text_size + "px " + g_font;
    ctx.textAlign = "left";
    var textWidth = ctx.measureText(text + "_").width;
    if (Math.floor(this.cursorTimer / 10) % 2)
    {
      text += "_"
    }
    else
    {
      text += " ";
    }
    var textPosition = Math.round(canvas.width / 2 - textWidth / 2);
    
    ctx.shadowColor = "rgba(0,192,0," + (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
    ctx.shadowBlur = Math.round(text_size * 2 / 3);
    ctx.fillText(text, -canvas.width + textPosition + jitter, canvas.height / 2);
    ctx.shadowBlur = Math.round(text_size / 3);
    ctx.fillText(text, -canvas.width + textPosition + jitter, canvas.height / 2);
    //ctx.shadowColor = "rgba(0,255,0," + (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
    ctx.shadowBlur = 1;
    //ctx.fillStyle = "rgba(0,0,0," + .75 * (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
    ctx.fillText(text, -canvas.width + textPosition, canvas.height / 2);
    //ctx.fillText(text, canvas.width / 2, canvas.height / 2);
    ctx.lineWidth = Math.max(1, Math.round(canvas.height/400));
    ctx.strokeStyle = "rgba(0,0,0," + .25 * (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
    if(this.scanline > canvas.height * 3 / 4)
    {
      this.scanline=canvas.height/4;
    }
    ctx.putImageData(ctx.getImageData(0,Math.round(this.scanline), canvas.width, ctx.lineWidth*2), -3, Math.round(this.scanline));
    if (this.bounce > 0)
    {
    var current_bounce = Math.random()*this.bounce - this.bounce/2;
    for(var y = 0; y < canvas.width; y+=ctx.lineWidth*2)
    {
      current_bounce += Math.random()*this.bounce - this.bounce/2;
      ctx.putImageData(ctx.getImageData(0,y, canvas.width, ctx.lineWidth*2), current_bounce, y);
    }
    }
    
    for(var y = 0; y < canvas.height; y+=2*ctx.lineWidth)
    {
      ctx.beginPath();
      ctx.moveTo(0,y);
      ctx.lineTo(canvas.width,y);
      ctx.stroke();
    }
  }
};

//------------------------------------------------------------------------
var Intro = {
  init: function (jut)
  {
    this.jut = jut;
  },
  reset: function ()
  {
    this.gamestate = 
    {
      gameEntities : [],
      game_events : createScriptedEvent()
    };
    var mainContainer = createContainer(1/150, 1/150, g_aspect_ratio - 2/150, 1 - 2/150);
    this.gamestate.gameEntities.push(mainContainer);
    var bg_container = createContainer(0,0,g_aspect_ratio,1);
    this.gamestate.gameEntities.push(bg_container);
    var console = createTerminal(0,0,g_aspect_ratio, 1, bg_container);
    console.addTypingText("");
    this.gamestate.gameEntities.push(console);
    var game_events = this.gamestate.game_events;
    var intro_screen = this;
    
    game_events.push(createTimer(40, function() {
      console.clear();
      console.addTypingText("rift activity detected");
    }));
    game_events.push(createConditionalEvent(function () { return console.completed(); }, 
      function () {}));
    game_events.push(createTimer(80, function () { 
      console.clear();
      console.addTypingText("");
    }));
    game_events.push(createTimer(40, function () {
      console.clear();
      console.addTypingText("starting primary systems");
    }));
    game_events.push(createConditionalEvent(function () { return console.completed(); }, 
      function () {}));
    game_events.push(createTimer(80, function () { 
      console.clear();
      console.addTypingText("");
    }));
    game_events.push(createTimer(40, function () {
      console.clear();
      console.addTypingText("WARNING: multiple system failures detected");
    }));
    game_events.push(createConditionalEvent(function () { return console.completed(); }, 
      function () {}));
    game_events.push(createTimer(40, function () { 
      console.addBlankLine("");
      console.addBlankLine("");
      console.addTypingText("main power generators           OFFLINE"); 
      console.addTypingText("emergency power supply           online"); 
      console.addTypingText("cognitive engine                 online");
      console.addTypingText("speech recoginition interface    online");
      console.addTypingText("language synthesis              OFFLINE");
      console.addTypingText("remote uplink                    online");
      console.addTypingText("environment monitor             OFFLINE");
    }));
    
    game_events.push(createConditionalEvent(function () { return console.completed(); }, 
      function () {}));
    game_events.push(createTimer(80, function () { 
      var mainContainer = createContainer(1/150, 1/150, g_aspect_ratio - 2/150, 1 - 2/150)
      intro_screen.gamestate.gameEntities.push(mainContainer);
      intro_screen.gamestate.bottom_panel = createPanel(0, 2/3, 1, 1/3, mainContainer);
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.bottom_panel);
      intro_screen.gamestate.degauss.bounce = 1;
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "incoming message...", "")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
    }));

    game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
      console.clear();
      console.addTypingText("");
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "Unknown Sender", "I'm ... stepping through the ... now... Preparing for ...")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
    }));
    game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
      console.clear();
      console.addTypingText("rift breach imminent");
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "Unknown Sender", "... about ... to cross ... barrier ...")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
    }));
    game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {}));
    game_events.push(createTimer(25, function () {
      console.clear();
      console.addTypingText("");
    }));
    game_events.push(createTimer(25, function () {
      console.clear();
      console.addTypingText("rift breached");
    }));
    game_events.push(createTimerLoop(15, function () {
      intro_screen.gamestate.degauss.bounce = 10;
    }));
    game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "Unknown Sender", "I'm through! Computer, this is Alice, I'm trying to uplink to you now.")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
    }));
    game_events.push(createTimer(50, function () {
      console.clear();
      console.addTypingText("remote uplink detected");
    }));
    game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "Alice", "I'm connected! Computer, are you there?")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
    }));
    game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "Alice", "Computer!? Are you there?")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
      console.clear();
      console.addTypingText("");
    }));
    game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "Alice", "Computer, if you can here me, I'm about to run a remote diagnostic on you.")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
      console.clear();
      console.addTypingText("");
    }));
    game_events.push(createTimer(50, function () {
      console.clear();
      console.addTypingText("remote diagnostic initiated");
    }));
    game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "Alice", "What happened to you?!")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
      console.clear();
      console.addTypingText("");
    }));
    game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "Alice", "Thank God, your primary cognitive functions are intact.")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
    }));
    game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "Alice", "That's a good start, I wasn't looking forward to freezing to death out here in the dark.")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
    }));
    game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "Alice", "Alright, I've got to get your main power restored, otherwise we're never going to be able to open the rift back home.")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
    }));
    game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "Alice", "My suit is showing a broken power relay a little north of here. I might be able to fix it I can get there.")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
    }));
    
    game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "Alice", "OK, I know the remote probes showed this place was dark, but it is pitch black out here. I'm going to patch you into my suit's navigation. Hold on.")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
    }));
    game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
      console.clear();
      console.addTypingText("remote transfer protocol intiated");
    }));
    game_events.push(createTimer(75, function () {
      console.clear();
      intro_screen.gamestate.degauss.bounce = 10;
      
      var left_panel = createPanel(0, 0, 1/4, 2/3, mainContainer);
      intro_screen.gamestate.gameEntities.push(left_panel);
      var map_panel = createPanel(1/4, 0, 3/4, 2/3, mainContainer);
      map_panel.visible = true;
      intro_screen.gamestate.gameEntities.push(map_panel);
      var buttons = 6;
      var divisions = 2 * buttons + buttons + 1;
      var border = left_panel.height / divisions;
      var button_height = border * 2;

      var map_item = createMenuItems("Map", left_panel, border, left_panel.width - 2 * border,
      border, button_height)
      map_item.selected = true;
      intro_screen.gamestate.gameEntities.push(map_item);
    }));
    game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "Alice", "Let me load up the map of the local area. Give me a second.")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
    }));
    
    //GAME TIME!
    game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
    }));
    game_events.push(createTimer(50, function () {
      intro_screen.jut.switchToScreen(GameScreen);
    }));
    
    game_events.start(this.gamestate);
    this.gamestate.gameEntities.push(game_events);
    this.gamestate.degauss = createDeGauss();
    this.gamestate.gameEntities.push(this.gamestate.degauss);
    this.gamestate.gameEntities.push(createLcdLines());
    this.gamestate.gameEntities.push(createScanLine());
  },
  handleTimeStep: function ()
  {    
    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if(this.gamestate.gameEntities[i].handleTimeStep)
      {
        this.gamestate.gameEntities[i].handleTimeStep(this.gamestate);
      }
    }
    
    for (var i = this.gamestate.gameEntities.length - 1; i >= 0; i--)
    {
      if(this.gamestate.gameEntities[i].active)
      {
        if(!this.gamestate.gameEntities[i].active())
        {
          this.gamestate.gameEntities.splice(i,1);
        }
      }
    }
  },
  paint: function (canvas, ctx)
  {
    ctx.setTransform(1, 0, 0, 1, 0, 0);
   
    // paint the background
    ctx.fillStyle = "rgb(0, 0, 0)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    this.gamestate.gameEntities.sort(function(a,b){
      var a_lvl = 0;
      var b_lvl = 0;
      if(a.paintLevel)
      {
        a_lvl = a.paintLevel();
      }
      if(b.paintLevel)
      {
        b_lvl = b.paintLevel();
      }
      return a_lvl - b_lvl;
    });
    
    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if (this.gamestate.gameEntities[i].paint)
      {
        this.gamestate.gameEntities[i].paint(this.gamestate,canvas,ctx);
      }
    }
  }
};

//------------------------------------------------------------------------
var DemoScreen = {
  //----------------------------------------------------------------------
  init: function (jut)
  {
    this.jut = jut;
  },

  //----------------------------------------------------------------------
  // from Screen
  reset: function ()
  {
    this.mouse_click_event = false;
    this.mouse_click_x = 0;
    this.mouse_click_y = 0;
    this.mouse_x = 0;
    this.mouse_y = 0;
    this.player_x = 0;
    this.player_y = 0;
    
    this.gamestate =
    {
      jut : this.jut,
      gameEntities: [],
      menu_handler: {},
    };
    var titleContainer = createContainer(0, 1/4, g_aspect_ratio, 1/4)
    //this.gamestate.gameEntities.push(createPanel(0,0,1,1,titleContainer));
    this.gamestate.gameEntities.push(titleContainer);
    var text = createText("chirality", titleContainer.width/2, titleContainer.height/2, 1/4 * INVERSE_PHI, titleContainer, "center");
    this.gamestate.gameEntities.push(text);
    var menuContainer = createContainer(1/4 * g_aspect_ratio, 1/2, 1/2 * g_aspect_ratio, 2/8);
    var demoContainer = createContainer(3/4 * g_aspect_ratio, 15/16, 1/4 * g_aspect_ratio, 1/16);
    this.gamestate.gameEntities.push(createText("demo v0.0 ", demoContainer.width, demoContainer.height/2, demoContainer.height * INVERSE_PHI, demoContainer, "right"));
    var demoContainer2 = createContainer(0, 15/16, 1/4 * g_aspect_ratio, 1/16);
    this.gamestate.gameEntities.push(createText(" VelociGames", 0, demoContainer2.height/2, demoContainer2.height * INVERSE_PHI, demoContainer2, "left"));

    this.gamestate.gameEntities.push(menuContainer);
    this.gamestate.gameEntities.push(createScanLine());
    this.gamestate.gameEntities.push(createDeGauss());
    this.gamestate.gameEntities.push(createLcdLines());
    var buttons = 2;
    var divisions = 2 * buttons + buttons + 1;
    var border = menuContainer.height / divisions;
    var button_height = border * 2;
    var map_item = createMenuItems("Introduction", menuContainer, 0, menuContainer.width,
      border, button_height)
    this.gamestate.gameEntities.push(map_item);
    var scan_item = createMenuItems("Game Screen", menuContainer, 0, menuContainer.width,
      button_height + 2*border, button_height);
    this.gamestate.gameEntities.push(scan_item);
    var jut = this.jut;
    this.gamestate.menu_handler["Introduction"] = function() {
      jut.switchToScreen(Logo);
    }
    this.gamestate.menu_handler["Game Screen"] = function() {
      jut.switchToScreen(GameScreen);
    }
  },

  handleMouseDown: function(event)
  {
    this.mouse_click_event = true;
    this.mouse_click_x = event.offsetX / event.currentTarget.height;
    this.mouse_click_y = event.offsetY / event.currentTarget.height;
  },
  
  handleMouseMove: function(event)
  {
    this.mouse_x = event.offsetX / event.currentTarget.height;
    this.mouse_y = event.offsetY / event.currentTarget.height;
  },
  
  //----------------------------------------------------------------------
  // from Screen
  handleTimeStep: function ()
  {

    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if(this.gamestate.gameEntities[i].handleMouseMove)
      {
        this.gamestate.gameEntities[i].handleMouseMove(this.mouse_x, this.mouse_y);
      }
    }
    
    if (this.mouse_click_event)
    {
      this.mouse_click_event = false;
      for (var i = 0; i < this.gamestate.gameEntities.length; i++)
      {
        if(this.gamestate.gameEntities[i].handleMouseDown)
        {
          this.gamestate.gameEntities[i].handleMouseDown(this.mouse_click_x, this.mouse_click_y);
        }
      }
    }
  
    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if(this.gamestate.gameEntities[i].handleTimeStep)
      {
        this.gamestate.gameEntities[i].handleTimeStep(this.gamestate);
      }
    }
    
    for (var i = this.gamestate.gameEntities.length - 1; i >= 0; i--)
    {
      if(this.gamestate.gameEntities[i].active)
      {
        if(!this.gamestate.gameEntities[i].active())
        {
          this.gamestate.gameEntities.splice(i,1);
        }
      }
    }
  },
  
  //----------------------------------------------------------------------
  // from Screen
  paint: function (canvas, ctx)
  {
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    
    // paint the background
    ctx.fillStyle = "rgb(0, 0, 0)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    this.gamestate.gameEntities.sort(function(a,b){
      var a_lvl = 0;
      var b_lvl = 0;
      if(a.paintLevel)
      {
        a_lvl = a.paintLevel();
      }
      if(b.paintLevel)
      {
        b_lvl = b.paintLevel();
      }
      return a_lvl - b_lvl;
    });
    
    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if (this.gamestate.gameEntities[i].paint)
      {
        this.gamestate.gameEntities[i].paint(this.gamestate,canvas,ctx);
      }
    }
  }
};

//------------------------------------------------------------------------
var GameScreen = {
  //----------------------------------------------------------------------
  init: function (jut)
  {
    this.jut = jut;
  },

  //----------------------------------------------------------------------
  // from Screen
  reset: function ()
  {
    this.mouse_click_event = false;
    this.mouse_click_x = 0;
    this.mouse_click_y = 0;
    this.mouse_x = 0;
    this.mouse_y = 0;
    this.player_x = 0;
    this.player_y = 0;
    
    this.gamestate =
    {
      jut : this.jut,
      gameEntities: [],
      player: null,
      player_marker : null,
      script : createScriptedEvent(),
      player_radar : null,
      menu_handler: {},
      current_message: {cancel: function() {}, active: function () { return false; }},
      bottom_panel : null,
      map : [],
      radar : [],
      monsters : [],
      objectives : []
    };
    var gamestate = this.gamestate;
    var script = gamestate.script;
    
    var mainContainer = createContainer(1/150, 1/150, g_aspect_ratio - 2/150, 1 - 2/150);
    gamestate.gameEntities.push(mainContainer);
    var left_panel = createPanel(0, 0, 1/4, 2/3, mainContainer);
    gamestate.gameEntities.push(left_panel);
    var map_panel = createPanel(1/4, 0, 3/4, 2/3, mainContainer);
    map_panel.visible = true;
    gamestate.gameEntities.push(map_panel);
    var scan_panel = createPanel(1/4, 0, 3/4, 2/3, mainContainer);
    scan_panel.visible = false;
    gamestate.gameEntities.push(scan_panel);
    var hud_panel = createPanel(1/4, 0, 3/4, 2/3, mainContainer);
    hud_panel.visible = false;
    
    var bottom_panel = createPanel(0, 2/3, 1, 1/3, mainContainer);
    
    gamestate.bottom_panel = bottom_panel;
    gamestate.gameEntities.push(bottom_panel);
    
    createMap(gamestate, map_panel, scan_panel);
    gamestate.gameEntities.push(hud_panel);
    
    var hud_holder = createHudHolder(hud_panel);
    gamestate.gameEntities.push(hud_holder);

    gamestate.gameEntities.push(createScanLine());
    gamestate.gameEntities.push(createDeGauss());
    gamestate.gameEntities.push(createLcdLines());
    var buttons = 6;
    var divisions = 2 * buttons + buttons + 1;
    var border = left_panel.height / divisions;
    var button_height = border * 2;
    
    var panels = [];
    panels.push(map_panel, scan_panel, hud_panel);
    var menu_items = [];
    
    var map_item = createMenuItems("Map", left_panel, border, left_panel.width - 2 * border,
      border, button_height)
    map_item.selected = true;
    gamestate.gameEntities.push(map_item);
    menu_items.push(map_item);
    
    var hud_item = createMenuItems("Hud", left_panel, border, left_panel.width - 2 * border,
      2*button_height + 3*border, button_height);
      menu_items.push(hud_item);
    
    var scan_item = createMenuItems("Scan", left_panel, border, left_panel.width - 2 * border,
      button_height + 2*border, button_height);
    menu_items.push(scan_item);
    
    var mapSquare = gamestate.map[1][3];
    var scanSquare = gamestate.map[1][3];
    gamestate.player_marker = createPlayerIcon(mapSquare, map_panel);
    gamestate.player_radar = createMonsterIcon(scanSquare, scan_panel);
    gamestate.player = createPlayer(mapSquare);
    
    gamestate.player.importantDialogue(gamestate, "Alice", "Good, looks like the rift opened up right where we wanted it to. It looks like we're in the main courtyard.");
    script.push(createConditionalEvent(
      function () {
        return !gamestate.current_message.active();
      },
      function () 
      {
        gamestate.player.importantDialogue(gamestate, "Alice", "Let me turn on my location beacon so you can see me.");
      }
    ));
    script.push(createConditionalEvent(
      function () {
        return !gamestate.current_message.active();
      },
      function () 
      {
        gamestate.gameEntities.push(gamestate.player_marker);
        gamestate.gameEntities.push(gamestate.player_radar);
        gamestate.player.importantDialogue(gamestate, "Alice", "There.");
      }
    ));
    script.push(createConditionalEvent(
      function () {
        return !gamestate.current_message.active();
      },
      function () 
      {
        gamestate.player.importantDialogue(gamestate, "Alice", "Let me mark the location where my suit shows the power signal.");
      }
    ));
    script.push(createConditionalEvent(
      function () {
        return !gamestate.current_message.active();
      },
      function () 
      {
        var mapSquare = gamestate.map[0][0];
        var scanSquare = gamestate.map[0][0];
        var unit = mapSquare.width / 5;
        var icon = createText("!", mapSquare.x + 4*unit, mapSquare.y + unit, unit*2*INVERSE_PHI, map_panel, "center");
        gamestate.gameEntities.push(icon);
        gamestate.objectives.push(icon);
        hud_holder.huds.push(createRepairHud(0,0,hud_panel,icon));
        gamestate.player.importantDialogue(gamestate, "Alice", "Perfect.");
      }
    ));
    script.push(createConditionalEvent(
      function () {
        return !gamestate.current_message.active();
      },
      function () 
      {
        gamestate.player.importantDialogue(gamestate, "Alice", "Now you should be able to navigate me up there.");
        gamestate.player.state = gamestate.player.WAITING_STATE;
      }
    ));
    script.push(createConditionalEvent(
      function () {
        return gamestate.player.current_location === gamestate.map[0][0];
      },
      function () 
      {
        gamestate.player.importantDialogue(gamestate, "Alice", "Ok, I see the broken power conduit. My God, what happened here, the whole things seems torn open.");
        gamestate.player.state = gamestate.player.INITIAL_STATE;
      }
    ));
    script.push(createConditionalEvent(
      function () {
        return gamestate.player.current_location === gamestate.map[0][0];
      },
      function () 
      {
        gamestate.player.importantDialogue(gamestate, "Alice", "This looks like it's the entrance to your central power systems. We'll need to restore auxilary power and fix this conduit to get in.");
        gamestate.player.state = gamestate.player.INITIAL_STATE;
      }
    ));
    script.push(createConditionalEvent(
      function () {
        return !gamestate.current_message.active();
      },
      function () 
      {
        gamestate.player.importantDialogue(gamestate, "Alice", "Alright, so I've got no idea how to fix this.");
        gamestate.player.state = gamestate.player.WAITING_STATE;
      }
    ));
    script.push(createConditionalEvent(
      function () {
        return !gamestate.current_message.active();
      },
      function () 
      {
        gamestate.player.importantDialogue(gamestate, "Alice", "But, with your help I bet we could repair this. I'm going to patch you into my head's up display. You should be able to guide me through the repairs that way.");
      }
    ));
    script.push(createConditionalEvent(
      function () {
        return !gamestate.current_message.active();
      },
      function () 
      {
        gamestate.player.importantDialogue(gamestate, "Alice", "Let's do this, then.");
        gamestate.player.state = gamestate.player.WAITING_STATE;
        gamestate.gameEntities.push(hud_item);
      }
    ));
    script.push(createConditionalEvent(
      function () {
        var count = 0;
        for (objective in gamestate.objectives)
        {
          if (gamestate.objectives[objective].active())
          {
            count++;
          }
        };
        return count === 0;
      },
      function () 
      {
        gamestate.player.importantDialogue(gamestate, "Alice", "There should be some auxilary generators out here that we can use to get the facility door open. Let me look them up.");
        gamestate.player.state = gamestate.player.INITIAL_STATE;
      }
    ));
    script.push(createConditionalEvent(
      function () {
        return !gamestate.current_message.active();
      },
      function () 
      {
        gamestate.player.importantDialogue(gamestate, "Alice", "I've marked the broken generators on the map. We need to fix them before you run out of power.");
    
        gamestate.objectives = [];
        var mapSquare = gamestate.map[2][1];
        var unit = mapSquare.width / 5;
        var icon = createText("!", mapSquare.x + 4*unit, mapSquare.y + unit, unit*2*INVERSE_PHI, map_panel, "center");
        gamestate.gameEntities.push(icon);
        gamestate.objectives.push(icon);
        hud_holder.huds.push(createRepairHud(2,1,hud_panel,icon));
        mapSquare = gamestate.map[3][2];
        unit = mapSquare.width / 5;
        icon = createText("!", mapSquare.x + 4*unit, mapSquare.y + unit, unit*2*INVERSE_PHI, map_panel, "center");
        gamestate.gameEntities.push(icon);
        gamestate.objectives.push(icon);
        hud_holder.huds.push(createRepairHud(3,2,hud_panel,icon));
        mapSquare = gamestate.map[1][2];
        unit = mapSquare.width / 5;
        icon = createText("!", mapSquare.x + 4*unit, mapSquare.y + unit, unit*2*INVERSE_PHI, map_panel, "center");
        gamestate.gameEntities.push(icon);
        gamestate.objectives.push(icon);
        hud_holder.huds.push(createRepairHud(1,2,hud_panel,icon));
      }
    ));
    script.push(createConditionalEvent(
      function () {
        return !gamestate.current_message.active();
      },
      function () 
      {
        gamestate.player.importantDialogue(gamestate, "Alice", "By the way, good news, repairing the power conduit seems to have restored your motion scanners.");
    
        gamestate.gameEntities.push(scan_item);
        gamestate.player.state = gamestate.player.INITIAL_STATE;
        var mapSquare = gamestate.map[0][3];
        var monster_icon = createMonsterIcon(scanSquare, scan_panel);
        var monster = createMonster(mapSquare, monster_icon);
        gamestate.gameEntities.push(monster_icon);
        gamestate.gameEntities.push(monster);
        gamestate.monsters.push(monster);
        mapSquare = gamestate.map[3][3];
        monster_icon = createMonsterIcon(scanSquare, scan_panel);
        monster = createMonster(mapSquare, monster_icon);
        gamestate.gameEntities.push(monster_icon);
        gamestate.gameEntities.push(monster);
        gamestate.monsters.push(monster);
        gamestate.player.state = gamestate.player.WAITING_STATE;
      }
    ));
    script.push(createConditionalEvent(
      function () {
        var count = 0;
        for (objective in gamestate.objectives)
        {
          if (gamestate.objectives[objective].active())
          {
            count++;
          }
        };
        return count === 2;
      },
      function () 
      {
        gamestate.player.importantDialogue(gamestate, "Alice", "That's fixed, two more to go.");
      }
    ));
    
    script.push(createConditionalEvent(
      function () {
        var count = 0;
        for (objective in gamestate.objectives)
        {
          if (gamestate.objectives[objective].active())
          {
            count++;
          }
        };
        return count === 1;
      },
      function () 
      {
        gamestate.player.importantDialogue(gamestate, "Alice", "Get me to the last generator and I can get out of here.");
      }
    ));
    
    script.push(createConditionalEvent(
      function () {
        var count = 0;
        for (objective in gamestate.objectives)
        {
          if (gamestate.objectives[objective].active())
          {
            count++;
          }
        };
        return count === 0;
      },
      function ()
      {
        gamestate.player.importantDialogue(gamestate, "Alice", "That's the last generator. You should have enough power to open the door.");
        var mapSquare = gamestate.map[0][0];
        var scanSquare = gamestate.map[0][0];
        var unit = mapSquare.width / 5;
        gamestate.objectives = [];
        var icon = createText("!", mapSquare.x + 4*unit, mapSquare.y + unit, unit*2*INVERSE_PHI, map_panel, "center");
        gamestate.gameEntities.push(icon);
        gamestate.objectives.push(icon);
        hud_holder.huds.push(createRepairHud(0,0,hud_panel,icon));
        var monster_icon = createMonsterIcon(scanSquare, scan_panel);
        var monster = createMonster(mapSquare, monster_icon);
        gamestate.gameEntities.push(monster_icon);
        gamestate.gameEntities.push(monster);
        gamestate.monsters.push(monster);
      }
    ));
    script.push(createConditionalEvent(
      function () {
        var count = 0;
        for (objective in gamestate.objectives)
        {
          if (gamestate.objectives[objective].active())
          {
            count++;
          }
        };
        return count === 0;
      },
      function () 
      {
        gamestate.player_marker.cancel();
        gamestate.player_radar.cancel();
        for (monster in gamestate.monsters)
        {
          gamestate.monsters[monster].cancel();
        }
        gamestate.player.importantDialogue(gamestate, "Alice", "I've made it!");
        var message = gamestate.current_message;
        gamestate.gameEntities.push(createConditionalEvent(
          function () {
            return !message.active();
          },
          function () {
            gamestate.gameEntities.push(createDeathVeil());
          }
        ));
      }
    ));
    
    gamestate.gameEntities.push(gamestate.player);
    gamestate.gameEntities.push(script);
    script.start(gamestate);
        
    gamestate.menu_handler["Map"] = function() {
      for (menu_item in menu_items)
      {
        menu_items[menu_item].selected = false;
      }
      for (panel in panels)
      {
        panels[panel].visible = false;
      }
      map_item.selected = true;
      map_panel.visible = true;
    };
    gamestate.menu_handler["Scan"] = function() {
      for (menu_item in menu_items)
      {
        menu_items[menu_item].selected = false;
      }
      for (panel in panels)
      {
        panels[panel].visible = false;
      }
      scan_item.selected = true;
      scan_panel.visible = true;
    };
    gamestate.menu_handler["Hud"] = function() {
      for (menu_item in menu_items)
      {
        menu_items[menu_item].selected = false;
      }
      for (panel in panels)
      {
        panels[panel].visible = false;
      }
      hud_item.selected = true;
      hud_panel.visible = true;
    };

  },

  handleMouseDown: function(event)
  {
    this.mouse_click_event = true;
    this.mouse_click_x = event.offsetX / event.currentTarget.height;
    this.mouse_click_y = event.offsetY / event.currentTarget.height;
    //event.currentTarget.width;
  },
  
  handleMouseMove: function(event)
  {
    this.mouse_x = event.offsetX / event.currentTarget.height;
    this.mouse_y = event.offsetY / event.currentTarget.height;
  },
  
  //----------------------------------------------------------------------
  // from Screen
  handleTimeStep: function ()
  {

    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if(this.gamestate.gameEntities[i].handleMouseMove)
      {
        this.gamestate.gameEntities[i].handleMouseMove(this.mouse_x, this.mouse_y);
      }
    }
    
    if (this.mouse_click_event)
    {
      this.mouse_click_event = false;
      for (var i = 0; i < this.gamestate.gameEntities.length; i++)
      {
        if(this.gamestate.gameEntities[i].handleMouseDown)
        {
          this.gamestate.gameEntities[i].handleMouseDown(this.mouse_click_x, this.mouse_click_y);
        }
      }
    }
  
    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if(this.gamestate.gameEntities[i].handleTimeStep)
      {
        this.gamestate.gameEntities[i].handleTimeStep(this.gamestate);
      }
    }
    
    for (var i = this.gamestate.gameEntities.length - 1; i >= 0; i--)
    {
      if(this.gamestate.gameEntities[i].active)
      {
        if(!this.gamestate.gameEntities[i].active())
        {
          this.gamestate.gameEntities.splice(i,1);
        }
      }
    }
  },
  
  //----------------------------------------------------------------------
  // from Screen
  paint: function (canvas, ctx)
  {
    ctx.setTransform(1, 0, 0, 1, 0, 0);
   
    // paint the background
    ctx.fillStyle = "rgb(0, 0, 0)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    this.gamestate.gameEntities.sort(function(a,b){
      var a_lvl = 0;
      var b_lvl = 0;
      if(a.paintLevel)
      {
        a_lvl = a.paintLevel();
      }
      if(b.paintLevel)
      {
        b_lvl = b.paintLevel();
      }
      return a_lvl - b_lvl;
    });
    
    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if (this.gamestate.gameEntities[i].paint)
      {
        this.gamestate.gameEntities[i].paint(this.gamestate,canvas,ctx);
      }
    }
  }
};

var GlobalResources =
{
  audio_components : {},
  graphic_components : {}
};

var init = function()
{
  var jut = createJutGameEngine(document.getElementById("canvas"));
  
  /*
  GlobalResources.audio_components.m_bg = jut.loadAudio("Assets/Sound/CrunkKnight.mp3");
  GlobalResources.audio_components.m_move = jut.loadAudio("Assets/Sound/Bounce-SoundBible.com-12678623.mp3");
  GlobalResources.graphic_components.m_pieces = jut.loadImage("Assets/Graphics/Chess_pieces.png");
  GlobalResources.graphic_components.m_gold = jut.loadImage("Assets/Graphics/coin_gold.png");
  GlobalResources.graphic_components.key = jut.loadImage("Assets/Graphics/key2.png");
  GlobalResources.graphic_components.lock = jut.loadImage("Assets/Graphics/locked.png");
  */
  
  jut.setMaintainAspectRatioMode(g_aspect_ratio);
  jut.addTitleScreen(DemoScreen);
  GameScreen.init(jut);
  Intro.init(jut);
  Logo.init(jut);
  DemoScreen.init(jut);
  jut.init();
  
}

// launch the game once the document is fully loaded
window.addEventListener("load", init);

</script>
</body>
</html>

