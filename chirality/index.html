<!DOCTYPE html>
<html>
<head>
    <title>Chirality</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>
<body bgcolor="#000000">
<canvas style = 'position: absolute; left: 0px; top: 0px;' id="canvas" width="1024" height="800"></canvas>
<script src="https://cdnjs.cloudflare.com/ajax/libs/buzz/1.1.10/buzz.min.js" type="text/javascript"></script>
<script src="../gameEngine/engine.js" type="text/javascript"></script>
    
<script>
//##########################################################################
// The game
//

var g_font = "Lucida Console";
var g_aspect_ratio = 4/3;
var PHI = 1.61803398875;
var INVERSE_PHI = 0.61803398875;

//--------------------------------------------------------------------------
const Util = {

    //----------------------------------------------------------------------
    forEach: function (obj, fn)
    {
        var key;
        for (key in obj)
        {
            if (obj.hasOwnProperty(key))
            {
                fn(obj[key]);
            }
        }
    },

    //----------------------------------------------------------------------
    randomItem: function (arr)
    {
        return arr[Math.floor(Math.random() * arr.length)];
    },

    //----------------------------------------------------------------------
    shuffle: function (arr)
    {
        var current_index = arr.length, temp, random_index;
        while (0 != current_index)
        {
            // Pick a remaining element.
            random_index = Math.floor(Math.random() * current_index);
            current_index -= 1;

            // And swap it with the current element.
            temp = arr[current_index];
            arr[current_index] = arr[random_index];
            arr[random_index] = temp;
        }
        return arr;
    }
};

//##########################################################################

const Logo = {
  init: function (jut)
  {
    this.jut = jut;
  },
  
  reset: function ()
  {
    this.loadTimer = 0;
    this.textTimerLimit = 40;
    this.textTimer = 0;
    this.textFadeInTimerLimit = 100;
    this.textFadeInTimer = 0;
    this.cursorTimer = 0;
    this.scanline=0;
    this.polarity = 1;
    this.bounce=30;
  },
  
  handleTimeStep: function ()
  {
    if (this.loadTimer < 99)
    {
      this.loadTimer+=1;
    }
    else
    {
      this.polarity = -10;
      this.textFadeInTimer += this.polarity
    }

    if (this.textTimer < this.textTimerLimit)
    {
      this.textTimer++;
    }
    
    
    if (this.textFadeInTimer < this.textFadeInTimerLimit)
    {
      this.textFadeInTimer += this.polarity;
      if (this.textFadeInTimer <= 0)
      {
        this.jut.switchToScreen(Intro);
      }
    }

    this.scanline+=5;
    this.cursorTimer++;
    if (this.bounce > 0)
    {
      this.bounce-=3;
    }
    else
    {
      if (Math.random() < .01 || this.polarity < 0)
      {
        this.bounce = 30;
      }
    }
  },
  
  paint: function (canvas, ctx)
  {
   //this.otherScreen.paint();
    ctx.setTransform(1, 0, 0, 1, 0, 0);

    // paint the background
    ctx.fillStyle = "rgba(0,0,0)";
    ctx.fillRect(
      0, 0,
      canvas.width,
      canvas.height);

    var text_size = Math.round(canvas.height / 6);
    var game_over = "VelociGames";
    var jitter = Math.random() * text_size / 30 - text_size / 60;
    var text = game_over.substring(0, Math.round(this.textTimer / this.textTimerLimit * game_over.length));
      
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.shadowOffsetX = canvas.width;
    ctx.shadowOffsetY = 0;
    
    ctx.shadowColor = "rgba(0,128,0," + (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";

    ctx.font = text_size * 2 + "px " + g_font;
    ctx.shadowBlur = Math.round(text_size / 4);
    
    var load_text = "" + Math.round(this.loadTimer) + "%"
    if (Math.random() < .01)
    {
      ctx.shadowColor = "rgba(0,64,0," + (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
    }
    ctx.fillText(load_text, -canvas.width + canvas.width / 2 + jitter, canvas.height / 2);
    
    ctx.font = text_size + "px " + g_font;
    ctx.textAlign = "left";
    var textWidth = ctx.measureText(text + "_").width;
    if (Math.floor(this.cursorTimer / 10) % 2)
    {
      text += "_"
    }
    else
    {
      text += " ";
    }
    var textPosition = Math.round(canvas.width / 2 - textWidth / 2);
    
    ctx.shadowColor = "rgba(0,192,0," + (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
    ctx.shadowBlur = Math.round(text_size * 2 / 3);
    ctx.fillText(text, -canvas.width + textPosition + jitter, canvas.height / 2);
    ctx.shadowBlur = Math.round(text_size / 3);
    ctx.fillText(text, -canvas.width + textPosition + jitter, canvas.height / 2);
    //ctx.shadowColor = "rgba(0,255,0," + (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
    ctx.shadowBlur = 1;
    //ctx.fillStyle = "rgba(0,0,0," + .75 * (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
    ctx.fillText(text, -canvas.width + textPosition, canvas.height / 2);
    //ctx.fillText(text, canvas.width / 2, canvas.height / 2);
    ctx.lineWidth = Math.max(1, Math.round(canvas.height/400));
    ctx.strokeStyle = "rgba(0,0,0," + .25 * (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
    if(this.scanline > canvas.height * 3 / 4)
    {
      this.scanline=canvas.height/4;
    }
    ctx.putImageData(ctx.getImageData(0,Math.round(this.scanline), canvas.width, ctx.lineWidth*2), -3, Math.round(this.scanline));
    if (this.bounce > 0)
    {
    var current_bounce = Math.random()*this.bounce - this.bounce/2;
    for(var y = 0; y < canvas.width; y+=ctx.lineWidth*2)
    {
      current_bounce += Math.random()*this.bounce - this.bounce/2;
      ctx.putImageData(ctx.getImageData(0,y, canvas.width, ctx.lineWidth*2), current_bounce, y);
    }
    }
    
    for(var y = 0; y < canvas.height; y+=2*ctx.lineWidth)
    {
      ctx.beginPath();
      ctx.moveTo(0,y);
      ctx.lineTo(canvas.width,y);
      ctx.stroke();
    }
    
    /*
    for(var x = 0; x < canvas.width; x+=2*ctx.lineWidth)
    {
      ctx.beginPath();
      ctx.moveTo(x,0);
      ctx.lineTo(x,canvas.height);
      ctx.stroke();
    }
    // */
  }
};

function createContainer(x,y,width,height) {
  return {
    x: x,
    y: y,
    width: width,
    height: height,
    paint : function (gamestate, layout, canvas, context)
    {
    },
    paintLevel : function()
    {
      return 0;
    }
  };
};

function createPanel(x,y,width,height,parent) {
  return {
    x: x * parent.width + parent.x,
    y: y * parent.height + parent.y,
    width: width * parent.width,
    height: height * parent.height,
    paint : function (gamestate, layout, canvas, ctx)
    {
      var x = Math.round(canvas.height * this.x);
      var width = Math.round(canvas.height * this.width);
      var y = Math.round(canvas.height * this.y);
      var height = Math.round(canvas.height * this.height);
      ctx.lineWidth = Math.max(1,canvas.width/600)
      ctx.shadowOffsetX = canvas.width * 2;
      ctx.strokeStyle = "rgb(0, 192, 0)";
      ctx.shadowColor = "rgb(0, 192, 0)";
      ctx.lineCap = "round";
      ctx.shadowBlur = Math.round(canvas.height/40);
      ctx.strokeRect(-canvas.width * 2 + x, y, width, height);
      ctx.shadowBlur = Math.round(canvas.height/80);
      ctx.strokeRect(-canvas.width * 2 + x, y, width, height);
      ctx.shadowBlur = 1;
      ctx.strokeRect(-canvas.width * 2 + x, y, width, height);
      ctx.shadowBlur = 0;
    },
    paintLevel : function()
    {
      return 0;
    }
  };
};

function createMapSquare(x,y,width,height,parent) {
  return {
    x: x + parent.x,
    y: y + parent.y,
    width: width,
    height: height,
    highlighted : false,
    move_signal: false,
    handleMouseMove : function(x,y)
    {
      this.highlighted = (x > this.x && x < this.x + this.width &&
        y > this.y && y < this.y + this.height);
    },
    handleMouseDown : function(x,y)
    {
      this.move_signal = (x > this.x && x < this.x + this.width &&
        y > this.y && y < this.y + this.height);
    },
    handleTimeStep(gamestate)
    {
      if (this.move_signal)
      {
        this.move_signal = false;
        gamestate.player.setLocation(this);
      }
    },
    paint : function (gamestate, layout, canvas, ctx)
    {
      var box_bound_x = Math.round(this.x * canvas.height);
      var box_bound_y = Math.round(this.y * canvas.height);
      var width = Math.round(this.width * canvas.height);
      var height = Math.round(this.height * canvas.height);
      ctx.shadowOffsetX = canvas.width * 2;
      ctx.shadowColor = (this.highlighted && Math.random() < .95 ? "rgb(0, 64, 0)" : "rgb(0, 32, 0)");
      ctx.shadowBlur = Math.round(canvas.height/40);
      ctx.fillRect(-canvas.width * 2 + box_bound_x, box_bound_y, width, height);
      ctx.shadowBlur = Math.round(canvas.height/80);
      ctx.fillRect(-canvas.width * 2 + box_bound_x, box_bound_y, width, height);
      ctx.shadowBlur = 1;
      ctx.fillRect(-canvas.width * 2 + box_bound_x, box_bound_y, width, height);
      ctx.shadowBlur = 0;
    },
    paintLevel : function()
    {
      return 0;
    }
  };
};

function createPlayerIcon(location) {
  return {
    percentage: 0,
    location: location,
    handleTimeStep : function(gamestate)
    {
      this.percentage += 3;
      if (this.percentage > 100)
      {
        this.percentage-=100;
      }
    },
    setLocation : function(location)
    {
      this.location = location;
    },
    paint : function (gamestate, layout, canvas, ctx)
    {
      if(this.location === null)
      {
        return;
      }
      if(Math.random() < .01)
      {
        return;
      }
      var radius = Math.min(this.location.width/2, this.location.height/2) * canvas.height;
      
      var playerCenterX = Math.round(-canvas.width * 2 + (this.location.x + this.location.width/2) * canvas.height);
      var playerCenterY = Math.round((this.location.y + this.location.height/2) * canvas.height);
      ctx.beginPath();
      ctx.shadowOffsetX = canvas.width * 2;
      ctx.fillStyle = "rgb(0,0,0)"
      ctx.shadowColor = "rgb(0,255,0," + (1-this.percentage/100) + ")";
      ctx.shadowBlur = Math.round(canvas.height/40);
      ctx.beginPath();
      ctx.arc(playerCenterX, playerCenterY, Math.round(radius/8), 0, 2 * Math.PI);
      ctx.fill();
      ctx.shadowBlur = Math.round(canvas.height/80);
      ctx.beginPath();
      ctx.arc(playerCenterX, playerCenterY, Math.round(radius/8), 0, 2 * Math.PI);
      ctx.fill();
      ctx.shadowBlur = 1;
      ctx.beginPath();
      ctx.arc(playerCenterX, playerCenterY, Math.round(radius/8), 0, 2 * Math.PI);
      ctx.fill();
      
      var min_ring_size = (radius/8);
      var max_ring_size = (radius * 4/5);
      var ring_size = Math.round((max_ring_size - min_ring_size) * (this.percentage/100) + min_ring_size);
      ctx.shadowColor = "rgba(0,255,0," + (1-this.percentage/100) + ")";
      ctx.shadowBlur = Math.round(canvas.height/40);
      ctx.beginPath();
      ctx.arc(playerCenterX, playerCenterY, ring_size, 0, 2 * Math.PI);
      ctx.stroke();
      ctx.shadowBlur = Math.round(canvas.height/80);
      ctx.beginPath();
      ctx.arc(playerCenterX, playerCenterY, ring_size, 0, 2 * Math.PI);
      ctx.stroke();
      ctx.shadowBlur = 1;
      ctx.beginPath();
      ctx.arc(playerCenterX, playerCenterY, ring_size, 0, 2 * Math.PI);
      ctx.stroke();
    },
    paintLevel : function()
    {
      return 1;
    }
  };
};

function createScanLine() {
  return {
    y : 0,
    handleTimeStep : function(gamestate)
    {
      this.y+=.75;
      if(this.y > 100)
      {
        this.y = 0;
      }
    },
    paint : function (gamestate, layout, canvas, ctx)
    {
      ctx.lineWidth = Math.max(1, Math.round(canvas.height/400));
      ctx.strokeStyle = "rgba(0,0,0,.25)";
      ctx.putImageData(ctx.getImageData(0,Math.round(canvas.height * this.y / 100), canvas.width, ctx.lineWidth*2), -3, Math.round(canvas.height * this.y / 100));
    },
    paintLevel : function()
    {
      return 100;
    }
  };
};

function createDeGauss()
{
  return {
    bounce : 0,
    handleTimeStep : function(gamestate)
    {
      if (this.bounce > 0)
      {
        this.bounce--;
      }
      if (Math.random() < .01)
      {
        this.bounce = 5;
      }
    },
    paint : function (gamestate, layout, canvas, ctx)
    {
      if (this.bounce <= 0)
      {
        return;
      }
      ctx.lineWidth = Math.max(1, Math.round(canvas.height/400));
      var current_bounce = Math.random()*this.bounce - this.bounce/2;
      for(var y = 0; y < canvas.width; y+=ctx.lineWidth*2)
      {
        current_bounce += Math.random()*this.bounce - this.bounce/2;
        ctx.putImageData(ctx.getImageData(0,y, canvas.width, ctx.lineWidth*2), current_bounce, y);
      }
    },
    paintLevel : function()
    {
      return 101;
    }
  };
};

function createLcdLines()
{
  return {
    paint : function (gamestate, layout, canvas, ctx)
    {
      ctx.lineWidth = Math.max(1, Math.round(canvas.height/400));
      ctx.strokeStyle = "rgba(0,0,0,.25)";
      for(var y = 0; y < canvas.height; y+=2*ctx.lineWidth)
      {
        ctx.beginPath();
        ctx.moveTo(0,y);
        ctx.lineTo(canvas.width,y);
        ctx.stroke();
      }
    },
    paintLevel : function()
    {
      return 102;
    }
  };
};

function createMap(gameState,parent)
{
  var boxes = 4;
  var centerY = parent.height / 2;
  var centerX = parent.width / 2;
  var unit = 0;
  var divisions = boxes * 5 + boxes + 1;
  var dimension = 0;
  if (parent.height > parent.width)
  {
    dimension = parent.width;
  }
  else
  {
    dimension = parent.height;
  }
  var unit = dimension / divisions;
  var left = centerX - (dimension / 2) + unit;
  var top = centerY - (dimension / 2) + unit;
  for (var x = 0; x < boxes; x++)
  {
    for(var y = 0; y < boxes; y++)
    {
      var box_bound_x = 6 * unit * x + left;
      var box_bound_y = 6 * unit * y + top
      var mapSquare = createMapSquare(box_bound_x, box_bound_y, unit*5, unit*5, parent);
      gameState.gameEntities.push(mapSquare);
      if (x == 0 && y == 0)
      {
        gameState.player = createPlayerIcon(mapSquare);
        gameState.gameEntities.push(gameState.player);
      }
    }
  }
};

function createTimerLoop(timeout, event)
{
  return {
    timeout : timeout,
    event : event,
    active : function()
    {
      return this.timeout > 0;
    },
    handleTimeStep : function()
    {
      if (this.timeout > 0)
      {
        this.timeout--;
      }
      
      this.event();
    }
  };
};


function createTimer(timeout, event)
{
  return {
    timeout : timeout,
    event : event,
    active : function()
    {
      return this.timeout > 0;
    },
    handleTimeStep : function()
    {
      if (this.timeout > 0)
      {
        this.timeout--;
      }
      
      if (this.timeout === 0)
      {
        this.event()
      }
    }
  };
};

function createConditionalEvent(condition, event)
{
  return {
    condition : condition,
    event : event,
    waiting : true,
    active : function()
    {
      return this.waiting;
    },
    handleTimeStep : function()
    {
      this.waiting = !this.condition();
      
      if (!this.waiting)
      {
        this.event()
      }
    }
  };
};

function createIncomingMessage(panel, sender, message)
{
  return {
    panel : panel,
    sender : sender,
    message : message,
    need_to_parse : true,
    parsed_message : [""],
    displayed_sender : "",
    displayed_message : [""],
    position : 0,
    outro_timer : 50,
    active : function()
    {
      return this.outro_timer > 0;
    },
    handleTimeStep : function(gamestate)
    {
      if (this.need_to_parse)
      {
        return;
      }
      
      var display_line = this.displayed_message.length - 1;
      if (this.sender.length > this.displayed_sender.length)
      {
        this.displayed_sender += this.sender.charAt(this.displayed_sender.length);
      }
      else if (this.parsed_message[display_line].length > 
        this.displayed_message[display_line].length)
      {
        this.displayed_message[display_line] += 
          this.parsed_message[display_line].charAt(this.displayed_message[display_line].length);
      }
      else if (this.parsed_message[display_line].length ===
        this.displayed_message[display_line].length && 
        this.parsed_message.length > this.displayed_message.length)
      {
        this.displayed_message.push("");
      }
      else if (this.outro_timer > 0)
      {
        this.outro_timer--
      }
    },
    paint : function (gamestate, layout, canvas, ctx)
    {
      ctx.textAlign = "left";
      ctx.textBaseline = "middle";
      ctx.shadowOffsetX = canvas.width;
      ctx.shadowOffsetY = 0;
      ctx.shadowColor = "rgb(0,128,0)";
      var text_size = Math.round(canvas.height / 30);
      ctx.font = text_size + "px " + g_font;
      var indent = Math.round(canvas.height / 30 * 1.5 + this.panel.x * canvas.height);
      if (this.need_to_parse)
      {
        var bounds = this.panel.width * canvas.height - indent * 2;
        this.need_to_parse = false;
        var words = this.message.split(" ");
        var current_line = "";
        for ( word in words)
        {
          if (ctx.measureText(current_line + " " + words[word]).width < bounds)
          {
            current_line += words[word] + " ";
            this.parsed_message[this.parsed_message.length - 1] += words[word] + " ";
          }
          else
          {
            current_line = words[word];
            this.parsed_message.push(current_line);
          }
        }
      }
      
      var line_level = Math.round(canvas.height / 30 * 1.5 + this.panel.y * canvas.height);
      var text = this.displayed_sender;
      ctx.shadowBlur = Math.round(text_size * 2 / 3);
      ctx.fillText(text, -canvas.width + indent, line_level);
      ctx.shadowBlur = Math.round(text_size / 3);
      ctx.fillText(text, -canvas.width + indent, line_level);
      //ctx.shadowColor = "rgba(0,255,0," + (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
      ctx.shadowBlur = 1;
      //ctx.fillStyle = "rgba(0,0,0," + .75 * (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
      ctx.fillText(text, -canvas.width + indent, line_level);
      
      for (var i = 0; i < this.displayed_message.length; i++)
      {
        var line_level = Math.round(canvas.height / 30 * (3.5 + i) + this.panel.y * canvas.height);
        var text = this.displayed_message[i];
        ctx.shadowBlur = Math.round(text_size * 2 / 3);
        ctx.fillText(text, -canvas.width + indent, line_level);
        ctx.shadowBlur = Math.round(text_size / 3);
        ctx.fillText(text, -canvas.width + indent, line_level);
        //ctx.shadowColor = "rgba(0,255,0," + (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
        ctx.shadowBlur = 1;
        //ctx.fillStyle = "rgba(0,0,0," + .75 * (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
        ctx.fillText(text, -canvas.width + indent, line_level);
      }
    },
    paintLevel : function ()
    {
      return 1;
    }
  };
};

//------------------------------------------------------------------------
var Intro = {
  init: function (jut)
  {
    this.jut = jut;
  },
  reset: function ()
  {
    this.cursorTimer = 0;
    this.script = [];
    this.visible = [""];
    this.type_time = 0;
    this.gamestate = 
    {
      gameEntities : []
    };
    this.game_events = [];
    var intro_screen = this;
    this.game_events.push(createTimer(40, function() {
      intro_screen.addLineToScript("rift activity detected");
    }));
    this.game_events.push(createConditionalEvent(function () { return intro_screen.script.length === 0; }, 
      function () {}));
    this.game_events.push(createTimer(80, function () { intro_screen.clearVisible(); }));
    this.game_events.push(createTimer(40, function () { intro_screen.addLineToScript("starting primary systems"); }));
    this.game_events.push(createTimer(40, function () { 
      intro_screen.visible.push("");
      intro_screen.visible.push("");
      intro_screen.addLineToScript("power generators online"); }));
    this.game_events.push(createConditionalEvent(function () { return intro_screen.script.length === 0; },
      function () { 
      intro_screen.visible.push("");
      intro_screen.addLineToScript("cognitive engine online"); }));  
    this.game_events.push(createConditionalEvent(function () { return intro_screen.script.length === 0; },
      function () { 
      intro_screen.visible.push("");
      intro_screen.addLineToScript("system interface online"); }));
      this.game_events.push(createConditionalEvent(function () { return intro_screen.script.length === 0; },
      function () { 
      intro_screen.visible.push("");
      intro_screen.addLineToScript("enviromental monitoring online"); }));
        this.game_events.push(createConditionalEvent(function () { return intro_screen.script.length === 0; },
      function () { 
      intro_screen.visible.push("");
      intro_screen.addLineToScript("speech recoginition interface online"); }));
    this.game_events.push(createTimer(80, function () { 
      var mainContainer = createContainer(1/150, 1/150, g_aspect_ratio - 2/150, 1 - 2/150)
      intro_screen.gamestate.gameEntities.push(mainContainer);
      intro_screen.gamestate.bottom_panel = createPanel(0, 2/3, 1, 1/3, mainContainer);
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.bottom_panel);
      intro_screen.gamestate.degauss.bounce = 1;
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "incoming message...", "")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
    }));
    this.game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
      intro_screen.clearVisible();
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "Unknown Sender", "I'm ... stepping through the ... now... Preparing for ...")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
    }));
    this.game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
      intro_screen.addLineToScript("rift breach imminent");
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "Unknown Sender", "... about ... to cross ... barrier ...")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
    }));
    this.game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {}));
    this.game_events.push(createTimer(25, function () {
      intro_screen.clearVisible();
    }));
    this.game_events.push(createTimer(25, function () {
      intro_screen.addLineToScript("rift breached");
    }));
    this.game_events.push(createTimerLoop(15, function () {
      intro_screen.gamestate.degauss.bounce = 10;
    }));
    this.game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "Unknown Sender", "I'm through! This is Alice, I'm trying to uplink to you now.")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
    }));
    this.game_events.push(createTimer(50, function () {
      intro_screen.clearVisible();
      intro_screen.addLineToScript("remote uplink detected");
    }));
    this.game_events.push(createConditionalEvent(function () {
      return !intro_screen.gamestate.current_message.active();
    }, function () {
      intro_screen.gamestate.current_message = createIncomingMessage(intro_screen.gamestate.bottom_panel, "Alice", "I'm connected! Computer are you there?")
      intro_screen.gamestate.gameEntities.push(intro_screen.gamestate.current_message);
    }));
    
    //GAME TIME!
    this.game_events.push(createTimer(50, function () {
      intro_screen.jut.switchToScreen(GameScreen);
    }));
    
    
    this.gamestate.gameEntities.push(this.game_events[0]);
    this.gamestate.degauss = createDeGauss();
    this.gamestate.gameEntities.push(this.gamestate.degauss);
    this.gamestate.gameEntities.push(createLcdLines());
    this.gamestate.gameEntities.push(createScanLine());
  },
  clearVisible : function()
  {
    this.visible = [""];
  },
  addLineToScript : function(string)
  {
    for(var i = 0; i < string.length; i++)
    {
      this.script.push(string.charAt(i));
    }
  },
  handleTimeStep: function ()
  {
    this.cursorTimer++;
    
    if(this.game_events.length !== 0 && !this.game_events[0].active())
    {
      this.game_events.shift();
      if(this.game_events.length !== 0)
      {
        this.gamestate.gameEntities.push(this.game_events[0]);
      }
    }
    
    if(this.script.length !== 0)
    {
      if (this.type_time > 0)
      {
        this.type_time--;
      }
      
      if (this.type_time === 0)
      {
        this.type_time = 1;
        this.visible[this.visible.length - 1] += this.script.shift();
      }
    }
    
    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if(this.gamestate.gameEntities[i].handleTimeStep)
      {
        this.gamestate.gameEntities[i].handleTimeStep(this.gamestate);
      }
    }
    
    for (var i = this.gamestate.gameEntities.length - 1; i >= 0; i--)
    {
      if(this.gamestate.gameEntities[i].active)
      {
        if(!this.gamestate.gameEntities[i].active())
        {
          this.gamestate.gameEntities.splice(i,1);
        }
      }
    }
  },
  paint: function (canvas, ctx)
  {
    ctx.setTransform(1, 0, 0, 1, 0, 0);
   
    // paint the background
    ctx.fillStyle = "rgb(0, 0, 0)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.textAlign = "left";
    ctx.textBaseline = "middle";
    ctx.shadowOffsetX = canvas.width;
    ctx.shadowOffsetY = 0;
    ctx.shadowColor = "rgb(0,128,0)";
    
    var text_size = Math.round(canvas.height / 30);
    ctx.font = text_size + "px " + g_font;
    var indent = Math.round(canvas.height / 30 * 1.5);
    for(var i = 0; i < this.visible.length; i++)
    {
      var line_level = Math.round(canvas.height / 30 * (i + 1.5))
      var text = this.visible[i];
      if (Math.floor(this.cursorTimer / 10) % 2 && i === this.visible.length - 1)
      {
        text += "_";
      }
      ctx.shadowBlur = Math.round(text_size * 2 / 3);
      ctx.fillText(text, -canvas.width + indent, line_level);
      ctx.shadowBlur = Math.round(text_size / 3);
      ctx.fillText(text, -canvas.width + indent, line_level);
      //ctx.shadowColor = "rgba(0,255,0," + (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
      ctx.shadowBlur = 1;
      //ctx.fillStyle = "rgba(0,0,0," + .75 * (this.textFadeInTimer / this.textFadeInTimerLimit) + ")";
      ctx.fillText(text, -canvas.width + indent, line_level);
    }
    
    this.gamestate.gameEntities.sort(function(a,b){
      var a_lvl = 0;
      var b_lvl = 0;
      if(a.paintLevel)
      {
        a_lvl = a.paintLevel();
      }
      if(b.paintLevel)
      {
        b_lvl = b.paintLevel();
      }
      return a_lvl - b_lvl;
    });
    
    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if (this.gamestate.gameEntities[i].paint)
      {
        this.gamestate.gameEntities[i].paint(this.gamestate,this.layout,canvas,ctx);
      }
    }
  }
};

//------------------------------------------------------------------------
var GameScreen = {
  //----------------------------------------------------------------------
  init: function (jut)
  {
    this.jut = jut;
  },

  //----------------------------------------------------------------------
  // from Screen
  reset: function ()
  {
    //stores information about graphical layout
    this.layout = null;
    this.mouse_click_event = false;
    this.mouse_click_x = 0;
    this.mouse_click_y = 0;
    this.mouse_x = 0;
    this.mouse_y = 0;
    this.player_x = 0;
    this.player_y = 0;
    
    this.gamestate =
    {
      gameEntities: [],
      player: null,
    };
    var mainContainer = createContainer(1/150, 1/150, g_aspect_ratio - 2/150, 1 - 2/150)
    this.gamestate.gameEntities.push(mainContainer);
    var left_panel = createPanel(0, 0, 1/4, 2/3, mainContainer);
    this.gamestate.gameEntities.push(left_panel);
    var right_panel = createPanel(1/4, 0, 3/4, 2/3, mainContainer);
    this.gamestate.gameEntities.push(right_panel);
    var bottom_panel = createPanel(0, 2/3, 1, 1/3, mainContainer);
    this.gamestate.gameEntities.push(bottom_panel);
    createMap(this.gamestate, right_panel);
    //createMap(this.gamestate.gameEntities, left_panel);
    //createMap(this.gamestate.gameEntities, bottom_panel);
    this.gamestate.gameEntities.push(createScanLine());
    this.gamestate.gameEntities.push(createDeGauss());
    this.gamestate.gameEntities.push(createLcdLines());
  },

  handleMouseDown: function(event)
  {
    this.mouse_click_event = true;
    this.mouse_click_x = event.offsetX / event.currentTarget.height;
    this.mouse_click_y = event.offsetY / event.currentTarget.height;
    //event.currentTarget.width;
  },
  
  handleMouseMove: function(event)
  {
    this.mouse_x = event.offsetX / event.currentTarget.height;
    this.mouse_y = event.offsetY / event.currentTarget.height;
  },
  
  //----------------------------------------------------------------------
  // from Screen
  handleTimeStep: function ()
  {

    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if(this.gamestate.gameEntities[i].handleMouseMove)
      {
        this.gamestate.gameEntities[i].handleMouseMove(this.mouse_x, this.mouse_y);
      }
    }
    
    if (this.mouse_click_event)
    {
      this.mouse_click_event = false;
      for (var i = 0; i < this.gamestate.gameEntities.length; i++)
      {
        if(this.gamestate.gameEntities[i].handleMouseDown)
        {
          this.gamestate.gameEntities[i].handleMouseDown(this.mouse_click_x, this.mouse_click_y);
        }
      }
    }
  
    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if(this.gamestate.gameEntities[i].handleTimeStep)
      {
        this.gamestate.gameEntities[i].handleTimeStep(this.gamestate);
      }
    }
    
    for (var i = this.gamestate.gameEntities.length - 1; i >= 0; i--)
    {
      if(this.gamestate.gameEntities[i].active)
      {
        if(!this.gamestate.gameEntities[i].active())
        {
          this.gamestate.gameEntities.splice(i,1);
        }
      }
    }
  },
  
  //----------------------------------------------------------------------
  // from Screen
  paint: function (canvas, ctx)
  {
    ctx.setTransform(1, 0, 0, 1, 0, 0);
   
    // paint the background
    ctx.fillStyle = "rgb(0, 0, 0)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    this.gamestate.gameEntities.sort(function(a,b){
      var a_lvl = 0;
      var b_lvl = 0;
      if(a.paintLevel)
      {
        a_lvl = a.paintLevel();
      }
      if(b.paintLevel)
      {
        b_lvl = b.paintLevel();
      }
      return a_lvl - b_lvl;
    });
    
    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if (this.gamestate.gameEntities[i].paint)
      {
        this.gamestate.gameEntities[i].paint(this.gamestate,this.layout,canvas,ctx);
      }
    }
  }
};

var GlobalResources =
{
  audio_components : {},
  graphic_components : {}
};

var init = function()
{
  var jut = createJutGameEngine(document.getElementById("canvas"));
  
  /*
  GlobalResources.audio_components.m_bg = jut.loadAudio("Assets/Sound/CrunkKnight.mp3");
  GlobalResources.audio_components.m_move = jut.loadAudio("Assets/Sound/Bounce-SoundBible.com-12678623.mp3");
  GlobalResources.graphic_components.m_pieces = jut.loadImage("Assets/Graphics/Chess_pieces.png");
  GlobalResources.graphic_components.m_gold = jut.loadImage("Assets/Graphics/coin_gold.png");
  GlobalResources.graphic_components.key = jut.loadImage("Assets/Graphics/key2.png");
  GlobalResources.graphic_components.lock = jut.loadImage("Assets/Graphics/locked.png");
  */
  
  jut.setMaintainAspectRatioMode(g_aspect_ratio);
  jut.addTitleScreen(Logo);
  GameScreen.init(jut);
  Intro.init(jut);
  Logo.init(jut);
  jut.init();
  
}

// launch the game once the document is fully loaded
window.addEventListener("load", init);

</script>
</body>
</html>

