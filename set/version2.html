<!DOCTYPE html>
<html>
<head>
    <title>Set</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>
<body bgcolor="#000000">
<canvas style = 'position: absolute; left: 0px; top: 0px;' id="canvas" width="1024" height="800"></canvas>
<script src="https://cdnjs.cloudflare.com/ajax/libs/buzz/1.1.10/buzz.min.js" type="text/javascript"></script>
<script src="../gameEngine/engine.js" type="text/javascript"></script>
<script src="entities.js" type="text/javascript"></script>
    
<script>
//##########################################################################
// The game
//

var g_font = "Lucida Console";
var g_aspect_ratio = 4/3;
var PHI = 1.61803398875;
var INVERSE_PHI = 0.61803398875;

//------------------------------------------------------------------------
var GameScreen = {
  //----------------------------------------------------------------------
  init: function (jut)
  {
    this.jut = jut;
  },

  //----------------------------------------------------------------------
  // from Screen
  reset: function ()
  {
    this.mouse_click_event = false;
    this.mouse_click_x = 0;
    this.mouse_click_y = 0;
    this.mouse_x = 0;
    this.mouse_y = 0;
    this.player_x = 0;
    this.player_y = 0;
    
    this.gamestate =
    {
      jut : this.jut,
      gameEntities : [],
      shape_slots : [],
      falling_shape : { cancel : function(){} },
    };
    var gamestate = this.gamestate;
    
    gamestate.gameEntities.push(createBackground());
    var position = Util.shuffle([
      g_aspect_ratio/2 - 1/3 - 1/6 - 1/32,
      g_aspect_ratio/2 + 1/6 + 1/32,
      g_aspect_ratio/2 - 1/6
    ]);
    var shape1 = createShape(
      randomProperty(),
      randomProperty(),
      randomProperty(),
      randomProperty(),
      position[0],
      1/2 - 1/6,
      1/3);
    shape1.offset = 1;
    gamestate.gameEntities.push(shape1);
    gamestate.shape_slots.push(shape1);
    var shape2 = createDifferentShape(
      shape1,
      position[1],
      1/2 - 1/6,
      1/3);
    gamestate.gameEntities.push(shape2);
    gamestate.shape_slots.push(shape2);
    var shape3 = Util.randomItem([
      createDistinctShape(
        shape1,
        shape2,
        position[2],
        1/2 - 1/6,
        1/3),
      createEvilRandomShape(
        shape1,
        shape2,
        position[2],
        1/2 - 1/6,
        1/3),
      createCompletingShape(
        shape1,
        shape2,
        position[2],
        1/2 - 1/6,
        1/3),
    ]);
    gamestate.gameEntities.push(shape3);
    gamestate.shape_slots.push(shape3);
    var accept = createButton(GlobalResources.graphic_components.accept,"#008000", "#00ff00", 
      function() {
        reject.highlighted = false;
      },1/32, 7/8-1/32, 1/8);
    gamestate.gameEntities.push(accept);
    var reject = createButton(GlobalResources.graphic_components.reject,"#800000", "#ff0000",
      function () {
        accept.highlighted = false;
      },2/32+1/8, 7/8-1/32, 1/8);
    gamestate.gameEntities.push(reject);
    gamestate.gameEntities.push(createTimer(
      150, 
      function() {
        var isSet = detectSet(gamestate.shape_slots);
        if ((!isSet || !accept.highlighted) && 
         (isSet || !reject.highlighted))
        {
          alert("oops");
        }
        var shape = Util.shuffle(gamestate.shape_slots).shift();
        shape.offset = 1;
        shape.y -= -1;
        gamestate.falling_shape.cancel();
        //console.log("Current entities: "+gamestate.gameEntities.length);
        gamestate.falling_shape = shape;
        var new_shapes = 
          Util.shuffle([
            createDistinctShape(
              gamestate.shape_slots[0],
              gamestate.shape_slots[1],
              shape.x,
              1/2 - 1/6,
              1/3),
            createEvilRandomShape(
              gamestate.shape_slots[0],
              gamestate.shape_slots[1],
              shape.x,
              1/2 - 1/6,
              1/3),
            createCompletingShape(
              gamestate.shape_slots[0],
              gamestate.shape_slots[1],
              shape.x,
              1/2 - 1/6,
              1/3),
            createCompletingShape(
              gamestate.shape_slots[0],
              gamestate.shape_slots[1],
              shape.x,
              1/2 - 1/6,
              1/3),
          ]);
        var new_shape = new_shapes.shift();
        while (new_shape.shape === shape.shape &&
          new_shape.color === shape.color &&
          new_shape.cardinality === shape.cardinality &&
          new_shape.fill === shape.fill)
        {
          new_shape = new_shapes.shift();
        }
        new_shape.offset = 1;
        gamestate.gameEntities.push(new_shape);
        gamestate.shape_slots.push(new_shape);
        //console.log("Is this a set? " + detectSet(gamestate.shape_slots));
        accept.highlighted = false;
        reject.highlighted = false;
        this.timeout = 75;
      }
    ));
  },

  handleMouseDown: function(event)
  {
    this.mouse_click_event = true;
    this.mouse_click_x = event.offsetX / event.currentTarget.height;
    this.mouse_click_y = event.offsetY / event.currentTarget.height;
  },
  
  handleMouseMove: function(event)
  {
    this.mouse_x = event.offsetX / event.currentTarget.height;
    this.mouse_y = event.offsetY / event.currentTarget.height;
  },
  
  //----------------------------------------------------------------------
  // from Screen
  handleTimeStep: function ()
  {

    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if(this.gamestate.gameEntities[i].handleMouseMove)
      {
        this.gamestate.gameEntities[i].handleMouseMove(this.mouse_x, this.mouse_y);
      }
    }
    
    if (this.mouse_click_event)
    {
      this.mouse_click_event = false;
      for (var i = 0; i < this.gamestate.gameEntities.length; i++)
      {
        if(this.gamestate.gameEntities[i].handleMouseDown)
        {
          this.gamestate.gameEntities[i].handleMouseDown(this.mouse_click_x, this.mouse_click_y);
        }
      }
    }
  
    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if(this.gamestate.gameEntities[i].handleTimeStep)
      {
        this.gamestate.gameEntities[i].handleTimeStep(this.gamestate);
      }
    }
    
    for (var i = this.gamestate.gameEntities.length - 1; i >= 0; i--)
    {
      if(this.gamestate.gameEntities[i].active)
      {
        if(!this.gamestate.gameEntities[i].active())
        {
          this.gamestate.gameEntities.splice(i,1);
        }
      }
    }
  },
  
  //----------------------------------------------------------------------
  // from Screen
  paint: function (canvas, ctx)
  {
    this.gamestate.gameEntities.sort(function(a,b){
      var a_lvl = 0;
      var b_lvl = 0;
      if(a.paintLevel)
      {
        a_lvl = a.paintLevel();
      }
      if(b.paintLevel)
      {
        b_lvl = b.paintLevel();
      }
      return a_lvl - b_lvl;
    });
    
    for (var i = 0; i < this.gamestate.gameEntities.length; i++)
    {
      if (this.gamestate.gameEntities[i].paint)
      {
        this.gamestate.gameEntities[i].paint(this.gamestate,canvas,ctx);
      }
    }
  }
};

var GlobalResources =
{
  audio_components : {},
  graphic_components : {}
};

var init = function()
{
  var jut = createJutGameEngine(document.getElementById("canvas"));
  
  /*
  GlobalResources.audio_components.m_bg = jut.loadAudio("Assets/Sound/CrunkKnight.mp3");
  GlobalResources.audio_components.m_move = jut.loadAudio("Assets/Sound/Bounce-SoundBible.com-12678623.mp3");
  GlobalResources.graphic_components.m_pieces = jut.loadImage("Assets/Graphics/Chess_pieces.png");
  GlobalResources.graphic_components.m_gold = jut.loadImage("Assets/Graphics/coin_gold.png");
  */
  GlobalResources.graphic_components.reject = jut.loadImage("baseline_thumb_down_white_48dp.png");
  GlobalResources.graphic_components.accept = jut.loadImage("baseline_thumb_up_white_48dp.png");
  
  jut.setMaintainAspectRatioMode(g_aspect_ratio);
  jut.addTitleScreen(GameScreen);
  GameScreen.init(jut);
  jut.init();
  
}

// launch the game once the document is fully loaded
window.addEventListener("load", init);

</script>
</body>
</html>

