<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>
<body bgcolor="#000000">
<canvas style = 'position: absolute; left: 0px; top: 0px;' id="canvas" width="1024" height="800"></canvas>
<script src="https://cdnjs.cloudflare.com/ajax/libs/buzz/1.1.10/buzz.min.js" type="text/javascript"></script>
<script src="../gameEngine/engine.js" type="text/javascript"></script>

    
<script>
//##########################################################################
// The game
//

var PHI = 1.61803398875;
var INVERSE_PHI = 0.61803398875;

//--------------------------------------------------------------------------
const Util = {

    //----------------------------------------------------------------------
    forEach: function (obj, fn)
    {
        var key;
        for (key in obj)
        {
            if (obj.hasOwnProperty(key))
            {
                fn(obj[key]);
            }
        }
    },

    //----------------------------------------------------------------------
    randomItem: function (arr)
    {
        return arr[Math.floor(Math.random() * arr.length)];
    },

    //----------------------------------------------------------------------
    shuffle: function (arr)
    {
        var current_index = arr.length, temp, random_index;
        while (0 != current_index)
        {
            // Pick a remaining element.
            random_index = Math.floor(Math.random() * current_index);
            current_index -= 1;

            // And swap it with the current element.
            temp = arr[current_index];
            arr[current_index] = arr[random_index];
            arr[random_index] = temp;
        }
        return arr;
    }
};

//##########################################################################

var TimerLoop = function(initial_offset)
{
  this.ttl = initial_offset;
  this.state = -1;
  this.states = []
  this.addState = function(max_ttl, entry_function, warning_function, exit_function)
  {
    this.states.push({max_ttl: max_ttl, entry_function: entry_function, warning_function: warning_function, exit_function: exit_function});
  }
  
  this.handleTimeStep = function()
  {
    if(this.ttl > 0)
    {
      this.ttl--;
    }
    else if (this.ttl == 0)
    {
      if(this.states[this.state] && this.states[this.state].exit_function)
      {
        this.states[this.state].exit_function();
      }
      this.state++;
      if(this.states.length <= this.state)
      {
        this.state = 0;
      }
      if(this.states[this.state] && this.states[this.state].entry_function)
      {
        this.states[this.state].entry_function();
      }
      this.ttl = this.states[this.state].max_ttl;
    }
    
    if (this.ttl < 25 && this.states[this.state] && this.states[this.state].warning_function)
    {
      this.states[this.state].warning_function();
    }
  };
};

var PaintLevelEnum = 
{
  BG: 0,
  FLOOR: 1,
  LOWER: 2,
  ENTITIES: 3,
};

var Button = function(x, y, ttl, pressed_function, warning_function,
  released_function)
{
  this.x = x;
  this.y = y;
  this.reset = ttl === 0;
  this.ttl_max = ttl;
  
  this.ttl = 0;
  this.pushed = false;
  
  this.pressed_function = pressed_function;
  this.warning_function = warning_function;
  this.released_function = released_function;
  
  this.handlePlayerAttack = function(x,y)
  {
    if (x == this.x &&
      y == this.y)
    {
      this.pushed = true;
      this.ttl = this.ttl_max;
      this.pressed_function();
    }
  };
  
  this.handlePlayerCollision = function(x,y)
  {
    if (x != this.x || y != this.y)
    {
      return;
    }
    
    this.pushed = true;
    this.ttl = this.ttl_max;
  };
  
  this.handleTimeStep = function()
  {
    if (this.max_ttl === 0)
    {
      return;
    }
    if (!this.pushed)
    {
      return;
    }
    
    if (this.ttl === 0)
    {
      this.pushed = false;
      this.released_function();
    }
    
    if (this.ttl > 0)
    {
      this.ttl--;
    }
    
    if (this.ttl > 0 && this.ttl < 25)
    {
      this.warning_function();
    }
  };
  
  this.paintLevel = function()
  {
    return PaintLevelEnum.LOWER + this.y * 1000;
  }
  
  this.paint = function (gamestate, layout, canvas, ctx)
  {
    if(!this.pushed)
    {
      ctx.fillStyle = "rgb(192,128,128)";
      ctx.fillRect(
        (this.x - 5.75) * layout.tile_width + layout.center_x,
        (this.y - 5.875) * layout.tile_height + layout.center_y,
        layout.tile_width/2,
        layout.tile_height/2);
      ctx.fillStyle = "rgb(256,192,192)";
      ctx.fillRect(
        (this.x - 5.75) * layout.tile_width + layout.center_x,
        (this.y - 5.5) * layout.tile_height + layout.center_y,
        layout.tile_width/2,
        layout.tile_height/4);
    }
    else
    {
      ctx.fillStyle = "rgb(192,128,128)";
      ctx.fillRect(
        (this.x - 5.75) * layout.tile_width + layout.center_x,
        (this.y - 5.75) * layout.tile_height + layout.center_y,
        layout.tile_width/2,
        layout.tile_height/2);    
    }
  };
};

var ButtonArrayButton = function(x, y)
{
  this.x = x;
  this.y = y;
  this.pushed = false;
  
  this.paintLevel = function()
  {
    return PaintLevelEnum.LOWER + this.y * 1000;
  }
  
  this.paint = function (gamestate, layout, canvas, ctx)
  {
    if(!this.pushed)
    {
      ctx.fillStyle = "rgb(192,128,128)";
      ctx.fillRect(
        (this.x - 5.75) * layout.tile_width + layout.center_x,
        (this.y - 5.875) * layout.tile_height + layout.center_y,
        layout.tile_width/2,
        layout.tile_height/2);
      ctx.fillStyle = "rgb(256,192,192)";
      ctx.fillRect(
        (this.x - 5.75) * layout.tile_width + layout.center_x,
        (this.y - 5.5) * layout.tile_height + layout.center_y,
        layout.tile_width/2,
        layout.tile_height/4);
    }
    else
    {
      ctx.fillStyle = "rgb(192,128,128)";
      ctx.fillRect(
        (this.x - 5.75) * layout.tile_width + layout.center_x,
        (this.y - 5.75) * layout.tile_height + layout.center_y,
        layout.tile_width/2,
        layout.tile_height/2);    
    }
  };
};

var ButtonArray = function()
{
  this.buttons = [];

  this.handlePlayerCollision = function(x,y)
  {
    var collision = false;
    for (b in this.buttons)
    {
      if(this.buttons[b].x === x && this.buttons[b].y === y)
      {
        collision = true;
        this.buttons[b].pushed = true;
      }
    }
    
    if (!collision)
    {
      for (b in this.buttons)
      {
        this.buttons[b].pushed = false;
      }
    }
  };
};

var FloorTile = function(x, y, solid)
{
  this.x = x;
  this.y = y;
  this.visible = solid;
  this.solid = solid;
  
  this.handlePlayerCollision = function(x,y)
  {
  };
  
  this.paintLevel = function()
  {
    return PaintLevelEnum.FLOOR + this.y * 1000;
  }
  
  this.paint = function (gamestate, layout, canvas, ctx)
  {
    if(!this.visible)
    {
      return;
    }
    
    if (((this.x + this.y)%2) == 0)
    {
      ctx.fillStyle = "rgb(128,128,128)";
    }
    else
    {
      ctx.fillStyle = "rgb(192,192,192)";
    }
    ctx.fillRect(
      (this.x - 6) * layout.tile_width + layout.center_x,
      (this.y - 6) * layout.tile_height + layout.center_y,
      layout.tile_width,
      layout.tile_height);
    if(x != gamestate.player.x && y != gamestate.player.y && Math.abs(x - gamestate.player.x) + Math.abs(y - gamestate.player.y) == 3)
    {
      ctx.fillStyle = "rgba(0,255,0,.2)";
      ctx.fillRect(
      (this.x - 6) * layout.tile_width + layout.center_x,
      (this.y - 6) * layout.tile_height + layout.center_y,
      layout.tile_width,
      layout.tile_height);
    }
  };
};

var Player = function(x,y)
{
  this.x = x;
  this.y = y;
  this.y_offset = 0;

  this.paintLevel = function()
  {
    return PaintLevelEnum.ENTITIES + this.y * 1000;
  }
  
  this.paint = function (gamestate, layout, canvas, ctx)
  {
    ctx.drawImage(
      GlobalResources.graphic_components.m_pieces,
      436,
      15,
      100,
      250,
      (gamestate.player.x - 6) * layout.tile_width + layout.center_x,
      (gamestate.player.y - 6 + 1) * layout.tile_height + layout.center_y
        - Math.floor(2.5 * layout.tile_width) + this.y_offset,
      layout.tile_width,
      Math.floor(layout.tile_width * 2.5)
    );
  };
};

//--------------------------------------------------------------------------
var GameScreen = {
  //----------------------------------------------------------------------
  init: function ()
  {
  },

  //----------------------------------------------------------------------
  // from Screen
  reset: function ()
  {
    this.mouse_event = false;
    this.mouse_x = 0;
    this.mouse_y = 0;
    
    //stores information about graphical layout
    this.layout = null;

    this.gamestate = 
    {
      player : new Player(2,5),
    }
    this.board = [];
    this.current_room_x = 0;
    this.current_room_y = 0;
    this.gameEntities = [];
    this.loadRoom(this.current_room_x,this.current_room_y);
  },
  
  loadRoom: function(x,y)
  {
    this.gameEntities = [];
    
    if(x == 0 && y == 0)
    {
      this.loadBoard(
        [
          "-----00-----",
          "-----00-----",
          "--0---0000--",
          "--00--0000--",
          "--00--0000--",
          "--00---00000",
          "--000--00000",
          "--000--000--",
          "--000---00--",
          "--000---00--",
          "------------",
          "------------"
        ]
      );
      
      var board = this.board;
      this.gameEntities.push(
        new Button(2,2,200,
          function(){
            board[6][9].solid = true;
            board[6][9].visible = true;
          },
          function(){
            if (this.ttl % 2 == 0)
            {
              board[6][9].visible = false;
            }
            else
            {
              board[6][9].visible = true;
            }
          },
          function(){
            board[6][9].solid = false;
            board[6][9].visible = false;
          }
        )
      );
      /*
      var button_array = new ButtonArray();
      button_array.buttons.push(new ButtonArrayButton(8,8));
      button_array.buttons.push(new ButtonArrayButton(7,6));
      button_array.buttons.push(new ButtonArrayButton(8,4));
      this.gameEntities.push(button_array);
      this.gameEntities.push(button_array.buttons[0]);
      this.gameEntities.push(button_array.buttons[1]);
      this.gameEntities.push(button_array.buttons[2]);
      */
    }
    else if(x == 1 && y == 0)
    {
      this.loadBoard(
        [
          "------------",
          "------------",
          "------------",
          "------------",
          "--00--------",
          "0000--------",
          "0000--------",
          "--00--------",
          "------------",
          "------------",
          "------------",
          "------------"
        ]
      );
    }
    else if(x == 0 && y == -2)
    {
      this.loadBoard(
        [
          "------------",
          "------------",
          "--00000000--",
          "--00000000--",
          "--0--00--0--",
          "--0--00--0--",
          "--00000000--",
          "--00000000--",
          "--00000000--",
          "--00000000--",
          "-----00-----",
          "-----00-----"
        ]
      );
    }
    else if(x == 0 && y == -1)
    {
      this.loadBoard(
        [
          "-----00-----",
          "-----00-----",
          "----0--0----",
          "------------",
          "------------",
          "------------",
          "------------",
          "------------",
          "------------",
          "----0--0----",
          "-----00-----",
          "-----00-----"
        ]
      );
      
      var board = this.board;
      var timer = new TimerLoop(25);
      timer.addState(50,
        function(){
            board[5][7].solid = true;
            board[5][7].visible = true;
            board[6][7].solid = true;
            board[6][7].visible = true;
        },
        function(){
          if (timer.ttl % 2 == 0)
          {
            board[5][7].visible = false;
            board[6][7].visible = false;
          }
          else
          {
            board[5][7].visible = true;
            board[6][7].visible = true;
          }
        },
        function(){
            board[5][7].solid = false;
            board[5][7].visible = false;
            board[6][7].solid = false;
            board[6][7].visible = false;
        }
      );
      timer.addState(100,
        null,
        null,
        null
      );
      this.gameEntities.push(timer);
      
      var timer = new TimerLoop(50);
      timer.addState(50,
        function(){
            board[3][6].solid = true;
            board[3][6].visible = true;
            board[8][6].solid = true;
            board[8][6].visible = true;
        },
        function(){
          if (timer.ttl % 2 == 0)
          {
            board[3][6].visible = false;
            board[8][6].visible = false;
          }
          else
          {
            board[3][6].visible = true;
            board[8][6].visible = true;
          }
        },
        function(){
            board[3][6].solid = false;
            board[3][6].visible = false;
            board[8][6].solid = false;
            board[8][6].visible = false;
        }
      );
      timer.addState(100,
        null,
        null,
        null
      );
      this.gameEntities.push(timer);
      
      var timer = new TimerLoop(75);
      timer.addState(50,
        function(){
            board[2][4].solid = true;
            board[2][4].visible = true;
            board[9][4].solid = true;
            board[9][4].visible = true;
        },
        function(){
          if (timer.ttl % 2 == 0)
          {
            board[2][4].visible = false;
            board[9][4].visible = false;
          }
          else
          {
            board[2][4].visible = true;
            board[9][4].visible = true;
          }
        },
        function(){
            board[2][4].solid = false;
            board[2][4].visible = false;
            board[9][4].solid = false;
            board[9][4].visible = false;
        }
      );
      timer.addState(100,
        null,
        null,
        null
      );
      this.gameEntities.push(timer);
      
      var timer = new TimerLoop(100);
      timer.addState(50,
        function(){
            board[4][5].solid = true;
            board[4][5].visible = true;
            board[7][5].solid = true;
            board[7][5].visible = true;
        },
        function(){
          if (timer.ttl % 2 == 0)
          {
            board[4][5].visible = false;
            board[7][5].visible = false;
          }
          else
          {
            board[4][5].visible = true;
            board[7][5].visible = true;
          }
        },
        function(){
            board[4][5].solid = false;
            board[4][5].visible = false;
            board[7][5].solid = false;
            board[7][5].visible = false;
        }
      );
      timer.addState(100,
        null,
        null,
        null
      );
      this.gameEntities.push(timer);
      
      var timer = new TimerLoop(125);
      timer.addState(50,
        function(){
            board[5][4].solid = true;
            board[5][4].visible = true;
            board[6][4].solid = true;
            board[6][4].visible = true;
        },
        function(){
          if (timer.ttl % 2 == 0)
          {
            board[5][4].visible = false;
            board[6][4].visible = false;
          }
          else
          {
            board[5][4].visible = true;
            board[6][4].visible = true;
          }
        },
        function(){
            board[5][4].solid = false;
            board[5][4].visible = false;
            board[6][4].solid = false;
            board[6][4].visible = false;
        }
      );
      timer.addState(100,
        null,
        null,
        null
      );
      this.gameEntities.push(timer);
      
      var timer = new TimerLoop(150);
      timer.addState(50,
        function(){
            board[4][6].solid = true;
            board[4][6].visible = true;
            board[7][6].solid = true;
            board[7][6].visible = true;
        },
        function(){
          if (timer.ttl % 2 == 0)
          {
            board[4][6].visible = false;
            board[7][6].visible = false;
          }
          else
          {
            board[4][6].visible = true;
            board[7][6].visible = true;
          }
        },
        function(){
            board[4][6].solid = false;
            board[4][6].visible = false;
            board[7][6].solid = false;
            board[7][6].visible = false;
        }
      );
      timer.addState(100,
        null,
        null,
        null
      );
      this.gameEntities.push(timer);
    }
    else
    {
      this.loadBoard(
        [
          "-----00-----",
          "-----00-----",
          "--00000000--",
          "--00000000--",
          "--00000000--",
          "000000000000",
          "000000000000",
          "--00000000--",
          "--00000000--",
          "--00000000--",
          "-----00-----",
          "-----00-----"
        ]
      );
    }
    
    this.gameEntities.push(this.gamestate.player);
  },
  
  loadBoard: function(string_array)
  {
    this.board = [];
    var dim_y = string_array.length;
    var dim_x = 0;
    for(var i = 0; i < dim_y; i++)
    {
      if(i == 0)
      {
        dim_x = string_array[i].length;
      }
      else
      {
        dim_x = Math.max(dim_x, string_array[i].length);
      }
    }
    for(var x = 0; x < dim_x; x++)
    {
      var row = [];
      for(var y = 0; y < dim_y; y++)
      {
        if (x < string_array[y].length && string_array[y][x] != '-')
        {
          var tile = new FloorTile(x,y,true)
          row.push(tile);
          this.gameEntities.push(tile);
        }
        else
        {
          var tile = new FloorTile(x,y,false)
          row.push(tile);
          this.gameEntities.push(tile);
        }
      }
      this.board.push(row);
    }
  },

  handleMouseDown: function(event)
  {
    if (this.layout)
    {
      this.mouse_event = true;
      this.mouse_x = event.offsetX;
      this.mouse_y = event.offsetY;
    }
  },
  
  //----------------------------------------------------------------------
  // from Screen
  handleTimeStep: function ()
  {
    if(this.mouse_event && this.layout)
    {
      this.mouse_event = false;
      var tile_x = Math.floor((this.mouse_x - this.layout.center_x)/this.layout.tile_width) + 6;
      var tile_y = Math.floor((this.mouse_y - this.layout.center_y)/this.layout.tile_height) + 6;
      //alert(tile_x + ", " + tile_y)
      if (this.board[tile_x][tile_y].solid && 
        tile_x != this.gamestate.player.x && tile_y != this.gamestate.player.y &&
        Math.abs(tile_x - this.gamestate.player.x) + Math.abs(tile_y - this.gamestate.player.y) == 3)
      {
        this.gamestate.player.x = tile_x;
        this.gamestate.player.y = tile_y;
        
        for (var i in this.gameEntities)
        {
          if(this.gameEntities[i].handlePlayerAttack)
            {
              this.gameEntities[i].handlePlayerAttack(this.gamestate.player.x, this.gamestate.player.y);
            }
        }
                
        //did we move into an exit square?
        if(this.gamestate.player.x > 9)
        {
          this.gamestate.player.x = this.gamestate.player.x - 10;
          this.current_room_x++;
          this.loadRoom(this.current_room_x,this.current_room_y);
        }
        else if(this.gamestate.player.y > 9)
        {
          this.gamestate.player.y = this.gamestate.player.y - 10;
          this.current_room_y++;
          this.loadRoom(this.current_room_x,this.current_room_y);
        }
        else if(this.gamestate.player.x < 2)
        {
          this.gamestate.player.x = this.gamestate.player.x + 10;
          this.current_room_x--;
          this.loadRoom(this.current_room_x,this.current_room_y);
        }
        else if(this.gamestate.player.y < 2)
        {
          this.gamestate.player.y = this.gamestate.player.y + 10;
          this.current_room_y--;
          this.loadRoom(this.current_room_x,this.current_room_y);
        }
      }
    }
    
    for (var i in this.gameEntities)
    {
      if(this.gameEntities[i].handleTimeStep)
      {
        this.gameEntities[i].handleTimeStep();
      }
    }
    
    //collisions
    for (var i in this.gameEntities)
    {
      if(this.gameEntities[i].handlePlayerCollision)
      {
        this.gameEntities[i].handlePlayerCollision(this.gamestate.player.x, this.gamestate.player.y);
      }
    }
    
    if(!this.board[this.gamestate.player.x][this.gamestate.player.y].solid)
    {
      if(this.gamestate.player.y_offset === 0)
      {
        this.gamestate.player.y_offset = 20;
      }
      else
      {
        this.gamestate.player.y_offset += this.gamestate.player.y_offset;
      }
      if(this.gamestate.player.y_offset > 25 * 40)
      {
        this.reset();
      }
    }
  },
  
  //----------------------------------------------------------------------
  // from Screen
  paint: function (canvas, ctx)
  {
    ctx.setTransform(1, 0, 0, 1, 0, 0);
   
    // paint the background
    ctx.fillStyle = "rgb(0, 0, 0)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.fillStyle = "rgb(255,255,255)";
    
    if (this.layout === null)
    {
      this.layout = {};
    }
    this.layout.center_x = Math.round(canvas.width / 2);
    this.layout.center_y = Math.round(canvas.height / 2);
    this.layout.tile_width = Math.round(canvas.width/12);
    this.layout.tile_height = Math.round(canvas.width/24);

    this.gameEntities.sort(function(a,b){
      var a_lvl = 0;
      var b_lvl = 0;
      if(a.paintLevel)
      {
        a_lvl = a.paintLevel();
      }
      if(b.paintLevel)
      {
        b_lvl = b.paintLevel();
      }
      return a_lvl - b_lvl;
    });
    
    for (var i in this.gameEntities)
    {
      if (this.gameEntities[i].paint)
      {
        this.gameEntities[i].paint(this.gamestate,this.layout,canvas,ctx);
      }
    }
  }
};

var GlobalResources =
{
  audio_components : {},
  graphic_components : {}
};

var init = function()
{
  var jut = createJutGameEngine(document.getElementById("canvas"));
  GlobalResources.audio_components.m_bg = jut.loadAudio("Assets/Sound/CrunkKnight.mp3");
  GlobalResources.graphic_components.m_pieces = jut.loadImage("Assets/Graphics/Chess_pieces.png");
  GlobalResources.graphic_components.m_gold = jut.loadImage("Assets/Graphics/coin_gold.png");
  jut.setMaintainAspectRatioMode(4/3);
  jut.addTitleScreen(GameScreen);
  jut.init();
}

// launch the game once the document is fully loaded
window.addEventListener("load", init);

</script>
</body>
</html>

