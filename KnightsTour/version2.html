<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>
<body bgcolor="#000000">
<canvas style = 'position: absolute; left: 0px; top: 0px;' id="canvas" width="1024" height="800"></canvas>
<script src="https://cdnjs.cloudflare.com/ajax/libs/buzz/1.1.10/buzz.min.js" type="text/javascript"></script>
<script src="../gameEngine/engine.js" type="text/javascript"></script>

    
<script>
//##########################################################################
// The game
//

var PHI = 1.61803398875;
var INVERSE_PHI = 0.61803398875;

//--------------------------------------------------------------------------
const Util = {

    //----------------------------------------------------------------------
    forEach: function (obj, fn)
    {
        var key;
        for (key in obj)
        {
            if (obj.hasOwnProperty(key))
            {
                fn(obj[key]);
            }
        }
    },

    //----------------------------------------------------------------------
    randomItem: function (arr)
    {
        return arr[Math.floor(Math.random() * arr.length)];
    },

    //----------------------------------------------------------------------
    shuffle: function (arr)
    {
        var current_index = arr.length, temp, random_index;
        while (0 != current_index)
        {
            // Pick a remaining element.
            random_index = Math.floor(Math.random() * current_index);
            current_index -= 1;

            // And swap it with the current element.
            temp = arr[current_index];
            arr[current_index] = arr[random_index];
            arr[random_index] = temp;
        }
        return arr;
    }
};

//##########################################################################

var PaintLevelEnum = 
{
  BG: 0,
  FLOOR: 1,
  LOWER: 2,
  ENTITIES: 3,
};

const Pawn = function (x,y){
  this.x = x;
  this.y = y;
  this.m_vel = [-1,-1];
  this.m_invincible = false;
  this.m_invincible_timer = 0;
  this.m_state_timer = 0;
  this.m_pushed = false;
  this.m_attack_pos = [8,8];
  this.m_move_flip_flop = 0;
  this.m_health = 2;
  this.offset_x = 0;
  this.offset_y = 0;
  this.attack = new Attack(8,8,-1,-1);
  
  this.INVINCIBLE_TIME = 50,
  this.STUNNED_TIME = 40,
  this.ATTACK_TIME = 16;
  this.MOVE_TIME = 4;
  this.DELAY_BEFORE_MOVE = 12;
  this.ATTACK_DELAY = 8;
  
  //state machine
  this.PREMOVE = 0,
  this.MOVE = 1,
  this.ATTACK = 2,
  this.STUNNED = 3,
  this.m_state = this.PREMOVE,
  
  this.handleTimeStep = function (gamestate)
  {
    if(this.m_invincible)
    {
      this.m_invincible_timer++;
      if(this.m_invincible_timer >= this.INVINCIBLE_TIME)
      {
        this.m_invincible = false;
        this.m_invincible_timer = 0;
      }
    }
    var move_me = false;
    var delta_x = gamestate.player.x - this.x;
    var delta_y = gamestate.player.y - this.y;
    
    this.m_state_timer++;
    
    if(this.m_state != this.MOVE)
    {
      this.offset_x = 0;
      this.offset_y = 0;
    }
    
    if(this.m_state != this.ATTACK)
    {
      this.attack.m_active = false;
    }
    
    if(this.m_state == this.ATTACK && this.m_state_timer >= this.ATTACK_TIME)
    {
      this.m_state_timer = 0;
      this.m_state = this.PREMOVE;
      return;
    }
    
    if(this.m_state == this.PREMOVE && this.m_state_timer >= this.DELAY_BEFORE_MOVE)
    {
      if(Math.abs(delta_x) + Math.abs(delta_y) == 2 &&
        delta_x != 0 &&
        delta_y != 0)
      {
        this.m_state = this.ATTACK;
        this.m_state_timer = 0;
        this.m_attack_pos[0] = gamestate.player.x;
        this.m_attack_pos[1] = gamestate.player.y;
        this.attack.x = this.m_attack_pos[0];
        this.attack.y = this.m_attack_pos[1];
        this.attack.dx = delta_x;
        this.attack.dy = delta_y;
        this.attack.m_active = true;
        gamestate.gameEntities.push(this.attack);
        return;
      }
      else
      {
        this.m_state = this.MOVE;
        this.m_state_timer = 0;
        this.m_vel[0] = 1; 
        if(delta_x < 0 || (delta_x == 0 && Math.floor(Math.random()*2) == 0))
        {
          this.m_vel[0] = -1; 
        }
        this.m_vel[1] = 1; 
        if(delta_y < 0 || (delta_y == 0 && Math.floor(Math.random()*2) == 0))
        {
          this.m_vel[1] = -1; 
        }
        if(Math.abs(delta_x) + Math.abs(delta_y) < 2)
        {
          this.m_vel[0] *= -1;
          this.m_vel[1] *= -1;
        }
        if(Math.random() < .80)
        {
          this.m_move_flip_flop = (this.m_move_flip_flop + 1) % 2;
        }
        var potential_moves;
        if (this.m_move_flip_flop == 0)
        {
          //preferentially prefer vertical
          potential_moves = [[0,this.m_vel[1]],[0,-1 *this.m_vel[1]],[this.m_vel[0],0],[-1 * this.m_vel[0],0]];
        }
        else
        {
          //preferentially prefer horizontal
          potential_moves = [[this.m_vel[0],0],[-1 * this.m_vel[0],0],[0,this.m_vel[1]],[0,-1 *this.m_vel[1]]];
        }
        for(p in potential_moves)
        {
          if(gamestate.board[this.x+potential_moves[p][0]][this.y+potential_moves[p][1]].solid)
          {
            this.m_vel[0] = potential_moves[p][0];
            this.m_vel[1] = potential_moves[p][1];
            break;
          }
        }
        return;
      }
    }
    
    if(this.m_state == this.MOVE)
    {
      if(this.m_state_timer == Math.round(this.MOVE_TIME / 2))
      {
        move_me = true;
      }
      var ratio = this.m_state_timer / this.MOVE_TIME;
      if(this.m_state_timer >= Math.round(this.MOVE_TIME / 2))
      {
        ratio = ratio - 1;
      }
      this.offset_x = this.m_vel[0] * ratio;
      this.offset_y = this.m_vel[1] * ratio;
      if(this.m_state_timer >= this.MOVE_TIME)
      {
        this.m_state_timer = 0;
        this.m_state = this.PREMOVE;
      }
    }
    if(this.m_state == this.STUNNED && this.m_state_timer >= this.STUNNED_TIME)
    {
      this.m_state = this.PREMOVE;
      this.m_state_timer = 0;
    }
    if(this.m_pushed)
    {
      this.m_vel[0] = 0;
      this.m_vel[1] = 0;
      var potential_directions = Util.shuffle([[1,0],[0,1],[-1,0],[0,-1]]);
      for(p in potential_directions)
      {
        if(gamestate.board[this.x+potential_directions[p][0]][this.y+potential_directions[p][1]].solid)
        {
          this.m_vel[0] = potential_directions[p][0];
          this.m_vel[1] = potential_directions[p][1];
          break;
        }
      }
      move_me = true;
      this.m_pushed = false;
    }
    
    if(move_me)
    {
      this.x += this.m_vel[0];
      this.y += this.m_vel[1];
    }       
  };
  
  this.paintLevel = function()
  {
    return PaintLevelEnum.ENTITIES + (this.y + this.offset_y + .5) * 1000;
  };
  
  this.paint = function(gamestate, layout, canvas, ctx)
  {
  /*
    if(this.m_state == this.ATTACK)
    {
      ctx.fillStyle = "rgba(255,0,0,.5)";
      ctx.fillRect(
        (this.m_attack_pos[0] - 6) * layout.tile_width + layout.center_x,
        (this.m_attack_pos[1] - 6) * layout.tile_height + layout.center_y,
        layout.tile_width,
        layout.tile_height
      );
    }
  */
    if(this.m_invincible && this.m_invincible_timer % 2 == 0)
    {
      return;
    }
    
    ctx.drawImage(
      GlobalResources.graphic_components.m_pieces,
      536,
      15,
      100,
      250,
      Math.round((this.x + this.offset_x - 6) * layout.tile_width + layout.center_x),
      Math.round((this.y + this.offset_y - 6 + 1) * layout.tile_height + layout.center_y)
        - Math.floor(2.5 * layout.tile_width),
      layout.tile_width,
      Math.floor(2.5 * layout.tile_width)
    );
  };
  
  this.handlePlayerCollision = function(x, y, gamestate)
  {
    if(this.m_state == this.ATTACK)
    {
      if(x == this.m_attack_pos[0] && y == this.m_attack_pos[1])
      {
        delta_x = 1;
        if(this.x > x)
        {
          delta_x = -1;
        }
        delta_y = 1;
        if(this.y > y)
        {
          delta_y = -1;
        }
        gamestate.player.handleDamage(delta_x, delta_y);
      }
    }
    
    if(!this.m_invincible)
    {
      if(x == this.x && y == this.y)
      {
        gamestate.player.handleDamage(this.m_vel[0], this.m_vel[1]);
      }
    }
  };
  
  this.handlePlayerAttack = function(x,y)
  {
    if(x != this.x || y != this.y)
    {
      return;
    }
  
    if(this.m_invincible)
    {
      return;
    }
    
    this.m_state = this.STUNNED;
    this.m_state_timer = 0;
    this.m_invincible = true;
    this.m_invincible_timer = 0;
    this.m_pushed = true;
    this.m_health--;
    if(this.m_health <= 0)
    {
      this.attack.m_active = false;
    }
  }
  
  this.active = function()
  {
    return this.m_health > 0;
  }
};

var TimerLoop = function(initial_offset)
{
  this.ttl = initial_offset;
  this.state = -1;
  this.states = []
  this.addState = function(max_ttl, entry_function, warning_function, exit_function)
  {
    this.states.push({max_ttl: max_ttl, entry_function: entry_function, warning_function: warning_function, exit_function: exit_function});
  }
  
  this.handleTimeStep = function(gamestate)
  {
    if(this.ttl > 0)
    {
      this.ttl--;
    }
    else if (this.ttl == 0)
    {
      if(this.states[this.state] && this.states[this.state].exit_function)
      {
        this.states[this.state].exit_function();
      }
      this.state++;
      if(this.states.length <= this.state)
      {
        this.state = 0;
      }
      if(this.states[this.state] && this.states[this.state].entry_function)
      {
        this.states[this.state].entry_function();
      }
      this.ttl = this.states[this.state].max_ttl;
    }
    
    if (this.ttl < 25 && this.states[this.state] && this.states[this.state].warning_function)
    {
      this.states[this.state].warning_function();
    }
  };
};

var Button = function(x, y, ttl, pressed_function, warning_function,
  released_function)
{
  this.x = x;
  this.y = y;
  this.reset = ttl === 0;
  this.ttl_max = ttl;
  
  this.ttl = 0;
  this.pushed = false;
  
  this.pressed_function = pressed_function;
  this.warning_function = warning_function;
  this.released_function = released_function;
  
  this.handlePlayerAttack = function(x,y)
  {
    if (x == this.x &&
      y == this.y)
    {
      this.pushed = true;
      this.ttl = this.ttl_max;
      this.pressed_function();
    }
  };
  
  this.handlePlayerCollision = function(x, y, gamestate)
  {
    if (x != this.x || y != this.y)
    {
      return;
    }
    
    this.pushed = true;
    this.ttl = this.ttl_max;
  };
  
  this.handleTimeStep = function(gamestate)
  {
    if (this.max_ttl === 0)
    {
      return;
    }
    if (!this.pushed)
    {
      return;
    }
    
    if (this.ttl === 0)
    {
      this.pushed = false;
      this.released_function();
    }
    
    if (this.ttl > 0)
    {
      this.ttl--;
    }
    
    if (this.ttl > 0 && this.ttl < 25)
    {
      this.warning_function();
    }
  };
  
  this.paintLevel = function()
  {
    return PaintLevelEnum.LOWER + this.y * 1000;
  }
  
  this.paint = function (gamestate, layout, canvas, ctx)
  {
    if(!this.pushed)
    {
      ctx.fillStyle = "rgb(192,128,128)";
      ctx.fillRect(
        (this.x - 5.75) * layout.tile_width + layout.center_x,
        (this.y - 5.875) * layout.tile_height + layout.center_y,
        layout.tile_width/2,
        layout.tile_height/2);
      ctx.fillStyle = "rgb(256,192,192)";
      ctx.fillRect(
        (this.x - 5.75) * layout.tile_width + layout.center_x,
        (this.y - 5.5) * layout.tile_height + layout.center_y,
        layout.tile_width/2,
        layout.tile_height/4);
    }
    else
    {
      ctx.fillStyle = "rgb(192,128,128)";
      ctx.fillRect(
        (this.x - 5.75) * layout.tile_width + layout.center_x,
        (this.y - 5.75) * layout.tile_height + layout.center_y,
        layout.tile_width/2,
        layout.tile_height/2);    
    }
  };
};

var ButtonArrayButton = function(x, y)
{
  this.x = x;
  this.y = y;
  this.pushed = false;
  
  this.paintLevel = function()
  {
    return PaintLevelEnum.LOWER + this.y * 1000;
  }
  
  this.paint = function (gamestate, layout, canvas, ctx)
  {
    if(!this.pushed)
    {
      ctx.fillStyle = "rgb(192,128,128)";
      ctx.fillRect(
        (this.x - 5.75) * layout.tile_width + layout.center_x,
        (this.y - 5.875) * layout.tile_height + layout.center_y,
        layout.tile_width/2,
        layout.tile_height/2);
      ctx.fillStyle = "rgb(256,192,192)";
      ctx.fillRect(
        (this.x - 5.75) * layout.tile_width + layout.center_x,
        (this.y - 5.5) * layout.tile_height + layout.center_y,
        layout.tile_width/2,
        layout.tile_height/4);
    }
    else
    {
      ctx.fillStyle = "rgb(192,128,128)";
      ctx.fillRect(
        (this.x - 5.75) * layout.tile_width + layout.center_x,
        (this.y - 5.75) * layout.tile_height + layout.center_y,
        layout.tile_width/2,
        layout.tile_height/2);    
    }
  };
};

var ButtonArray = function()
{
  this.buttons = [];
  this.pressed = false;

  this.handlePlayerAttack = function(x,y)
  {
    if (this.pressed)
    {
      return;
    }
    var needs_reset = true;
    this.pressed = true;
    var collidided = -1;
    for (b in this.buttons)
    {
      if(this.buttons[b].x === x && this.buttons[b].y === y)
      {
        collidided = b;
        if (!this.buttons[b].pushed)
        {
          needs_reset = false;
          this.buttons[b].pushed = true;
        }
      }
      if (!this.buttons[b].pushed)
      {
        this.pressed = false;
      }
    }
    
    if (needs_reset)
    {
      for (b in this.buttons)
      {
        if (b !== collidided)
        {
          this.buttons[b].pushed = false;
        }
      }
    }
    
    if (this.pressed)
    {
      alert("Huzzah!");
    }
  };
};

var Attack = function(x, y, dx, dy)
{
  this.x = x;
  this.y = y;
  this.dx = dx;
  this.dy = dy;
  this.m_active = true;

  this.handlePlayerCollision = function (x, y, gamestate)
  {
    if(x == this.x && y == this.y)
    {
      gamestate.player.handleDamage(dx, dy);
    }
  }
  
  this.paintLevel = function()
  {
    return PaintLevelEnum.LOWER + (this.y) * 1000;
  };
  
  this.paint = function(gamestate, layout, canvas, ctx)
  {
    ctx.fillStyle = "rgba(255,0,0,.5)";
    ctx.fillRect(
      (this.x - 6) * layout.tile_width + layout.center_x,
      (this.y - 6) * layout.tile_height + layout.center_y,
      layout.tile_width,
      layout.tile_height
    );
  };
  
  this.active = function()
  {
    return this.m_active;
  };
};

var FloorTile = function(x, y, solid)
{
  this.x = x;
  this.y = y;
  this.visible = solid;
  this.solid = solid;
  
  this.paintLevel = function()
  {
    return PaintLevelEnum.FLOOR + this.y * 1000;
  }
  
  this.paint = function (gamestate, layout, canvas, ctx)
  {
    if(!this.visible)
    {
      return;
    }
    
    if (((this.x + this.y)%2) == 0)
    {
      ctx.fillStyle = "rgb(128,128,128)";
    }
    else
    {
      ctx.fillStyle = "rgb(192,192,192)";
    }
    ctx.fillRect(
      (this.x - 6) * layout.tile_width + layout.center_x,
      (this.y - 6) * layout.tile_height + layout.center_y,
      layout.tile_width,
      layout.tile_height);
    if(gamestate.player.player_health == 0)
    {
      return;
    }
    if(x != gamestate.player.x && y != gamestate.player.y && Math.abs(x - gamestate.player.x) + Math.abs(y - gamestate.player.y) == 3)
    {
      ctx.fillStyle = "rgba(0,255,0,.2)";
      ctx.fillRect(
      (this.x - 6) * layout.tile_width + layout.center_x,
      (this.y - 6) * layout.tile_height + layout.center_y,
      layout.tile_width,
      layout.tile_height);
    }
  };
};

var DeathWatch = function()
{
  this.m_active = true;
  this.children = [];
  this.addChild = function(child)
  {
    this.children.push(child);
  };
  
  this.handleTimeStep = function(gamestate)
  {
    this.m_active = false;
    for (c in this.children)
    {
      if (this.children[c].active)
      {
        if (this.children[c].active())
        {
          this.m_active = true;
        }
      }
    }
    if(!this.m_active)
    {
      alert("Huzzah!");
    }
  };
  
  this.active = function()
  {
    return this.m_active;
  };
};

var Player = function(x,y)
{
  this.x = x;
  this.y = y;
  this.y_offset = 0;
  this.player_health = 20;
  this.player_pushed = false;
  this.player_push_x = 0;
  this.player_push_y = 0;
  this.player_stun_timer = 0;
  this.PLAYER_STUN_PERIOD = 10;
  this.PLAYER_INVINCIBLE_PERIOD = 30;
  this.player_stun_timer_active = false;
  this.player_invincible_timer = 0;
  this.player_invincible_timer_active = false;
  
  this.handleTimeStep = function(gamestate)
  {
    if(this.player_stun_timer_active)
    {
      this.player_stun_timer++;
      if(this.player_stun_timer >= this.PLAYER_STUN_PERIOD)
      {
        this.player_stun_timer_active = false;
        this.player_stun_timer = 0;
      }
    }
    
    if(this.player_pushed)
    {
      if(this.x <= 2 && this.player_push_x == -1)
      {
        this.player_push_x = 1;
      }
      if(this.x >= 9 && this.player_push_x == 1)
      {
        this.player_push_x = -1;
      }
      
      if(this.y <= 2 && this.player_push_y == -1)
      {
        this.player_push_y = 1;
      }
      if(this.y >= 9 && this.player_push_y == 1)
      {
        this.player_push_y = -1;
      }
      this.player_pushed = false;
      this.x += this.player_push_x;
      this.y += this.player_push_y;
    }
    
    if(this.player_invincible_timer_active)
    {
      this.player_invincible_timer++;
      if(this.player_invincible_timer >= this.PLAYER_INVINCIBLE_PERIOD)
      {
        this.player_invincible_timer_active = false;
        this.player_invincible_timer = 0;
      }
    }
  }
  
  this.handleDamage = function(delta_x, delta_y)
  {
    if(this.player_invincible_timer_active)
    {
      return;
    }
    this.player_stun_timer = 0;
    this.player_stun_timer_active = true;
    this.player_invincible_timer = 0;
    this.player_invincible_timer_active = true;
    this.player_pushed = true;
    this.player_push_x = delta_x;
    this.player_push_y = delta_y;
    if(this.player_health > 0)
    {
      this.player_health--;
    }
  }

  this.paintLevel = function()
  {
    return PaintLevelEnum.ENTITIES + (this.y + .5) * 1000;
  }
  
  this.paint = function (gamestate, layout, canvas, ctx)
  {
    if (this.player_invincible_timer_active && this.player_invincible_timer % 2 === 0)
    {
      return;
    }
    if (this.player_health === 0)
    {
      return;
    }
    ctx.drawImage(
      GlobalResources.graphic_components.m_pieces,
      436,
      15,
      100,
      250,
      (gamestate.player.x - 6) * layout.tile_width + layout.center_x,
      (gamestate.player.y - 6 + 1) * layout.tile_height + layout.center_y
        - Math.floor(2.5 * layout.tile_width) + this.y_offset,
      layout.tile_width,
      Math.floor(layout.tile_width * 2.5)
    );
  };
};

//--------------------------------------------------------------------------
var GameScreen = {
  //----------------------------------------------------------------------
  init: function ()
  {
  },

  //----------------------------------------------------------------------
  // from Screen
  reset: function ()
  {
    this.mouse_event = false;
    this.mouse_x = 0;
    this.mouse_y = 0;
    
    //stores information about graphical layout
    this.layout = null;

    this.gamestate = 
    {
      player : new Player(2,5),
      board : [],
      gameEntities: []
    }
    this.current_room_x = 0;
    this.current_room_y = 0;
    this.loadRoom(this.current_room_x,this.current_room_y);
  },
  
  loadRoom: function(x,y)
  {
    this.gamestate.gameEntities = [];
    
    if(x == 0 && y == 0)
    {
      this.loadBoard(
        [
          "-----00-----",
          "-----00-----",
          "--0---0000--",
          "--00--0000--",
          "--00--0000--",
          "--00---00000",
          "--000--00000",
          "--000--000--",
          "--000---00--",
          "--000---00--",
          "------------",
          "------------"
        ]
      );
      
      var board = this.gamestate.board;
      this.gamestate.gameEntities.push(
        new Button(2,2,200,
          function(){
            board[6][9].solid = true;
            board[6][9].visible = true;
          },
          function(){
            if (this.ttl % 2 == 0)
            {
              board[6][9].visible = false;
            }
            else
            {
              board[6][9].visible = true;
            }
          },
          function(){
            board[6][9].solid = false;
            board[6][9].visible = false;
          }
        )
      );
    }
    else if(x == 1 && y == 0)
    {
      this.loadBoard(
        [
          "------------",
          "------------",
          "--00000000--",
          "--00000000--",
          "--00000000--",
          "0000000000--",
          "0000000000--",
          "--00000000--",
          "--00000000--",
          "--00000000--",
          "------------",
          "------------"
        ]
      );
      var button_array = new ButtonArray();
      button_array.buttons.push(new ButtonArrayButton(5,8));
      button_array.buttons.push(new ButtonArrayButton(6,8));
      button_array.buttons.push(new ButtonArrayButton(4,7));
      button_array.buttons.push(new ButtonArrayButton(7,7));
      button_array.buttons.push(new ButtonArrayButton(5,6));
      button_array.buttons.push(new ButtonArrayButton(6,6));
      button_array.buttons.push(new ButtonArrayButton(5,5));
      button_array.buttons.push(new ButtonArrayButton(6,5));
      button_array.buttons.push(new ButtonArrayButton(4,4));
      button_array.buttons.push(new ButtonArrayButton(7,4));
      button_array.buttons.push(new ButtonArrayButton(5,3));
      button_array.buttons.push(new ButtonArrayButton(6,3));
      
      this.gamestate.gameEntities.push(button_array);
      for (var b in button_array.buttons)
      {
        this.gamestate.gameEntities.push(button_array.buttons[b]);
      }
    }
    else if(x == 0 && y == -2)
    {
      this.loadBoard(
        [
          "------------",
          "------------",
          "--00000000--",
          "--00000000--",
          "--0--00--0--",
          "--0--00--0--",
          "--00000000--",
          "--00000000--",
          "--00000000--",
          "--00000000--",
          "-----00-----",
          "-----00-----"
        ]
      );
      var death_watch = new DeathWatch();
      this.gamestate.gameEntities.push(
        death_watch
      );
      death_watch.addChild(new Pawn(8,6));
      death_watch.addChild(new Pawn(3,8));
      
      this.gamestate.gameEntities.push(
        death_watch.children[0]
      );
      this.gamestate.gameEntities.push(
        death_watch.children[1]
      );
    }
    else if(x == 0 && y == -1)
    {
      this.loadBoard(
        [
          "-----00-----",
          "-----00-----",
          "----0--0----",
          "------------",
          "------------",
          "------------",
          "------------",
          "------------",
          "------------",
          "----0--0----",
          "-----00-----",
          "-----00-----"
        ]
      );
      
      var board = this.gamestate.board;
      var timer = new TimerLoop(25);
      timer.addState(50,
        function(){
            board[5][7].solid = true;
            board[5][7].visible = true;
            board[6][7].solid = true;
            board[6][7].visible = true;
        },
        function(){
          if (timer.ttl % 2 == 0)
          {
            board[5][7].visible = false;
            board[6][7].visible = false;
          }
          else
          {
            board[5][7].visible = true;
            board[6][7].visible = true;
          }
        },
        function(){
            board[5][7].solid = false;
            board[5][7].visible = false;
            board[6][7].solid = false;
            board[6][7].visible = false;
        }
      );
      timer.addState(100,
        null,
        null,
        null
      );
      this.gamestate.gameEntities.push(timer);
      
      var timer = new TimerLoop(50);
      timer.addState(50,
        function(){
            board[3][6].solid = true;
            board[3][6].visible = true;
            board[8][6].solid = true;
            board[8][6].visible = true;
        },
        function(){
          if (timer.ttl % 2 == 0)
          {
            board[3][6].visible = false;
            board[8][6].visible = false;
          }
          else
          {
            board[3][6].visible = true;
            board[8][6].visible = true;
          }
        },
        function(){
            board[3][6].solid = false;
            board[3][6].visible = false;
            board[8][6].solid = false;
            board[8][6].visible = false;
        }
      );
      timer.addState(100,
        null,
        null,
        null
      );
      this.gamestate.gameEntities.push(timer);
      
      var timer = new TimerLoop(75);
      timer.addState(50,
        function(){
            board[2][4].solid = true;
            board[2][4].visible = true;
            board[9][4].solid = true;
            board[9][4].visible = true;
        },
        function(){
          if (timer.ttl % 2 == 0)
          {
            board[2][4].visible = false;
            board[9][4].visible = false;
          }
          else
          {
            board[2][4].visible = true;
            board[9][4].visible = true;
          }
        },
        function(){
            board[2][4].solid = false;
            board[2][4].visible = false;
            board[9][4].solid = false;
            board[9][4].visible = false;
        }
      );
      timer.addState(100,
        null,
        null,
        null
      );
      this.gamestate.gameEntities.push(timer);
      
      var timer = new TimerLoop(100);
      timer.addState(50,
        function(){
            board[4][5].solid = true;
            board[4][5].visible = true;
            board[7][5].solid = true;
            board[7][5].visible = true;
        },
        function(){
          if (timer.ttl % 2 == 0)
          {
            board[4][5].visible = false;
            board[7][5].visible = false;
          }
          else
          {
            board[4][5].visible = true;
            board[7][5].visible = true;
          }
        },
        function(){
            board[4][5].solid = false;
            board[4][5].visible = false;
            board[7][5].solid = false;
            board[7][5].visible = false;
        }
      );
      timer.addState(100,
        null,
        null,
        null
      );
      this.gamestate.gameEntities.push(timer);
      
      var timer = new TimerLoop(125);
      timer.addState(50,
        function(){
            board[5][4].solid = true;
            board[5][4].visible = true;
            board[6][4].solid = true;
            board[6][4].visible = true;
        },
        function(){
          if (timer.ttl % 2 == 0)
          {
            board[5][4].visible = false;
            board[6][4].visible = false;
          }
          else
          {
            board[5][4].visible = true;
            board[6][4].visible = true;
          }
        },
        function(){
            board[5][4].solid = false;
            board[5][4].visible = false;
            board[6][4].solid = false;
            board[6][4].visible = false;
        }
      );
      timer.addState(100,
        null,
        null,
        null
      );
      this.gamestate.gameEntities.push(timer);
      
      var timer = new TimerLoop(150);
      timer.addState(50,
        function(){
            board[4][6].solid = true;
            board[4][6].visible = true;
            board[7][6].solid = true;
            board[7][6].visible = true;
        },
        function(){
          if (timer.ttl % 2 == 0)
          {
            board[4][6].visible = false;
            board[7][6].visible = false;
          }
          else
          {
            board[4][6].visible = true;
            board[7][6].visible = true;
          }
        },
        function(){
            board[4][6].solid = false;
            board[4][6].visible = false;
            board[7][6].solid = false;
            board[7][6].visible = false;
        }
      );
      timer.addState(100,
        null,
        null,
        null
      );
      this.gamestate.gameEntities.push(timer);
    }
    else
    {
      this.loadBoard(
        [
          "-----00-----",
          "-----00-----",
          "--00000000--",
          "--00000000--",
          "--00000000--",
          "000000000000",
          "000000000000",
          "--00000000--",
          "--00000000--",
          "--00000000--",
          "-----00-----",
          "-----00-----"
        ]
      );
    }
    
    this.gamestate.gameEntities.push(this.gamestate.player);
  },
  
  loadBoard: function(string_array)
  {
    this.gamestate.board = [];
    var dim_y = string_array.length;
    var dim_x = 0;
    for(var i = 0; i < dim_y; i++)
    {
      if(i == 0)
      {
        dim_x = string_array[i].length;
      }
      else
      {
        dim_x = Math.max(dim_x, string_array[i].length);
      }
    }
    for(var x = 0; x < dim_x; x++)
    {
      var row = [];
      for(var y = 0; y < dim_y; y++)
      {
        if (x < string_array[y].length && string_array[y][x] != '-')
        {
          var tile = new FloorTile(x,y,true)
          row.push(tile);
          this.gamestate.gameEntities.push(tile);
        }
        else
        {
          var tile = new FloorTile(x,y,false)
          row.push(tile);
          this.gamestate.gameEntities.push(tile);
        }
      }
      this.gamestate.board.push(row);
    }
  },

  handleMouseDown: function(event)
  {
    if (!this.layout)
    {
      return;
    }
    
    if (this.gamestate.player.player_stun_timer_active)
    {
      return;
    }
    
    this.mouse_event = true;
    this.mouse_x = event.offsetX;
    this.mouse_y = event.offsetY;
  },
  
  //----------------------------------------------------------------------
  // from Screen
  handleTimeStep: function ()
  {
    if(this.mouse_event && this.layout)
    {
      this.mouse_event = false;
      var tile_x = Math.floor((this.mouse_x - this.layout.center_x)/this.layout.tile_width) + 6;
      var tile_y = Math.floor((this.mouse_y - this.layout.center_y)/this.layout.tile_height) + 6;
      //alert(tile_x + ", " + tile_y)
      if (this.gamestate.board[tile_x][tile_y].solid && 
        tile_x != this.gamestate.player.x && tile_y != this.gamestate.player.y &&
        Math.abs(tile_x - this.gamestate.player.x) + Math.abs(tile_y - this.gamestate.player.y) == 3)
      {
        this.gamestate.player.x = tile_x;
        this.gamestate.player.y = tile_y;
        
        for (var i in this.gamestate.gameEntities)
        {
          if(this.gamestate.gameEntities[i].handlePlayerAttack)
            {
              this.gamestate.gameEntities[i].handlePlayerAttack(this.gamestate.player.x, this.gamestate.player.y);
            }
        }
                
        //did we move into an exit square?
        if(this.gamestate.player.x > 9)
        {
          this.gamestate.player.x = this.gamestate.player.x - 10;
          this.current_room_x++;
          this.loadRoom(this.current_room_x,this.current_room_y);
        }
        else if(this.gamestate.player.y > 9)
        {
          this.gamestate.player.y = this.gamestate.player.y - 10;
          this.current_room_y++;
          this.loadRoom(this.current_room_x,this.current_room_y);
        }
        else if(this.gamestate.player.x < 2)
        {
          this.gamestate.player.x = this.gamestate.player.x + 10;
          this.current_room_x--;
          this.loadRoom(this.current_room_x,this.current_room_y);
        }
        else if(this.gamestate.player.y < 2)
        {
          this.gamestate.player.y = this.gamestate.player.y + 10;
          this.current_room_y--;
          this.loadRoom(this.current_room_x,this.current_room_y);
        }
      }
    }
    
    for (var i in this.gamestate.gameEntities)
    {
      if(this.gamestate.gameEntities[i].handleTimeStep)
      {
        this.gamestate.gameEntities[i].handleTimeStep(this.gamestate);
      }
    }
    
    //collisions
    for (var i in this.gamestate.gameEntities)
    {
      if(this.gamestate.gameEntities[i].handlePlayerCollision)
      {
        this.gamestate.gameEntities[i].handlePlayerCollision(this.gamestate.player.x, this.gamestate.player.y, this.gamestate);
      }
    }
    
    if(!this.gamestate.board[this.gamestate.player.x][this.gamestate.player.y].solid)
    {
      if(this.gamestate.player.y_offset === 0)
      {
        this.gamestate.player.y_offset = 20;
      }
      else
      {
        this.gamestate.player.y_offset += this.gamestate.player.y_offset;
      }
      if(this.gamestate.player.y_offset > 25 * 40)
      {
        this.reset();
      }
    }
    
    var temp_entities = [];
    for (var i in this.gamestate.gameEntities)
    {
      if(this.gamestate.gameEntities[i].active)
      {
        if(!this.gamestate.gameEntities[i].active())
        {
          continue;
        }
      }
      temp_entities.push(this.gamestate.gameEntities[i]);
    }
    this.gamestate.gameEntities = temp_entities;
  },
  
  //----------------------------------------------------------------------
  // from Screen
  paint: function (canvas, ctx)
  {
    ctx.setTransform(1, 0, 0, 1, 0, 0);
   
    // paint the background
    ctx.fillStyle = "rgb(0, 0, 0)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.fillStyle = "rgb(255,255,255)";
    
    if (this.layout === null)
    {
      this.layout = {};
    }
    this.layout.center_x = Math.round(canvas.width / 2);
    this.layout.center_y = Math.round(canvas.height / 2);
    this.layout.tile_width = Math.round(canvas.width/12);
    this.layout.tile_height = Math.round(canvas.width/24);

    this.gamestate.gameEntities.sort(function(a,b){
      var a_lvl = 0;
      var b_lvl = 0;
      if(a.paintLevel)
      {
        a_lvl = a.paintLevel();
      }
      if(b.paintLevel)
      {
        b_lvl = b.paintLevel();
      }
      return a_lvl - b_lvl;
    });
    
    for (var i in this.gamestate.gameEntities)
    {
      if (this.gamestate.gameEntities[i].paint)
      {
        this.gamestate.gameEntities[i].paint(this.gamestate,this.layout,canvas,ctx);
      }
    }
  }
};

var GlobalResources =
{
  audio_components : {},
  graphic_components : {}
};

var init = function()
{
  var jut = createJutGameEngine(document.getElementById("canvas"));
  GlobalResources.audio_components.m_bg = jut.loadAudio("Assets/Sound/CrunkKnight.mp3");
  GlobalResources.graphic_components.m_pieces = jut.loadImage("Assets/Graphics/Chess_pieces.png");
  GlobalResources.graphic_components.m_gold = jut.loadImage("Assets/Graphics/coin_gold.png");
  jut.setMaintainAspectRatioMode(4/3);
  jut.addTitleScreen(GameScreen);
  jut.init();
}

// launch the game once the document is fully loaded
window.addEventListener("load", init);

</script>
</body>
</html>

